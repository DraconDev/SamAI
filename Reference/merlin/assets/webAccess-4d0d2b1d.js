import{B as J,Z as V,q as L,l as X,a6 as F,i as R,a7 as Z,a8 as j,Q as P,F as B,$ as tt,e as z,a9 as et,p as rt}from"./browserPolyfillWrapper-bb116cae.js";import{f as ot}from"./backend-0efbfbef.js";import{L as N,A as Q}from"./localStorage-70c0cae5.js";import{d as st,M as nt,A as ct}from"./analytics-910dabef.js";import{b as at}from"./persist-4b6dccac.js";async function W(e){return B.tabs.query({discarded:!1}).then(t=>t.forEach(o=>B.tabs.sendMessage(o.id,{...e,from:"BACKGROUND_SCRIPT"},()=>{chrome.runtime.lastError&&chrome.runtime.lastError.message!=="Could not establish connection. Receiving end does not exist."&&(o.title,chrome.runtime.lastError.message)})))}async function Ct(){await tt().finally(()=>W({action:z.SIGNIN,payload:void 0}))}async function Tt(){et(),W({action:z.SIGNOUT,payload:void 0})}async function vt(){const e=await J.commands.getAll(),t=e.find(c=>c.name==="toggle_merlin"),o=e.find(c=>c.name==="_execute_action");return t&&t.shortcut!==""?await N.set("shortcut",t.shortcut):o&&o.shortcut!==""?await N.set("shortcut",o.shortcut):await N.set("shortcut",""),(t==null?void 0:t.shortcut)==="⇧⌘,"||(t==null?void 0:t.shortcut)==="Ctrl+Shift+Comma"?(o==null?void 0:o.shortcut)||"":(t==null?void 0:t.shortcut)||(o==null?void 0:o.shortcut)||""}function _t(){try{at({dehydrateOptions:{shouldDehydrateQuery:({meta:t})=>!!(t!=null&&t.persist)},maxAge:1e3*60*60*24,persister:V,queryClient:L}),new X(L,{queryKey:["userSession"]}).subscribe(t=>{t.status!=="pending"&&(t.data?(F(t.data.accessToken??null),R.setState(Z(t.data,!1))):(F(null),R.setState({...j,isLoading:!1})))}),L.fetchQuery({...P.MerlinConfig,staleTime:0}),L.fetchQuery({...P.MerlinConstants,staleTime:0})}catch(e){console.error("Errored out in initialising reactQuery",e)}}function kt(e){return Math.floor(Math.random()*10)===0?e():!1}const Dt=async e=>{try{const t=await fetch(`${st}?measurement_id=${nt}&api_secret=${ct}`,{body:JSON.stringify(e),method:"POST"});return}catch(t){console.error("Google Analytics request failed with an exception",t)}};function it(e,t="CONTENT_SCRIPT",o){return new Promise((c,s)=>{chrome.runtime.sendMessage({action:e,from:t,payload:o},r=>{chrome.runtime.lastError?s(chrome.runtime.lastError):(r.status==="success"&&c(r.data),r.status==="error"&&s(r.error))})})}const I=360,D=10,It=e=>{const t=e&&e.getBoundingClientRect(),o={above:t.top-D,below:window.innerHeight-t.bottom-D,left:t.left-D,right:window.innerWidth-t.right-D},{above:c,below:s,left:r,right:d}=o;return c>s?I/2+D*2<r&&I/2+D*2<d?{bottom:window.innerHeight-t.top+"px",left:t.left-(I-t.width)/2+"px",position:"fixed"}:d>r?{bottom:window.innerHeight-t.top+"px",left:t.left+"px",position:"fixed"}:{bottom:window.innerHeight-t.top+"px",position:"fixed",right:window.innerWidth-t.right+"px"}:I/2+D*2<r&&I/2+D*2<d?{left:t.left+t.width/2-I/2+"px",position:"fixed",top:t.bottom+"px"}:d>r?{left:t.left+"px",position:"fixed",top:t.bottom+"px"}:{position:"fixed",right:window.innerWidth-t.right+"px",top:t.bottom+"px"}},G=e=>{if(e.nodeType===Node.COMMENT_NODE||e.tagName==="SCRIPT"||e.tagName==="STYLE"||e.tagName==="HEADER"||e.tagName==="FOOTER"||e.tagName==="NAV"||e.tagName==="ASIDE"||e.tagName==="NOSCRIPT")return"";let t="";if(e.nodeType===Node.TEXT_NODE)t=e==null?void 0:e.textContent;else for(let o=0;o<e.childNodes.length;o++)t+=`${G(e.childNodes[o])}
`;return t},K=7;function lt(e,t,o){switch(e){case"amazon":return"https://www.amazon.com/s";case"baidu":return t?"https://www.baidu.com/s":o?"https://image.baidu.com/search/acjson":"https://www.baidu.com/s";case"bing":return"https://www.bing.com/search";case"brave":return"https://search.brave.com/search";case"duckduckgo":return"https://duckduckgo.com/";case"google":return"https://www.google.com/search";case"naver":return"https://search.naver.com/search.naver";case"reddit":return"https://www.reddit.com/search";case"sogou":return"https://www.sogou.com/web";case"twitter":return"https://twitter.com/search";case"yahoo":return t?"https://news.search.yahoo.com/search":o?"https://images.search.yahoo.com/search/images":"https://search.yahoo.com/search";case"yandex":return"https://yandex.com/search/";case"youtube":return"https://www.youtube.com/results";default:return"https://www.google.com/search"}}function ut(e,t=!1,o=!1,c){const s={...c};delete s.limit,s.region&&s.region!=="wt-wt"&&(e==="google"?s.query=`location:${s.region} ${s.query}`:s.query=`${s.query}`,delete s.region),e!=="google"&&delete s.region;let r=s.query;switch(delete s.query,s.site&&(r=`site:${s.site} ${r}`),delete s.site,e){case"baidu":{if(t){s.word=r;break}s.wd=r;break}case"naver":case"sogou":{s.query=r;break}case"yahoo":{s.p=r;break}case"yandex":{s.text=r;break}case"bing":case"brave":case"duckduckgo":case"google":default:s.q=r}if(o)switch(e){case"baidu":{s.tn="resultjson_com",s.word=r;break}case"google":{s.tbm="isch",s.udm="2";break}}if(t)switch(e){case"baidu":{s.tn="news";break}case"google":{s.tbm="nws";break}}return new URLSearchParams({...s})}function ht(e,t){const o=lt(e,t.shouldSearchNews,t.shouldSearchImage),c=ut(e,t.shouldSearchNews,t.shouldSearchImage,{limit:t.limit,query:t.query,region:t.region,site:t.site});return`${o}?${c.toString()}`}function mt(e){const t=e.cloneNode(!0);return t.querySelectorAll('*[style*="display: none"]').forEach(c=>{c.parentNode.removeChild(c)}),t}function ft(e){try{const t=new DOMParser().parseFromString(e,"text/html"),o=mt(t.body),c={FORBID_TAGS:["style","noscript","script","svg","img","iframe","video"],USE_PROFILES:{html:!0}};let s=rt.sanitize(o,{...c});return gt(s)>$&&(s=s.slice(0,$)),s}catch{return e||""}}const $=1e6,gt=e=>new Blob([e]).size,yt=e=>{if(!e)return"";try{const t=/^(?:https?:\/\/)?(?:www\.)?((?:(?!www\.|\.).)+\.[-a-zA-Z0-9.]+)/gm,o=e.match(t);return(o?o[0]:"").toLowerCase()}catch{return e}},dt=e=>{try{return e?(e.search(/^http[s]?:\/\//)==-1&&(e="https://"+e),e):""}catch{return e||""}},_=(e,t=64)=>{try{const o=yt(e)||`${e==null?void 0:e.toLowerCase()}.com`;return`https://www.google.com/s2/favicons?sz=${t}&domain_url=${o}`}catch{return""}};function U(e){try{return e.trim().replaceAll(`
  `,"")||""}catch{return e||""}}function H(e){try{const t=dt(e.trim().replaceAll("...","")),o=new URL(t).host.split(".");return o.length>=3?o[1]:o[0]}catch{return e}}const Ot=async(e,t=0,o=1500)=>{if(t>K)return{html:"",status:301,success:!1,url:e};try{const c=await fetch(e,{redirect:"follow",signal:AbortSignal.timeout(o)});if(!c.ok){const r=c.type==="opaqueredirect"?301:c.status;throw{status:r,statusText:`Failed to fetch: ${r} ${c.statusText}`}}const s=await c.text();if(!s)throw{status:301,statusText:"Failed to fetch: 301"};return{html:s,status:c.status,success:!0,url:e}}catch(c){return c.status===301||c.status===429?{html:"",status:301,success:!1,url:e}:{html:`Could not fetch the page: ${c.message}. Make sure the URL is correct.`,status:404,success:!1,url:e}}};async function wt(e,t){let o=0;const c=t.map(async r=>{try{const d=await e(Q.WEB_ACCESS.GET_HTML_FROM_URL,"GET_DTATA_FROM_URLS",{successfulGet:o,url:r.url});if(d.success&&d.status===200){o++;const a=ft(d.html);return{...r,html:a}}}catch{}return null});return(await Promise.all(c)).filter(r=>r!==null)}const pt=(e,t,o=!1)=>{try{const c=new DOMParser().parseFromString(e,"text/html"),s=[];switch(t){case"baidu":{const d=c.querySelector("div#content_left");if(!d)break;d.querySelectorAll("div[class^=result]").forEach(n=>{var l,m,w,f,p;try{const i=n.querySelector("h3"),g=i?i.querySelector("a"):null;if(!g)return;let u=(l=n.querySelector("div[class*='description_']"))==null?void 0:l.textContent;u=u||((m=n.querySelector(".op_dict_content"))==null?void 0:m.textContent),u=u||((w=n.querySelector("div[class*='basis-info_']"))==null?void 0:w.textContent),u=u||((f=n.querySelector(".c-color-text"))==null?void 0:f.textContent),u=u||(i?i.nextElementSibling.nextElementSibling.textContent:null);const h=n.querySelector("a[class^='siteLink']");s.push({body:u??"",from:(h==null?void 0:h.textContent)||"",imgLink:((p=h==null?void 0:h.querySelector("img"))==null?void 0:p.getAttribute("src"))||_((g==null?void 0:g.getAttribute("href"))??"")||"",title:i?i==null?void 0:i.textContent:"",url:g?g.getAttribute("href")??"":""})}catch{}});break}case"bing":{const d=c.querySelector("ol#b_results");d&&Array.from(d.querySelectorAll("li.b_algo")).forEach(a=>{const n=a.querySelector("h2 > a"),l=a.querySelector(".b_algoSlug"),m=a.querySelector(".b_wikiRichcard .tab-content"),w=a.querySelector("a .tptt"),f=a.querySelector("img.rms_img");let p="";l?p=l.textContent:m&&(p=m.textContent.trim());let i=null;f&&(i=f.getAttribute("src"));let g="";n&&(g=n.getAttribute("href"));let u="";w&&(u=w.textContent),s.push({body:p,from:u,imgLink:i,title:n?n.textContent:"",url:g})});break}case"google":{if(o){const d=c.querySelectorAll("#search #rso > div a[data-ved]");d&&d.forEach(a=>{try{const n=a.querySelectorAll("div[role=heading]");n&&n.forEach(l=>{var m,w;try{const f=l.textContent,p=((m=l.nextElementSibling)==null?void 0:m.textContent)||"";let i="";const g=a.querySelector("g-img");let u="";if(g){const y=g.querySelector("img");y&&(u=y.getAttribute("src")||"");const S=(w=g.parentElement)==null?void 0:w.querySelector("span");S&&(i=S.textContent||"")}if(!u){const y=a.querySelector("img");y&&(u=y.getAttribute("src")||"")}const h=a.getAttribute("href")??"";u&&u.includes("////")&&(u=_(h)),s.push({body:(p.includes("ago")?f:p)||f,from:i,imgLink:u,title:f,url:h})}catch{}})}catch{}})}else{const d=c.querySelectorAll("#search #rso > div");if(d.length===1){const a=c.querySelectorAll("#rso #kp-wp-tab-overview:not([style])");a&&a.forEach(l=>{try{const m=l.querySelectorAll('div[class*="K7khPe"]');m.length>0&&m.forEach(w=>{var f,p,i,g,u;try{const h=w.querySelector("a > h3");let y="",S="",E="",A="",C="";if(y=((f=w.querySelector("div.MUxGbd"))==null?void 0:f.textContent)||"",!y){const x=w.querySelector('div[jscontroller="SC7lYd"'),q=x==null?void 0:x.querySelector("div.ieodic");if(q){const v=q.querySelector("span");v&&(y=v.textContent||"")}if(!y){const v=(p=x==null?void 0:x.firstChild)==null?void 0:p.children[1];v&&(y=v.textContent||"")}}if(!y)try{const x=w.querySelector('div[style*="-webkit-line-clamp"]');y=x?(i=x.textContent)==null?void 0:i.trim():null}catch{}const T=h&&h.closest("a");C=(T==null?void 0:T.getAttribute("href"))??"",A=h==null?void 0:h.textContent;const b=h==null?void 0:h.nextElementSibling;S=b&&(b!=null&&b.lastElementChild)?(u=(g=b==null?void 0:b.lastElementChild)==null?void 0:g.firstElementChild)==null?void 0:u.textContent:"",E=_(C),s.push({body:y,from:S,imgLink:E,title:A,url:C})}catch{}})}catch{}});const n=c.querySelectorAll("#search #rso > div a[data-ved]");n&&n.forEach(l=>{try{const m=l.querySelectorAll("div[role=heading]");m&&m.forEach(w=>{var f,p;try{const i=w.textContent,g=((f=w.nextElementSibling)==null?void 0:f.textContent)||"";let u="";const h=l.querySelector("g-img");let y="";if(h){const E=h.querySelector("img");E&&(y=E.getAttribute("src")||"");const A=(p=h.parentElement)==null?void 0:p.querySelector("span");A&&(u=A.textContent||"")}if(!y){const E=l.querySelector("img");E&&(y=E.getAttribute("src")||"")}const S=l.getAttribute("href")??"";y&&y.includes("////")&&(y=_(S)),s.push({body:(g.includes("ago")?i:g)||i,from:u,imgLink:y,title:i,url:S})}catch{}})}catch{}})}else d.forEach(n=>{var l,m,w,f,p,i,g,u,h,y,S,E,A,C,T;try{const b=n.querySelector("a > h3");if(!b)return;const x=b.closest("a");let q=((m=(l=n.querySelector("div.MUxGbd"))==null?void 0:l.textContent)==null?void 0:m.trim())||"";if(q||(q=((g=(i=(p=(f=(w=x==null?void 0:x.parentElement)==null?void 0:w.parentElement)==null?void 0:f.parentElement)==null?void 0:p.nextSibling)==null?void 0:i.textContent)==null?void 0:g.trim())||""),q||(q=((A=(E=(S=(y=(h=(u=x==null?void 0:x.parentElement)==null?void 0:u.parentElement)==null?void 0:h.parentElement)==null?void 0:y.nextSibling)==null?void 0:S.nextSibling)==null?void 0:E.textContent)==null?void 0:A.trim())||""),!q){const k=n.querySelector('div[style*="-webkit-line-clamp"]');q=((C=k==null?void 0:k.textContent)==null?void 0:C.trim())||""}let v="";const O=b.nextSibling;if(O){const k=O.children;k&&k.length&&(v=k[k.length-1].textContent||"")}const Y=x?x.getAttribute("href"):"";s.push({body:q||(b==null?void 0:b.textContent),from:v,imgLink:(T=O==null?void 0:O.querySelector("img"))==null?void 0:T.getAttribute("src"),title:b==null?void 0:b.textContent,url:Y})}catch{}}),(c.querySelectorAll('div[jscontroller="SC7lYd"')||[]).forEach(n=>{var l,m,w;try{const f=n.querySelector("a");if(!f)return;const p=(f==null?void 0:f.getAttribute("href"))??"";if(s.find(S=>S.url===p))return;const i=n.querySelector("a > h3, h3, a");if(!i)return;let g=((l=n.querySelector("img"))==null?void 0:l.getAttribute("src"))||"";if(!g){const S=n.querySelector("g-img img");S&&(g=S.getAttribute("src")||"")}g&&g.includes("////")&&(g=_(p));let u=n.querySelector(".VuuXrf");if(!u){const S=n.querySelector("cite"),E=(m=S==null?void 0:S.parentElement)==null?void 0:m.parentElement;u=E==null?void 0:E.querySelector("span")}let h=null;const y=n.querySelector("div.ieodic");if(y&&(h=y.querySelector("span")),!h){const S=(w=n==null?void 0:n.firstChild)==null?void 0:w.children[1];S&&(h=S)}h||(h=n.querySelector('div[style*="-webkit-line-clamp"]')),s.push({body:(h==null?void 0:h.textContent)||"",from:(u==null?void 0:u.textContent)||"",imgLink:g,title:(i==null?void 0:i.textContent)||"",url:p})}catch{}})}break}case"yahoo":{o?new DOMParser().parseFromString(e,"text/html").querySelector("#main ol.searchCenterMiddle").querySelectorAll("li ul li").forEach(n=>{var y,S,E;const l=n.querySelector("h4.s-title a"),m=l.querySelector("img"),w=(m==null?void 0:m.getAttribute("src"))??"",f=n.querySelector(".s-source"),p=((y=f==null?void 0:f.textContent)==null?void 0:y.trim())??"",i=((S=l==null?void 0:l.textContent)==null?void 0:S.trim())??"",g=extractRealUrl((l==null?void 0:l.getAttribute("href"))??""),u=n.querySelector("p.s-desc"),h=((E=u==null?void 0:u.textContent)==null?void 0:E.trim())??"";s.push({body:h,from:p,imgLink:w,title:i,url:g})}):c.querySelectorAll('.algo:not([class*="ad"])').forEach(a=>{const n=a.querySelector("h3.title a");if(n){let l=n.getAttribute("href")||"";if(l.includes("r.search.yahoo.com")){const{pathname:i}=new URL(l),g=i.match(/\/RU=([^/]+)/);l=g?decodeURIComponent(g[1]):l}const m=n.querySelector("span");let w=[];m&&(w=m.textContent.split(" › "));const f=a.querySelector(".compText"),p=f?f.textContent:"";s.push({body:p,from:H(l)||w&&w[0]||"",imgLink:_(l)||"",title:n.getAttribute("aria-label")||"",url:l})}});break}}const r=[];for(let d=0;d<s.length;d++)try{const a={...s[d]};a.from||(a.from=H(a.url)||""),a.from&&(a.from=a.from.replace(/\.[^.]*$/,""),a.from=U(a.from)||""),!a.imgLink&&a.url&&(a.imgLink=_(a.url)||""),a.body=U(a.body)||"",a.title=U(a.title)||"",r.push(a)}catch{}return r}catch{return[]}};async function M({engine:e,query:t,shouldSearchImage:o=!1,shouldSearchNews:c=!1,timerange:s=null}){try{const r=ht(e,{btf:s,csp:"1",ei:"UTF-8",limit:K,nojs:"1",query:t,region:"wt-wt",shouldSearchImage:o,shouldSearchNews:c,site:null});return await it(Q.WEB_ACCESS.GET_HTML_FROM_URL,"CONTENT_SCRIPT",{signal:null,timeout:4e3,url:r})}catch{}return{html:"",status:404,success:!1,url:""}}const Lt=async(e,t,o,c=!1,s)=>{var u,h,y,S,E,A,C,T;let r={response:(((h=(u=t.action.message)==null?void 0:u.metadata)==null?void 0:h.context)??"")+" "+((y=t.action.message)==null?void 0:y.content),shouldGoogle:!0,shouldSearchNews:!1,timerange:null},d=!0;(!s||!(((E=(S=t.action.message)==null?void 0:S.content)==null?void 0:E.length)+(((T=(C=(A=t.action.message)==null?void 0:A.metadata)==null?void 0:C.context)==null?void 0:T.length)??0)<=60))&&d&&(r=await ot(t)),r.shouldGoogle||(c=!0);let{html:a,success:n,url:l}=await M({engine:o,getFromBackground:e,query:(r==null?void 0:r.response)??t.action.message.content,shouldSearchNews:r==null?void 0:r.shouldSearchNews,timerange:r==null?void 0:r.timerange});if(n||(o=o==="google"?"yahoo":"google",{html:a,success:n,url:l}=await M({engine:o,getFromBackground:e,query:(r==null?void 0:r.response)??t.action.message.content,shouldSearchNews:r==null?void 0:r.shouldSearchNews,timerange:r==null?void 0:r.timerange})),n||(o="baidu",{html:a,success:n,url:l}=await M({engine:o,getFromBackground:e,query:(r==null?void 0:r.response)??t.action.message.content,shouldSearchNews:r==null?void 0:r.shouldSearchNews,timerange:r==null?void 0:r.timerange})),!n)return{data:[],decisionResponse:r};const m=new DOMParser().parseFromString(a,"text/html").querySelector("body"),w=(m==null?void 0:m.innerHTML)??"",f=pt(a,o,r==null?void 0:r.shouldSearchNews);if(c){const b=f.map(x=>({...x,html:""}));try{b.push({body:G(m)||"Search results",from:o,html:"",imgLink:_("https://www.google.com/"),title:"Search Results",url:l})}catch{}return{data:b,decisionResponse:r}}const p=await wt(e,f);p.push({body:"Search results",from:o,html:w,imgLink:_("https://www.google.com/"),title:"Search Results",url:l});const i=await L.fetchQuery(P.MerlinConfig);return((i==null?void 0:i.useNewDomClean)===void 0||(i==null?void 0:i.useNewDomClean)===null?!0:i==null?void 0:i.useNewDomClean)&&p.forEach(b=>{try{const x=new DOMParser().parseFromString(b.html,"text/html").querySelector("body");b.html="";let q;try{q=G(x)}catch{q=""}b.body=q??b.body}catch{}}),{data:p,decisionResponse:r}};async function Nt(e){const t=new AbortController,o=t.signal,c=setTimeout(()=>{t.abort()},5e3);try{const r=await fetch(e,{headers:{"Content-Type":"text/html","User-Agent":"Chrome/90.0.4430.212"},method:"GET",signal:o});if(!r.ok&&r.status!==200)return"";const d=await r.text();return clearTimeout(c),d}catch{return clearTimeout(c),""}}export{D as A,I as M,pt as a,Lt as b,It as c,_ as d,Tt as e,W as f,M as g,Ct as h,Dt as i,Nt as j,Ot as k,_t as l,vt as m,it as r,kt as s};
