(function(){const m="AIzaSyDyT5W0Jh49F30Pqqtyfdf7pDLFKLJoAnw",y="https://jnn-pa.googleapis.com",E="https://www.youtube.com",b="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko)",f="O43z0dpjhgX20SCx4KAo",w=/[-_.]/g,S={"-":"+",_:"/",".":"="};function p(t){let e;return w.test(t)?e=t.replace(w,n=>S[n]):e=t,e=atob(e),new Uint8Array([...e].map(n=>n.charCodeAt(0)))}function T(t,e=!1){const n=btoa(String.fromCharCode(...t));return e?n.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""):n}function O(){var n,r;const t=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u"&&typeof window.HTMLElement<"u"&&typeof window.navigator<"u"&&typeof window.getComputedStyle=="function"&&typeof window.requestAnimationFrame=="function"&&typeof window.matchMedia=="function",e=((r=(n=Object.getOwnPropertyDescriptor(globalThis,"window"))==null?void 0:n.get)==null?void 0:r.toString().includes("[native code]"))??!1;return t&&e}function h(){const t={"content-type":"application/json+protobuf","x-goog-api-key":m,"x-user-agent":"grpc-web-javascript/0.1"};return O()||(t["user-agent"]=b),t}function g(t,e){return`${e?E:y}/${e?"api/jnn/v1":"$rpc/google.internal.waa.v1.Waa"}/${t}`}class _{constructor(){this.promise=new Promise((e,n)=>{this.resolve=e,this.reject=n})}}class c{constructor(e){this.deferredVmFunctions=new _,this.defaultTimeout=3e3,this.userInteractionElement=e.userInteractionElement,this.vm=e.globalObj[e.globalName],this.program=e.program}static async create(e){return await new c(e).load()}async load(){if(!this.vm)throw new Error("VM_INIT");if(!this.vm.a)throw new Error("VM_INIT");const e=(n,r,o,i)=>{this.deferredVmFunctions.resolve({asyncSnapshotFunction:n,shutdownFunction:r,passEventFunction:o,checkCameraFunction:i})};try{this.syncSnapshotFunction=await this.vm.a(this.program,e,!0,this.userInteractionElement,()=>{},[[],[]])[0]}catch(n){throw new Error("VM_ERROR","Could not load program",n)}return this}async snapshot(e,n=3e3){return await Promise.race([new Promise((r,o)=>{this.deferredVmFunctions.promise.then(i=>i.asyncSnapshotFunction?i.asyncSnapshotFunction(d=>r(d),[e.contentBinding,e.signedTimestamp,e.webPoSignalOutput,e.skipPrivacyBuffer]):o(new Error("ASYNC_SNAPSHOT"))).catch(o)}),new Promise((r,o)=>setTimeout(()=>o(new Error("TIMEOUT")),n))])}}function N(t){const e=p(t);if(e.length)return new TextDecoder().decode(e.map(n=>n+97))}function P(t){let e=[];if(t.length>1&&typeof t[1]=="string"){const o=N(t[1]);if(o)try{e=JSON.parse(o)}catch(i){console.error("Failed to parse descrambled challenge data:",i);return}}else t.length&&typeof t[0]=="object"?e=t[0]:Array.isArray(t)&&(e=t);const[,,,,n,r,,]=e;return{program:n,globalName:r}}let l=!1,a=null,s=null;const u=[];async function I(){const t=await fetch(g("Create",!0),{method:"POST",headers:h(),body:JSON.stringify([f])});if(!t.ok)throw new Error(`Challenge request failed: ${t.status}`);const e=await t.json(),n=P(e);if(!n)throw new Error("Failed to parse challenge data");if(!n.program)throw new Error("No program in challenge response");return n}async function M(t){if(!window[t])return new Promise(e=>{const n=setInterval(()=>{window[t]&&(clearInterval(n),e())},250)})}async function v(){if(!l)return a||(a=(async()=>{try{const t=await I(),e=t.globalName||"trayride";await M(e);const r=await(await c.create({globalObj:window,globalName:e,program:t.program})).snapshot({webPoSignalOutput:u});await C(r),l=!0}catch(t){throw console.error("Error during initialization:",t),t}})(),a)}async function C(t){if(typeof u[0]!="function")return console.error("getMinter not found"),!1;try{const r=(await(await fetch(g("GenerateIT",!0),{method:"POST",headers:h(),body:JSON.stringify([f,t])})).json())[0];if(!r)return console.error("No integrity token found in response"),!1;const o=u[0],i=await o(p(r));return typeof i!="function"?(console.error("mintCb not a function"),!1):(s=async d=>T(await i(new TextEncoder().encode(d)),!0),window.mintTokenForVideo=s,!0)}catch(e){return console.error("Error in processSnapshot:",e),!1}}window.addEventListener("message",async t=>{var r;if(((r=t.data)==null?void 0:r.type)!=="POT_TOKEN_REQUEST")return;const{messageId:e,videoId:n}=t.data;try{if(l||await v(),!s)throw new Error("Minter not ready");const o=await s(n);window.postMessage({type:"POT_TOKEN_RESPONSE",messageId:e,status:"success",token:o},window.location.origin)}catch(o){window.postMessage({type:"POT_TOKEN_RESPONSE",messageId:e,status:"error",error:o.message},window.location.origin)}})})();
