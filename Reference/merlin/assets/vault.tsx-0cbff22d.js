import{r as S,j as a,i as ln}from"./localStorage-70c0cae5.js";import{a as cn}from"./client-4954293f.js";import{c as te,q as he,Q as Fe,P as dn,R as At,S as Tt,J as Ae,K as Dt,T as un,u as fn,a as Rt,F as bt,e as mn,G as hn}from"./browserPolyfillWrapper-bb116cae.js";import{C as pn,R as gn}from"./reactQueryProviderExtension-4a0c189d.js";import{T as xn}from"./themeContext-5e650432.js";import{S as yn}from"./merlin-logo-4543e454.js";import{I as vn,p as wn,g as Ee,f as et,e as bn,a as Sn,b as In,u as Nn,c as Cn,d as ee,h as jn,i as kn,j as ke,k as Pn}from"./vault.helpers-f918b100.js";import{d as _n}from"./debounce-c70d88e0.js";import{u as En,c as H,B as ie}from"./button-274f6d28.js";import{v as tt}from"./IconCheck-e595c264.js";import{A as Oe,a as Ue,b as Be,e as Fn,c as An,d as Tn,f as Dn,I as Rn,B as Mn}from"./accordion-25b76479.js";import{D as Ln,e as On,f as Un,g as Bn,C as zn,a as Vn,b as $n,c as Gn,d as Wn,h as Hn}from"./command-48da3cb3.js";import{f as fe}from"./analytics-910dabef.js";import{c as Kn,d as Jn,P as Mt,a as St,b as Qn,u as Xn}from"./index-6e4841df.js";import{u as Yn,b as qn,C as Zn}from"./index-e4326246.js";import{c as ct}from"./createReactComponent-640fc4e6.js";import{I as er}from"./IconArrowLeft-27560546.js";import{I as tr}from"./IconPlus-26113453.js";import{L as It}from"./loader-circle-066105ce.js";import{c as nr}from"./index-82b528a6.js";import{m as rr}from"./index-eedd1636.js";import"./persist-4b6dccac.js";const nt=new Map,Pe=e=>{const t=nt.get(e);return t?Object.fromEntries(Object.entries(t.stores).map(([r,n])=>[r,n.getState()])):{}},sr=(e,t,r)=>{if(e===void 0)return{type:"untracked",connection:t.connect(r)};const n=nt.get(r.name);if(n)return{type:"tracked",store:e,...n};const s={connection:t.connect(r),stores:{}};return nt.set(r.name,s),{type:"tracked",store:e,...s}},ar=(e,t={})=>(r,n,s)=>{const{enabled:o,anonymousActionType:i,store:c,...u}=t;let d;try{d=(o??!1)&&window.__REDUX_DEVTOOLS_EXTENSION__}catch{}if(!d)return e(r,n,s);const{connection:f,...l}=sr(c,d,u);let p=!0;s.setState=(h,m,v)=>{const w=r(h,m);if(!p)return w;const I=v===void 0?{type:i||"anonymous"}:typeof v=="string"?{type:v}:v;return c===void 0?(f==null||f.send(I,n()),w):(f==null||f.send({...I,type:`${c}/${I.type}`},{...Pe(u.name),[c]:s.getState()}),w)};const g=(...h)=>{const m=p;p=!1,r(...h),p=m},x=e(s.setState,n,s);if(l.type==="untracked"?f==null||f.init(x):(l.stores[l.store]=s,f==null||f.init(Object.fromEntries(Object.entries(l.stores).map(([h,m])=>[h,h===l.store?x:m.getState()])))),s.dispatchFromDevtools&&typeof s.dispatch=="function"){let h=!1;const m=s.dispatch;s.dispatch=(...v)=>{m(...v)}}return f.subscribe(h=>{var m;switch(h.type){case"ACTION":if(typeof h.payload!="string"){console.error("[zustand devtools middleware] Unsupported action format");return}return Je(h.payload,v=>{if(v.type==="__setState"){if(c===void 0){g(v.state);return}Object.keys(v.state).length!==1&&console.error(`
                    [zustand devtools middleware] Unsupported __setState action format. 
                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),
                    and value of this only key should be a state object. Example: { "type": "__setState", "state": { "abc123Store": { "foo": "bar" } } }
                    `);const w=v.state[c];if(w==null)return;JSON.stringify(s.getState())!==JSON.stringify(w)&&g(w);return}s.dispatchFromDevtools&&typeof s.dispatch=="function"&&s.dispatch(v)});case"DISPATCH":switch(h.payload.type){case"RESET":return g(x),c===void 0?f==null?void 0:f.init(s.getState()):f==null?void 0:f.init(Pe(u.name));case"COMMIT":if(c===void 0){f==null||f.init(s.getState());return}return f==null?void 0:f.init(Pe(u.name));case"ROLLBACK":return Je(h.state,v=>{if(c===void 0){g(v),f==null||f.init(s.getState());return}g(v[c]),f==null||f.init(Pe(u.name))});case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return Je(h.state,v=>{if(c===void 0){g(v);return}JSON.stringify(s.getState())!==JSON.stringify(v[c])&&g(v[c])});case"IMPORT_STATE":{const{nextLiftedState:v}=h.payload,w=(m=v.computedStates.slice(-1)[0])==null?void 0:m.state;if(!w)return;g(c===void 0?w:w[c]),f==null||f.send(null,v);return}case"PAUSE_RECORDING":return p=!p}return}}),x},or=ar,Je=(e,t)=>{let r;try{r=JSON.parse(e)}catch(n){console.error("[zustand devtools middleware] Could not parse the received json",n)}r!==void 0&&t(r)};function ir(e,t){let r;try{r=e()}catch{return}return{getItem:s=>{var o;const i=u=>u===null?null:JSON.parse(u,t==null?void 0:t.reviver),c=(o=r.getItem(s))!=null?o:null;return c instanceof Promise?c.then(i):i(c)},setItem:(s,o)=>r.setItem(s,JSON.stringify(o,t==null?void 0:t.replacer)),removeItem:s=>r.removeItem(s)}}const we=e=>t=>{try{const r=e(t);return r instanceof Promise?r:{then(n){return we(n)(r)},catch(n){return this}}}catch(r){return{then(n){return this},catch(n){return we(n)(r)}}}},lr=(e,t)=>(r,n,s)=>{let o={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:m=>m,version:0,merge:(m,v)=>({...v,...m}),...t},i=!1;const c=new Set,u=new Set;let d;try{d=o.getStorage()}catch{}if(!d)return e((...m)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),r(...m)},n,s);const f=we(o.serialize),l=()=>{const m=o.partialize({...n()});let v;const w=f({state:m,version:o.version}).then(I=>d.setItem(o.name,I)).catch(I=>{v=I});if(v)throw v;return w},p=s.setState;s.setState=(m,v)=>{p(m,v),l()};const g=e((...m)=>{r(...m),l()},n,s);let x;const h=()=>{var m;if(!d)return;i=!1,c.forEach(w=>w(n()));const v=((m=o.onRehydrateStorage)==null?void 0:m.call(o,n()))||void 0;return we(d.getItem.bind(d))(o.name).then(w=>{if(w)return o.deserialize(w)}).then(w=>{if(w)if(typeof w.version=="number"&&w.version!==o.version){if(o.migrate)return o.migrate(w.state,w.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return w.state}).then(w=>{var I;return x=o.merge(w,(I=n())!=null?I:g),r(x,!0),l()}).then(()=>{v==null||v(x,void 0),i=!0,u.forEach(w=>w(x))}).catch(w=>{v==null||v(void 0,w)})};return s.persist={setOptions:m=>{o={...o,...m},m.getStorage&&(d=m.getStorage())},clearStorage:()=>{d==null||d.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>h(),hasHydrated:()=>i,onHydrate:m=>(c.add(m),()=>{c.delete(m)}),onFinishHydration:m=>(u.add(m),()=>{u.delete(m)})},h(),x||g},cr=(e,t)=>(r,n,s)=>{let o={storage:ir(()=>localStorage),partialize:h=>h,version:0,merge:(h,m)=>({...m,...h}),...t},i=!1;const c=new Set,u=new Set;let d=o.storage;if(!d)return e((...h)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),r(...h)},n,s);const f=()=>{const h=o.partialize({...n()});return d.setItem(o.name,{state:h,version:o.version})},l=s.setState;s.setState=(h,m)=>{l(h,m),f()};const p=e((...h)=>{r(...h),f()},n,s);s.getInitialState=()=>p;let g;const x=()=>{var h,m;if(!d)return;i=!1,c.forEach(w=>{var I;return w((I=n())!=null?I:p)});const v=((m=o.onRehydrateStorage)==null?void 0:m.call(o,(h=n())!=null?h:p))||void 0;return we(d.getItem.bind(d))(o.name).then(w=>{if(w)if(typeof w.version=="number"&&w.version!==o.version){if(o.migrate)return o.migrate(w.state,w.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return w.state}).then(w=>{var I;return g=o.merge(w,(I=n())!=null?I:p),r(g,!0),f()}).then(()=>{v==null||v(g,void 0),g=n(),i=!0,u.forEach(w=>w(g))}).catch(w=>{v==null||v(void 0,w)})};return s.persist={setOptions:h=>{o={...o,...h},h.storage&&(d=h.storage)},clearStorage:()=>{d==null||d.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>x(),hasHydrated:()=>i,onHydrate:h=>(c.add(h),()=>{c.delete(h)}),onFinishHydration:h=>(u.add(h),()=>{u.delete(h)})},o.skipHydration||x(),g||p},dr=(e,t)=>"getStorage"in t||"serialize"in t||"deserialize"in t?lr(e,t):cr(e,t),ur=dr;var Nt=ct("folder","IconFolder",[["path",{d:"M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2",key:"svg-0"}]]),me=ct("loader-2","IconLoader2",[["path",{d:"M12 3a9 9 0 1 0 9 9",key:"svg-0"}]]),fr=ct("markdown","IconMarkdown",[["path",{d:"M3 5m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z",key:"svg-0"}],["path",{d:"M7 15v-6l2 2l2 -2v6",key:"svg-1"}],["path",{d:"M14 13l2 2l2 -2m-2 2v-6",key:"svg-2"}]]);function mr(){return S.useEffect(()=>{const e=[],t=document.createElement("div");t.style.display="none",document.body.appendChild(t);const r=t.attachShadow({mode:"open"}),n=document.createElement("style");n.textContent=vn,r.appendChild(n);function s(){document.querySelectorAll("img:not([data-merlin-processed])").forEach(i=>{i instanceof HTMLImageElement&&i.complete&&wn(i,e)})}s();const o=new MutationObserver(_n(i=>{i.forEach(c=>{c.removedNodes.length&&c.removedNodes.forEach(u=>{var d;if(u instanceof HTMLImageElement){const f=e.findIndex(l=>u.hasAttribute("data-merlin-processed"));f!==-1&&((d=e[f])==null||d.call(e),e.splice(f,1))}})}),s()},300));return o.observe(document.body,{childList:!0,subtree:!0}),()=>{t.remove(),o.disconnect(),e.forEach(i=>i())}},[]),null}var Lt=Symbol.for("immer-nothing"),Ct=Symbol.for("immer-draftable"),U=Symbol.for("immer-state");function J(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var pe=Object.getPrototypeOf;function ge(e){return!!e&&!!e[U]}function ce(e){var t;return e?Ot(e)||Array.isArray(e)||!!e[Ct]||!!((t=e.constructor)!=null&&t[Ct])||Ve(e)||$e(e):!1}var hr=Object.prototype.constructor.toString();function Ot(e){if(!e||typeof e!="object")return!1;const t=pe(e);if(t===null)return!0;const r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return r===Object?!0:typeof r=="function"&&Function.toString.call(r)===hr}function Te(e,t){ze(e)===0?Reflect.ownKeys(e).forEach(r=>{t(r,e[r],e)}):e.forEach((r,n)=>t(n,r,e))}function ze(e){const t=e[U];return t?t.type_:Array.isArray(e)?1:Ve(e)?2:$e(e)?3:0}function rt(e,t){return ze(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Ut(e,t,r){const n=ze(e);n===2?e.set(t,r):n===3?e.add(r):e[t]=r}function pr(e,t){return e===t?e!==0||1/e===1/t:e!==e&&t!==t}function Ve(e){return e instanceof Map}function $e(e){return e instanceof Set}function oe(e){return e.copy_||e.base_}function st(e,t){if(Ve(e))return new Map(e);if($e(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const r=Ot(e);if(t===!0||t==="class_only"&&!r){const n=Object.getOwnPropertyDescriptors(e);delete n[U];let s=Reflect.ownKeys(n);for(let o=0;o<s.length;o++){const i=s[o],c=n[i];c.writable===!1&&(c.writable=!0,c.configurable=!0),(c.get||c.set)&&(n[i]={configurable:!0,writable:!0,enumerable:c.enumerable,value:e[i]})}return Object.create(pe(e),n)}else{const n=pe(e);if(n!==null&&r)return{...e};const s=Object.create(n);return Object.assign(s,e)}}function dt(e,t=!1){return Ge(e)||ge(e)||!ce(e)||(ze(e)>1&&(e.set=e.add=e.clear=e.delete=gr),Object.freeze(e),t&&Object.entries(e).forEach(([r,n])=>dt(n,!0))),e}function gr(){J(2)}function Ge(e){return Object.isFrozen(e)}var xr={};function de(e){const t=xr[e];return t||J(0,e),t}var be;function Bt(){return be}function yr(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function jt(e,t){t&&(de("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function at(e){ot(e),e.drafts_.forEach(vr),e.drafts_=null}function ot(e){e===be&&(be=e.parent_)}function kt(e){return be=yr(be,e)}function vr(e){const t=e[U];t.type_===0||t.type_===1?t.revoke_():t.revoked_=!0}function Pt(e,t){t.unfinalizedDrafts_=t.drafts_.length;const r=t.drafts_[0];return e!==void 0&&e!==r?(r[U].modified_&&(at(t),J(4)),ce(e)&&(e=De(t,e),t.parent_||Re(t,e)),t.patches_&&de("Patches").generateReplacementPatches_(r[U].base_,e,t.patches_,t.inversePatches_)):e=De(t,r,[]),at(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==Lt?e:void 0}function De(e,t,r){if(Ge(t))return t;const n=t[U];if(!n)return Te(t,(s,o)=>_t(e,n,t,s,o,r)),t;if(n.scope_!==e)return t;if(!n.modified_)return Re(e,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const s=n.copy_;let o=s,i=!1;n.type_===3&&(o=new Set(s),s.clear(),i=!0),Te(o,(c,u)=>_t(e,n,s,c,u,r,i)),Re(e,s,!1),r&&e.patches_&&de("Patches").generatePatches_(n,r,e.patches_,e.inversePatches_)}return n.copy_}function _t(e,t,r,n,s,o,i){if(ge(s)){const c=o&&t&&t.type_!==3&&!rt(t.assigned_,n)?o.concat(n):void 0,u=De(e,s,c);if(Ut(r,n,u),ge(u))e.canAutoFreeze_=!1;else return}else i&&r.add(s);if(ce(s)&&!Ge(s)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;De(e,s),(!t||!t.scope_.parent_)&&typeof n!="symbol"&&Object.prototype.propertyIsEnumerable.call(r,n)&&Re(e,s)}}function Re(e,t,r=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&dt(t,r)}function wr(e,t){const r=Array.isArray(e),n={type_:r?1:0,scope_:t?t.scope_:Bt(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let s=n,o=ut;r&&(s=[n],o=Se);const{revoke:i,proxy:c}=Proxy.revocable(s,o);return n.draft_=c,n.revoke_=i,c}var ut={get(e,t){if(t===U)return e;const r=oe(e);if(!rt(r,t))return br(e,r,t);const n=r[t];return e.finalized_||!ce(n)?n:n===Qe(e.base_,t)?(Xe(e),e.copy_[t]=lt(n,e)):n},has(e,t){return t in oe(e)},ownKeys(e){return Reflect.ownKeys(oe(e))},set(e,t,r){const n=zt(oe(e),t);if(n!=null&&n.set)return n.set.call(e.draft_,r),!0;if(!e.modified_){const s=Qe(oe(e),t),o=s==null?void 0:s[U];if(o&&o.base_===r)return e.copy_[t]=r,e.assigned_[t]=!1,!0;if(pr(r,s)&&(r!==void 0||rt(e.base_,t)))return!0;Xe(e),it(e)}return e.copy_[t]===r&&(r!==void 0||t in e.copy_)||Number.isNaN(r)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=r,e.assigned_[t]=!0),!0},deleteProperty(e,t){return Qe(e.base_,t)!==void 0||t in e.base_?(e.assigned_[t]=!1,Xe(e),it(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor(e,t){const r=oe(e),n=Reflect.getOwnPropertyDescriptor(r,t);return n&&{writable:!0,configurable:e.type_!==1||t!=="length",enumerable:n.enumerable,value:r[t]}},defineProperty(){J(11)},getPrototypeOf(e){return pe(e.base_)},setPrototypeOf(){J(12)}},Se={};Te(ut,(e,t)=>{Se[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}});Se.deleteProperty=function(e,t){return Se.set.call(this,e,t,void 0)};Se.set=function(e,t,r){return ut.set.call(this,e[0],t,r,e[0])};function Qe(e,t){const r=e[U];return(r?oe(r):e)[t]}function br(e,t,r){var s;const n=zt(t,r);return n?"value"in n?n.value:(s=n.get)==null?void 0:s.call(e.draft_):void 0}function zt(e,t){if(!(t in e))return;let r=pe(e);for(;r;){const n=Object.getOwnPropertyDescriptor(r,t);if(n)return n;r=pe(r)}}function it(e){e.modified_||(e.modified_=!0,e.parent_&&it(e.parent_))}function Xe(e){e.copy_||(e.copy_=st(e.base_,e.scope_.immer_.useStrictShallowCopy_))}var Sr=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(t,r,n)=>{if(typeof t=="function"&&typeof r!="function"){const o=r;r=t;const i=this;return function(u=o,...d){return i.produce(u,f=>r.call(this,f,...d))}}typeof r!="function"&&J(6),n!==void 0&&typeof n!="function"&&J(7);let s;if(ce(t)){const o=kt(this),i=lt(t,void 0);let c=!0;try{s=r(i),c=!1}finally{c?at(o):ot(o)}return jt(o,n),Pt(s,o)}else if(!t||typeof t!="object"){if(s=r(t),s===void 0&&(s=t),s===Lt&&(s=void 0),this.autoFreeze_&&dt(s,!0),n){const o=[],i=[];de("Patches").generateReplacementPatches_(t,s,o,i),n(o,i)}return s}else J(1,t)},this.produceWithPatches=(t,r)=>{if(typeof t=="function")return(i,...c)=>this.produceWithPatches(i,u=>t(u,...c));let n,s;return[this.produce(t,r,(i,c)=>{n=i,s=c}),n,s]},typeof(e==null?void 0:e.autoFreeze)=="boolean"&&this.setAutoFreeze(e.autoFreeze),typeof(e==null?void 0:e.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){ce(e)||J(8),ge(e)&&(e=Ir(e));const t=kt(this),r=lt(e,void 0);return r[U].isManual_=!0,ot(t),r}finishDraft(e,t){const r=e&&e[U];(!r||!r.isManual_)&&J(9);const{scope_:n}=r;return jt(n,t),Pt(void 0,n)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let r;for(r=t.length-1;r>=0;r--){const s=t[r];if(s.path.length===0&&s.op==="replace"){e=s.value;break}}r>-1&&(t=t.slice(r+1));const n=de("Patches").applyPatches_;return ge(e)?n(e,t):this.produce(e,s=>n(s,t))}};function lt(e,t){const r=Ve(e)?de("MapSet").proxyMap_(e,t):$e(e)?de("MapSet").proxySet_(e,t):wr(e,t);return(t?t.scope_:Bt()).drafts_.push(r),r}function Ir(e){return ge(e)||J(10,e),Vt(e)}function Vt(e){if(!ce(e)||Ge(e))return e;const t=e[U];let r;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,r=st(e,t.scope_.immer_.useStrictShallowCopy_)}else r=st(e,!0);return Te(r,(n,s)=>{Ut(r,n,Vt(s))}),t&&(t.finalized_=!1),r}var B=new Sr,A=B.produce;B.produceWithPatches.bind(B);B.setAutoFreeze.bind(B);B.setUseStrictShallowCopy.bind(B);B.applyPatches.bind(B);B.createDraft.bind(B);B.finishDraft.bind(B);const Et={isVisible:!1},Nr=te(e=>({...Et,closeDialog:()=>e({isVisible:!1}),openDialog:()=>e({isVisible:!0}),resetStore:()=>e(Et)})),Ye=te()(ur(e=>({botData:{icon:`https://robohash.org/${tt()}?bgset=bg1&size=200x200`,name:"",personality:"",prompt:"",welcomeMessage:""},createBotAttachment:[],createBotAttachmentSize:0,createdBot:null,currentStep:1,currentUpdatedBot:null,botBuilderVariant:null,chatbotDeployedDialog:!1,canUpdateChatbotKnowledgeBase:!1,reset:()=>e({botData:{icon:`https://robohash.org/${tt()}?bgset=bg1&size=200x200`,name:"",personality:"",prompt:"",welcomeMessage:""},createBotAttachment:[],createBotAttachmentSize:0,currentStep:1}),selectedBot:null,setBotData:t=>e(r=>({botData:{...r.botData,...t}})),setCurrentStep:t=>e({currentStep:t}),setCurrentUpdatedBot:t=>e({currentUpdatedBot:t})}),{name:"bot-builder-storage"})),Me=te()((e,t)=>{const r=typeof window<"u"?JSON.parse(localStorage.getItem("guestUsedMerlinMagic")??JSON.stringify(!1)):!1;return{autoScrollEnabled:!0,bottomDrawerContent:null,centerPanelContent:"children",chatFooterWrapperRef:S.createRef(),chatScrollableContainerRef:S.createRef(),chatScrollableContainerScrollAnchorRef:S.createRef(),computedTitle:null,currentFileAttachment:null,guestUsedMerlinMagic:r,hasBotDraft:!1,initialTab:void 0,isModelSelectionMenuVisible:!1,isScrollingDown:!1,leftPanelContent:null,leftSidebarContent:null,messageToRegenerate:null,modelSelectionFilter:"all",openNativeFileSelector:()=>{},regenerateOnSelect:!1,rightPanelContent:null,selectedBot:null,sourcePanelConfig:null,selectedMessageIndex:-1,setGuestUsedMerlinMagic:()=>{typeof window>"u"||(localStorage.setItem("guestUsedMerlinMagic",JSON.stringify(!0)),e({guestUsedMerlinMagic:!0}))},setModelSelectionFilter:n=>e({modelSelectionFilter:n}),setSideBarVisible:n=>e({sideBarVisible:n}),sideBarVisible:!1,showVaultLinkContent:!1,showVaultTextContent:!1,showVaultPreview:!1,showVaultSidebar:!1,togglePanel:(n,s)=>{n?window.innerWidth>=768?(t().bottomDrawerContent==="crafts"&&Me.setState({bottomDrawerContent:null}),s==="left"&&e({initialTab:n==="updateChatbot"?"preview":void 0,leftPanelContent:t().leftPanelContent!==n?n:null}),s==="right"&&e({rightPanelContent:t().rightPanelContent!==n?n:null}),s==="bottom"&&e({bottomDrawerContent:t().bottomDrawerContent!==n?n:null})):(t().rightPanelContent==="crafts"&&Me.setState({rightPanelContent:null}),e({bottomDrawerContent:t().bottomDrawerContent!==n?n:null})):(s==="left"&&e({leftPanelContent:null}),s==="right"&&e({rightPanelContent:null}),s==="bottom"&&e({bottomDrawerContent:null}))},updateScrollPosition:null}}),Cr=["craft","canvas","merlinMagic","webAccess","file"],jr=te()(or((e,t)=>({activeNode:null,completedSteps:[],currentPath:[],currentStep:null,editorContent:"",error:null,fullPrompt:"",getCurrentPrompt:()=>{const r=t();return r.editorContent||_e(r.currentPath)},getSuggestionsByInput:r=>{const n=t(),s=n.activeNode;if(!(s!=null&&s.children))return[];const o=n.currentPath.map(i=>i.text).join(" ");if(r.trim()===o)return s.children;if(r.startsWith(o)){const i=r.slice(o.length).trim();return i?s.children.filter(c=>c.text.toLowerCase().includes(i.toLowerCase())):s.children}return s.children},goBack:()=>{e(r=>{if(r.currentPath.length<=1)return t().resetFlow(),{activeNode:null,currentPath:[],editorContent:"",error:null,isFlowComplete:!1,isValid:!0,suggestions:[]};const n=r.currentPath.slice(0,-1),s=n.length>0?n[n.length-1]:null;return{activeNode:s??null,currentPath:n,editorContent:_e(n),error:null,isFlowComplete:!1,isValid:!0,suggestions:(s==null?void 0:s.children)||[]}})},goToRoot:()=>{const r=t();if(r.currentPath.length===0){e({activeNode:null,currentPath:[],editorContent:"",error:null,isFlowComplete:!1,isValid:!0,suggestions:[]});return}const n=r.currentPath[0];n&&e({activeNode:n,currentPath:[n],editorContent:n.text,error:null,isFlowComplete:!1,isValid:!0,suggestions:n.children??[]})},handleNodeActions:async(r,n)=>{var o;if(!((o=r==null?void 0:r.metadata)!=null&&o.requiredParams))return;const s=r.metadata.requiredParams;if(s.model&&n!=="guest"){const i=await he.fetchQuery(Fe.MerlinConstants)??dn;let c;if(n==="free"?c=s.model.nonProUserModel:c=s.model.proUserModel,!i.textLLMs.find(d=>d.id===c)){console.error("Model not found:",c);return}window.__updateUserSettings({aiModel:c})}if(s.modes){const i=Object.entries(s.modes).reduce((c,[u,d])=>(Cr.includes(u)&&d&&c.push(u),c),[]);i.includes("merlinMagic")?window.__updateUserSettings({merlinMagic:{isEnabled:!0}}):window.__updateUserSettings({merlinMagic:{isEnabled:!1}}),i.includes("webAccess")?window.__updateUserSettings({focusMode:{isEnabled:!1,mode:"youtube"},webAccess:{isEnabled:!0}}):window.__updateUserSettings({focusMode:{isEnabled:!1,mode:"youtube"},webAccess:{isEnabled:!1}})}},history:[],isFlowComplete:!1,isValid:!0,navigateToNode:r=>{const n=t(),s=n.currentPath.findIndex(o=>o.id===r);if(s!==-1){const o=n.currentPath.slice(0,s+1),i=o.length>0?o[o.length-1]:null;if(!i)return;e({activeNode:i,currentPath:o,editorContent:_e(o),error:null,isFlowComplete:!1,isValid:!0,suggestions:i.children||[]})}},resetFlow:()=>{e({activeNode:null,currentPath:[],editorContent:"",error:null,history:[],isFlowComplete:!1,isValid:!0,suggestions:[]})},selectNode:(r,n)=>{e(s=>{var f,l;const o=[...s.currentPath,r],i=_e(o),c=((f=r.metadata)==null?void 0:f.isTerminal)??!1;if(!kr(r,s.currentPath))return{error:"Invalid node selection in flow",isValid:!1};(l=r.metadata)!=null&&l.requiredParams&&t().handleNodeActions(r,n);const d=[...s.history,{content:i,path:o,timestamp:Date.now()}];return{activeNode:r,currentPath:o,editorContent:i,error:null,history:d,isFlowComplete:c,isValid:!0,suggestions:r.children||[]}})},suggestions:[],updateContent:r=>{e(n=>({editorContent:r,error:n.isValid?null:n.error}))},validateCurrentFlow:()=>{const r=t();return r.activeNode?r.isFlowComplete?Pr(r.activeNode,r.editorContent):_r(r.currentPath):!1}}),{name:"quick-actions-store"}));function _e(e){return e.map(t=>t.text).join(" ")}function kr(e,t){var n;if(t.length===0)return!0;const r=t[t.length-1];return((n=r==null?void 0:r.children)==null?void 0:n.some(s=>s.id===e.id))??!1}function Pr(e,t){var r;return(r=e.metadata)!=null&&r.validationRules?e.metadata.validationRules.every(n=>n(t)):!0}function _r(e){var t;for(let r=1;r<e.length;r++){const n=e[r-1],s=e[r];if(!s||!((t=n==null?void 0:n.children)!=null&&t.some(o=>o.id===s.id)))return!1}return!0}const Er=te()(e=>({botSuggestionTipTapProps:null,disableScrollDownToAndFadedUI:!1,isBotSelectionMenuVisible:!1,isInputShaking:!1,isPromptAreaExpanded:!1,isNotificationNudgeVisible:!1,isPromptSelectionMenuVisible:!1,isChatWithWebpage:!1,isWebpageAttached:!1,lastSelectedContext:null,linkAttachments:[],linkAttachmentsRemoved:[],promptSuggestionTipTapProps:null,setLastSelectedContext:t=>e(r=>({lastSelectedContext:t})),setShouldShowDeepResearchBanner:t=>e(r=>({shouldShowDeepResearchBanner:t})),setSmallTextAreaCaretPosition:t=>e(r=>({smallTextAreaCaretPosition:t})),setTextWarningType:t=>e(r=>({textWarningType:t})),setUserPrompt:t=>e(r=>({userPrompt:t})),shouldShowDeepResearchBanner:!1,smallTextAreaCaretPosition:1,textWarningType:"none",tiptapEditorInstance:null,userPrompt:""})),Fr=(e,t)=>({activeThread:[],appendMessageThread:r=>{var n;r[0].parentId||(r[0].parentId=((n=t().activeThread[t().activeThread.length-1])==null?void 0:n.id)??"root"),r.forEach((s,o)=>{o>0&&(s.parentId=r[o-1].id)}),r.forEach(s=>{t().chatRef.set(s.id,{...s,activeChildIdx:0}),t().chatRef.get(s.parentId).childrenId.push(s.id)}),t().buildThread("root")},buildThread:r=>{const n=t().activeThread.findIndex(i=>i.id===r);let s=[];n!==-1&&(s=t().activeThread.filter((i,c)=>c<=n));const o=[];for(;r;){const i=t().chatRef.get(r).childrenId.map(c=>t().chatRef.get(c));if(i.length>0){const c=t().chatRef.get(r).activeChildIdx,u=i[c];o.push({...u,idx:c,totSiblings:t().chatRef.get(r).childrenId.length}),r=u==null?void 0:u.id}else r=null}e(()=>({activeThread:[...s,...o]}))},chatRef:new Map([["root",{activeChildIdx:0,attachments:[],childrenId:[],content:"",id:"root",idx:0,parentId:null,role:"system",status:"SUCCESS",timestamp:1714120666404,totSiblings:0}]]),deleteLastMessage:()=>{const r=Array.from(t().chatRef.values()).pop(),n=t().chatRef.get(r.id);if(t().chatRef.delete(r.id),!n)return null;const s=t().chatRef.get(n.parentId);return s.childrenId=s.childrenId.filter(o=>o!==n.id),s.activeChildIdx>=s.childrenId.length&&(s.activeChildIdx=s.childrenId.length-1<0?0:s.childrenId.length-1),t().buildThread("root"),{...n,idx:0,totSiblings:0}},editMessageNodeById:(r,n)=>{const s=t().chatRef.get(r);t().chatRef.set(r,n(s)),t().buildThread("root")},getLastMessage:()=>Array.from(t().chatRef.values()).pop(),init:()=>{t().chatRef.forEach((n,s)=>t().chatRef.set(s,{...n,activeChildIdx:0}));let r=null;for(t().chatRef.forEach((n,s)=>{(r===null||n.timestamp>=r.timestamp)&&(r=n)});r.parentId;){const n=t().chatRef.get(r.parentId);t().chatRef.set(r.parentId,{...n,activeChildIdx:n.childrenId.indexOf(r.id)}),r=t().chatRef.get(r.parentId)}t().buildThread("root")},insertMessageNode:(r,n)=>{e(o=>({chatRef:new Map([...o.chatRef,[n.id,{...n,activeChildIdx:0}]])}));const s=t().chatRef.get(r);s.childrenId.push(n.id),s.activeChildIdx=s.childrenId.length-1,t().buildThread(r)},insertMessageThread:(r,n)=>{var o;n[0].parentId||(n[0].parentId=((o=t().activeThread[t().activeThread.length-1])==null?void 0:o.id)??"root"),n.forEach((i,c)=>{c>0&&(i.parentId=n[c-1].id)}),n.forEach(i=>{t().chatRef.set(i.id,{...i,activeChildIdx:0}),t().chatRef.get(i.parentId).childrenId.push(i.id)});const s=t().chatRef.get(r);s.activeChildIdx=s.childrenId.length-1,t().buildThread(r)},reInitialize:r=>{const n=new Map(Object.entries(r));n.forEach(s=>{s.timestamp=new Date(s.timestamp).getTime()}),e(()=>({chatRef:n})),e({lastPromptInHeader:null}),t().init()},switchLeft:r=>{const n=t().chatRef.get(r.parentId);n.activeChildIdx>0&&(n.activeChildIdx-=1,t().buildThread(r.parentId))},switchRight:r=>{const n=t().chatRef.get(r.parentId);n.activeChildIdx<n.childrenId.length-1&&(n.activeChildIdx+=1,t().buildThread(r.parentId))},totalMessages:()=>{var r;return((r=t().chatRef)==null?void 0:r.size)-1}}),Ar=e=>({attachmentsUploadedByUser:[],chatbot:null,chatbotInteractionThread:!1,chatId:null,error:null,focusMode:void 0,lastPromptInHeader:null,model:{charge:"1x Query",default:!0,defaultPro:!1,description:"OpenAI's most scalable and fast model.",id:"gpt-3.5-turbo",name:"GPT 3.5",paid:!1,queryCost:1},project:null,isReadOnlyForCurrentUser:!1,questions:[],isDeepResearchEnabled:!1,resetChat:()=>{e({chatId:null}),e({lastPromptInHeader:null}),es.getState().resetStore(),Xt.getState().resetStore(),jr.getState().resetFlow(),Ie.setState({activeThread:[],chatRef:new Map([["root",{activeChildIdx:0,attachments:[],childrenId:[],content:"",id:"root",idx:0,parentId:null,role:"system",status:"SUCCESS",timestamp:1714120666404,totSiblings:0}]]),project:null,questions:[],sharing:null,chatbot:null}),Er.setState({isNotificationNudgeVisible:!1,lastSelectedContext:null}),Me.setState({rightPanelContent:null,sourcePanelConfig:null})},sharing:null,title:"Chat with Merlin Ai!",webAccess:!1}),Ie=te()((...e)=>({...Fr(...e),...Ar(...e)}));function $t(e){return"file"in e}function Gt(e){return"connectedAppType"in e}function ye(e){return"isImportFromMerlin"in e}function Wt(e){return"modelId"in e}function Tr(e){return"url"in e}function Ht(e){return"attachmentType"in e&&e.attachmentType==="WEB_PAGE"}function Ne(e){return $t(e)&&!Gt(e)&&!ye(e)&&!Wt(e)}function xe(e){return ye(e)&&!$t(e)}function Ce(e){return Tr(e)&&!ye(e)&&!Ht(e)}function We(e){return Ht(e)&&!ye(e)}function He(e){return Gt(e)&&!ye(e)}function Ke(e){return Wt(e)&&!ye(e)}function Kt(e){return e.fileDetails!==null&&Ne(e.fileDetails)}function Dr(e){return e.fileDetails!==null&&Ce(e.fileDetails)}function Rr(e){return e.fileDetails!==null&&He(e.fileDetails)}function Jt(e){return e.fileDetails!==null&&Ke(e.fileDetails)}function Qt(e){return e.fileDetails!==null&&xe(e.fileDetails)}const qe=10,Mr=2e3,Lr=5,Ze={abortController:null,analysingProgress:0,detailsForChat:null,fileDetails:null,fileStoreId:"",signedUrlResponse:null,status:"pending",uploadProgress:0},Ft={abortController:null,analysingProgress:0,detailsForChat:null,fileDetails:null,fileStoreId:"",signedUrlResponse:null,status:"pending"},Or={abortController:null,analysingProgress:0,detailsForChat:null,fileDetails:null,fileStoreId:"",signedUrlResponse:null,status:"pending"};function Le(e){return Ke(e)?`${e.prompt}-${e.id}`:Ce(e)||We(e)?`${e.title}-${e.id}`:xe(e)?`${(e==null?void 0:e.fileName)||(e==null?void 0:e.name)||(e==null?void 0:e.title)}-${e.id}`:`${e.name}-${e.id}`}function ft(e){var t,r;return Dt.isCancel(e)?"Upload cancelled":e instanceof un?((r=(t=e.response)==null?void 0:t.data)==null?void 0:r.message)||e.message:"An unexpected error occurred"}function Ur(e){return e.replace("GLOBAL_","")}function Br(e){if(!Ce(e))throw new Error("Invalid link attachment");if(!e)throw new Error("Invalid file details");return{dom:"",from:"",id:e.id,metadata:{hasFailed:!1,isUploading:!1,yetToBeSentOnce:!0},searchQueryForWebAccess:"",shouldCreateEmbeddings:!0,shouldScrapeOnCloud:!0,textContent:e.title,title:e.title,type:e.type,url:e.url}}function zr(e){if(!We(e))throw new Error("Invalid web page attachment");if(!e)throw new Error("Invalid file details");return{id:e.id,type:e.attachmentType,url:e.url,title:e.title,dom:e.dom,textContent:e.textContent}}function Vr(e){if(!He(e))throw new Error("Invalid connected app attachment");if(!e)throw new Error("Invalid file details");return{connectedAppFileId:e.connectedAppFileId,connectedAppType:e.connectedAppType,fileName:e.name,id:e.id,mimeType:e.type,type:e.attachmentType}}function $r(e){if(!Jt(e)&&!e.fileDetails)throw new Error("Invalid generated image details");if(!e.fileDetails)throw new Error("Invalid file details");return{fileName:e.fileDetails.prompt,gcsId:e.fileDetails.gcsId,generationId:e.fileDetails.generationId||"",height:e.fileDetails.height,id:e.fileDetails.id,mimeType:e.fileDetails.mimeType,modelId:e.fileDetails.modelId,nsfw:e.fileDetails.nsfw,prompt:e.fileDetails.prompt,status:e.fileDetails.status,textContent:e.fileDetails.textContent,type:e.fileDetails.attachmentType,url:e.fileDetails.url,width:e.fileDetails.width}}function Gr(e){if(!Kt(e)||!e.signedUrlResponse&&!e.fileDetails)throw new Error("Invalid file details");if(!e.fileDetails)throw new Error("Invalid file details");return{fileName:e.fileDetails.name,gcsId:e.signedUrlResponse.fileName,id:e.fileDetails.id,mimeType:e.fileDetails.type,type:e.fileDetails.attachmentType,url:e.signedUrlResponse.url}}function Wr(e){if(!Qt(e))throw new Error("Invalid file details");if(!e.fileDetails)throw new Error("Invalid file details");return e.fileDetails}function Hr(){let e=Ie.getState().chatId;return e||(e=tt(),Ie.setState({chatId:e})),e}function Kr(e){if(!e.fileDetails)throw new Error("Missing file data");if(xe(e.fileDetails))return Wr(e);if(Ke(e.fileDetails))return $r(e);if(Ce(e.fileDetails))return Br(e.fileDetails);if(We(e.fileDetails))return zr(e.fileDetails);if(He(e.fileDetails))return Vr(e.fileDetails);if(Ne(e.fileDetails))return Gr(e);throw new Error("Unknown attachment type")}async function Jr(e,t,r){var p,g,x,h,m,v,w,I,j,X,Y;if(!e.fileDetails)throw new Error("Missing file details");const n=(g=(p=e.fileDetails)==null?void 0:p.attachmentType)==null?void 0:g.includes("GLOBAL"),s=(h=(x=e.fileDetails)==null?void 0:x.attachmentType)==null?void 0:h.includes("CONNECTED"),o=Ye.getState().currentUpdatedBot;let i=t.type;if(s&&n&&(i=Ur(i)),xe(e.fileDetails)){const{createdAt:k,createdByUserId:_,isImportFromMerlin:P,metadata:z,projectId:T,source:D,updatedAt:N,usedInProjects:R,...V}=t;t={...V,type:e.fileDetails.attachmentType}}const{metadata:c,...u}=t,d={attachment:{...u,type:i},language:"ENGLISH"};if(((m=e.fileDetails)==null?void 0:m.source)==="CHAT"&&(d.chatId=Hr()),((v=e.fileDetails)==null?void 0:v.source)==="PROJECT"&&(d.projectId=(w=Ie.getState().project)==null?void 0:w.id),((I=e.fileDetails)==null?void 0:I.source)==="PROJECT"&&(d.projectId=(r==null?void 0:r.projectId)||((j=Ie.getState().project)==null?void 0:j.id)),o!=null&&o.id&&Me.getState().leftPanelContent==="updateChatbot"&&(d.chatbotId=o==null?void 0:o.id),window.location.pathname==="/chat/bots/create"){const k=he.getQueryData(At.VaultItems.queryKey),_=((X=k==null?void 0:k.pages[0])==null?void 0:X.storageInfo)||{limit:0,percentage:0,used:0},P=e.fileDetails.attachmentType!=="GLOBAL_LINK"?e.fileDetails.file.size:0,z=Ye.getState().createBotAttachmentSize;if(_.limit-(_.used+z)>P)return Ye.setState(D=>({createBotAttachment:[...D.createBotAttachment,{attachment:d.attachment,language:d.language,size:P}],createBotAttachmentSize:D.createBotAttachmentSize+P})),null;Ae.dismiss(1),Ae.error("Storage limit exceeded",{description:"Please delete some files from Merlin Vault to free up space.",duration:1/0})}xe(e.fileDetails)&&(d.isImportFromMerlin=!0),d.chatId&&!d.projectId&&!d.chatbotId&&(d.backgroundTask=!0);const f=await Tt.post("/v2/user/upload",d,{signal:(Y=e.abortController)==null?void 0:Y.signal}),l=f.data.data.attachment;if(l&&d.chatbotId){const k=he.getQueryData(Fe.BotKnowledgeBaseById(d.chatbotId).queryKey);k&&k.attachments&&he.setQueryData(Fe.BotKnowledgeBaseById(d.chatbotId).queryKey,{attachments:[...k.attachments,{fileName:l.fileName?l.fileName:l.type==="GLOBAL_LINK"&&l.url,id:l.id,type:l.type,url:l.url}],total:k.attachments.length+1})}return f.data.data}async function Qr(e,t,r){if(!e.fileDetails)throw new Error("Missing file data");const n=Kr(e);t(A(o=>{const i=o.currentFiles[e.fileStoreId];i&&(i.status="analysing",i.analysingProgress=0)}));const s=setInterval(()=>{t(A(o=>{const i=o.currentFiles[e.fileStoreId];i&&i.status==="analysing"&&(i.analysingProgress=Math.min(95,i.analysingProgress+Lr))}))},Mr);try{const o=await Jr(e,n,r);if(!o)return;const{attachment:i}=o;Qt(e)?t(A(c=>{const u=c.currentFiles[e.fileStoreId];if(u&&"fileDetails"in u){u.fileDetails={...e.fileDetails},u.signedUrlResponse={contentType:i.mimeType,fileName:i.fileName,id:i.id,url:i.url};const{createdAt:d,createdByUserId:f,metadata:l,projectId:p,source:g,summary:x,updatedAt:h,version:m,...v}=i;u.detailsForChat=v,u.analysingProgress=100,u.status="completed"}})):t(A(c=>{const u=c.currentFiles[e.fileStoreId];u&&(u.detailsForChat=n,u.analysingProgress=100,u.status="completed")}))}finally{clearInterval(s)}}async function Xr(e,t){var r;if(!e.signedUrlResponse||!e.fileDetails||!("file"in e.fileDetails))throw new Error("Missing file data");t(A(n=>{const s=n.currentFiles[e.fileStoreId];s&&(s.status="uploading",s.uploadProgress=0)}));try{await Dt.put(e.signedUrlResponse.url,e.fileDetails.file,{headers:{"Content-Type":e.fileDetails.type},signal:(r=e.abortController)==null?void 0:r.signal}),t(A(n=>{const s=n.currentFiles[e.fileStoreId];s&&(s.uploadProgress=100,s.status="analysing")}))}catch(n){throw t(A(s=>{const o=s.currentFiles[e.fileStoreId];o&&(o.status="failed",o.error=ft(n))})),n}}async function Yr(e,t){if(e.length===0)return;const n=e.filter(Ne).map(s=>({id:s.id,name:s.name,type:s.type}));try{const s=await Tt.post("/v1/user/getPresignedUrl",{files:n});if(s.data.status==="error")throw new Error(s.data.data.message);const{signedUrls:o}=s.data.data;t(A(i=>{e.forEach(c=>{const u=Le(c),d=i.currentFiles[u];d&&(d.signedUrlResponse=o[c.id],d.status="gettingPresignedUrl",i.queue.push(u))})}))}catch(s){console.error("Error during file upload:",s);const o=ft(s);t(A(i=>{e.forEach(c=>{const u=Le(c),d=i.currentFiles[u];d&&d.status==="gettingPresignedUrl"&&(d.status="failed",d.error=o)})}))}}function qr(e){e(A(t=>{t.hasStorageLimitError=!0,t.queue.forEach(r=>{var s;const n=t.currentFiles[r];n&&n.status!=="completed"&&(n.status="failed",n.error="Storage limit exceeded",(s=n.abortController)==null||s.abort())}),t.queue=[],Object.values(t.currentFiles).forEach(r=>{var n;(r.status==="uploading"||r.status==="analysing"||r.status==="gettingPresignedUrl"||r.status==="pending")&&(r.status="failed",r.error="Storage limit exceeded",(n=r.abortController)==null||n.abort())})})),Ae.error("Storage limit exceeded",{action:{label:"Manage storage",onClick:()=>{Nr.getState().openDialog()}},description:"Please delete some files to free up space.",duration:1/0,id:"storage-limit-error"}),setTimeout(()=>{e(A(t=>{Object.keys(t.currentFiles).forEach(r=>{const n=t.currentFiles[r];n.status==="failed"&&n.error==="Storage limit exceeded"&&delete t.currentFiles[r]})}))},3e3)}async function Zr(e,t,r){var n,s,o,i,c,u;for(;;){if(t().hasStorageLimitError)return;let d;if(e(A(l=>{l.hasStorageLimitError||(d=l.queue.shift(),d&&l.activeUploads++)})),!d)return;const f=t().currentFiles[d];if(!f){e(A(l=>{l.activeUploads--}));continue}try{Jt(f)||(Kt(f)?f.status==="gettingPresignedUrl"&&await Xr(f,e):Dr(f)||Rr(f)),await Qr(f,e,r)}catch(l){console.error("Upload/Analysis error:",l);const p=((o=(s=(n=l==null?void 0:l.response)==null?void 0:n.data)==null?void 0:s.data)==null?void 0:o.type)==="STORAGE_LIMIT_EXCEEDED";if(e(A(g=>{const x=g.currentFiles[d];x&&(x.status="failed",x.error=p?"Storage limit exceeded":ft(l)),g.activeUploads--})),p){qr(e);return}else{const g=((u=(c=(i=l==null?void 0:l.response)==null?void 0:i.data)==null?void 0:c.data)==null?void 0:u.message)||(l==null?void 0:l.message)||"Failed to process file. Please try again.";Ae.error(g),setTimeout(()=>{e(A(x=>{delete x.currentFiles[d]}))},3e3)}continue}e(A(l=>{l.activeUploads--}))}}function mt(){return(e,t)=>({activeUploads:0,allUploadsComplete:!1,currentFiles:{},hasStorageLimitError:!1,maxConcurrentUploads:qe,queue:[],remove:r=>e(A(n=>{const s=n.currentFiles[r];s!=null&&s.abortController&&s.abortController.abort(),delete n.currentFiles[r],n.queue=n.queue.filter(o=>o!==r)})),resetStore:()=>e({activeUploads:0,allUploadsComplete:!1,currentFiles:{},hasStorageLimitError:!1,maxConcurrentUploads:qe,queue:[]}),start:async(r,n)=>{const s=r.filter(Ne);e(A(f=>{r.forEach(l=>{const p=Le(l);let g;if(xe(l))g={...Ze,fileDetails:{...l},fileStoreId:p,status:"pending"};else if(Ne(l)){const h=l.source==="VAULT"?"pending":"gettingPresignedUrl";g={...Ze,fileDetails:l,fileStoreId:p,status:h}}else if(Ke(l))g={...Ze,fileDetails:l,fileStoreId:p,status:"pending"};else if(Ce(l))g={...Ft,fileDetails:l,fileStoreId:p,status:"pending"};else if(We(l))g={...Ft,fileDetails:l,fileStoreId:p,status:"pending"};else if(He(l))g={...Or,fileDetails:l,fileStoreId:p,status:"pending"};else throw new Error("Unknown attachment type");f.currentFiles[p]=g})})),s.length>0&&await Yr(s,e),e(A(f=>{r.forEach(l=>{const p=Le(l);f.currentFiles[p]&&f.currentFiles[p].status==="pending"&&f.queue.push(p)})}));const o=[];for(let f=0;f<qe;f++)o.push(Zr(e,t,n));await Promise.all(o);const{currentFiles:i,hasStorageLimitError:c,queue:u}=t(),d=Object.values(i).every(f=>f.status==="completed"||f.status==="failed")&&u.length===0;!c&&d&&he.invalidateQueries({queryKey:At.VaultItems.queryKey}),e({allUploadsComplete:d})}})}const es=te()(mt()),Xt=te()(mt()),ts=te()(mt());var ht="Checkbox",[ns,Ls]=Kn(ht),[rs,ss]=ns(ht),Yt=S.forwardRef((e,t)=>{const{__scopeCheckbox:r,name:n,checked:s,defaultChecked:o,required:i,disabled:c,value:u="on",onCheckedChange:d,...f}=e,[l,p]=S.useState(null),g=En(t,I=>p(I)),x=S.useRef(!1),h=l?!!l.closest("form"):!0,[m=!1,v]=Jn({prop:s,defaultProp:o,onChange:d}),w=S.useRef(m);return S.useEffect(()=>{const I=l==null?void 0:l.form;if(I){const j=()=>v(w.current);return I.addEventListener("reset",j),()=>I.removeEventListener("reset",j)}},[l,v]),a.jsxs(rs,{scope:r,state:m,disabled:c,children:[a.jsx(Mt.button,{type:"button",role:"checkbox","aria-checked":le(m)?"mixed":m,"aria-required":i,"data-state":en(m),"data-disabled":c?"":void 0,disabled:c,value:u,...f,ref:g,onKeyDown:St(e.onKeyDown,I=>{I.key==="Enter"&&I.preventDefault()}),onClick:St(e.onClick,I=>{v(j=>le(j)?!0:!j),h&&(x.current=I.isPropagationStopped(),x.current||I.stopPropagation())})}),h&&a.jsx(as,{control:l,bubbles:!x.current,name:n,value:u,checked:m,required:i,disabled:c,style:{transform:"translateX(-100%)"}})]})});Yt.displayName=ht;var qt="CheckboxIndicator",Zt=S.forwardRef((e,t)=>{const{__scopeCheckbox:r,forceMount:n,...s}=e,o=ss(qt,r);return a.jsx(Qn,{present:n||le(o.state)||o.state===!0,children:a.jsx(Mt.span,{"data-state":en(o.state),"data-disabled":o.disabled?"":void 0,...s,ref:t,style:{pointerEvents:"none",...e.style}})})});Zt.displayName=qt;var as=e=>{const{control:t,checked:r,bubbles:n=!0,...s}=e,o=S.useRef(null),i=Yn(r),c=Xn(t);return S.useEffect(()=>{const u=o.current,d=window.HTMLInputElement.prototype,l=Object.getOwnPropertyDescriptor(d,"checked").set;if(i!==r&&l){const p=new Event("click",{bubbles:n});u.indeterminate=le(r),l.call(u,le(r)?!1:r),u.dispatchEvent(p)}},[i,r,n]),a.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:le(r)?!1:r,...s,tabIndex:-1,ref:o,style:{...e.style,...c,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function le(e){return e==="indeterminate"}function en(e){return le(e)?"indeterminate":e?"checked":"unchecked"}var tn=Yt,os=Zt;const ue=S.forwardRef(({className:e,...t},r)=>a.jsx(tn,{ref:r,className:H("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",e),...t,children:a.jsx(os,{className:H("flex items-center justify-center text-current"),children:a.jsx(qn,{className:"h-4 w-4"})})}));ue.displayName=tn.displayName;const is=({content:e,getFileSelectionLimit:t,isAtLimit:r,onContentSelect:n,selectedContent:s,setSelectedContent:o})=>{const i=S.useMemo(()=>e.filter(d=>d.type==="image"),[e]),c=d=>{if(!d&&s){const x=[...s];s.forEach((h,m)=>{h.type==="image"&&(x[m]={...h,selected:!1})}),o(x);return}const f=s.filter(x=>x.selected&&x.type!=="image").length,l=t()-f;if(l<=0)return;const p=[...s];let g=0;s.forEach((x,h)=>{x.type==="image"&&g<l&&(p[h]={...x,selected:!0},g++)}),o(p)},u=S.useMemo(()=>i.every(d=>{var f;return(f=s[s.findIndex(l=>l===d)])==null?void 0:f.selected}),[i,s]);return i.length?a.jsxs(Oe,{value:"image",className:"mb-2 last:mb-0",children:[a.jsx(Ue,{className:H("bg-card px-3 py-2 shadow-sm hover:bg-muted/50 hover:no-underline","data-[state=closed]:rounded-lg data-[state=open]:rounded-t-lg"),children:a.jsxs("div",{className:"flex w-full items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(ue,{checked:u,onCheckedChange:c,disabled:r&&!u,onClick:d=>d.stopPropagation(),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),a.jsx("span",{className:"font-medium",children:"Images found in selection"})]}),a.jsx("span",{className:"text-sm text-muted-foreground",children:i.length??0})]})}),a.jsx(Be,{children:a.jsx("div",{className:"mt-0 w-full overflow-hidden rounded-b-lg bg-muted/5 p-4 shadow-sm",children:a.jsx("div",{className:"grid grid-cols-3 gap-4",children:i.map((d,f)=>{const l=s.findIndex(g=>g===d)??-1;if(l===-1)return null;const p=Ee(d.content,"image",{alt:d.name||"",src:d.content});return a.jsxs("div",{className:"flex flex-col gap-2",children:[a.jsxs("div",{className:"relative aspect-square cursor-pointer rounded-lg border bg-card transition-colors hover:bg-muted/50",onClick:()=>n==null?void 0:n(d,l),children:[a.jsx(ue,{checked:d.selected,onCheckedChange:g=>{if(r&&!d.selected)return;const x=[...s];x[l]={...d,name:p,selected:!!g},o(x)},className:"absolute right-2 top-2 z-10 border-secondary bg-secondary text-primary shadow-sm backdrop-blur-sm",disabled:r&&!d.selected}),a.jsx("img",{src:d.content,alt:"",className:"absolute inset-0 h-full w-full rounded-lg object-cover"})]}),a.jsx("div",{className:"truncate px-1 text-center text-xs text-muted-foreground",children:p})]},f)})})})})]}):null},ls=({content:e,getFileSelectionLimit:t,isAtLimit:r,onContentSelect:n,selectedContent:s,setSelectedContent:o})=>{const i=S.useMemo(()=>e.filter(d=>d.type==="link"),[e]),c=d=>{if(!d&&s){const x=[...s];s.forEach((h,m)=>{h.type==="link"&&(x[m]={...h,selected:!1})}),o(x);return}const f=s.filter(x=>x.selected&&x.type!=="link").length,l=t()-f;if(l<=0)return;const p=[...s];let g=0;s.forEach((x,h)=>{x.type==="link"&&g<l&&(p[h]={...x,selected:!0},g++)}),o(p)},u=S.useMemo(()=>i.every(d=>{var f;return(f=s[s.findIndex(l=>l===d)])==null?void 0:f.selected}),[i,s]);return i.length?a.jsxs(Oe,{value:"link",className:"mb-2 last:mb-0",children:[a.jsx(Ue,{className:H("bg-card px-3 py-2 shadow-sm hover:bg-muted/50 hover:no-underline","data-[state=closed]:rounded-lg data-[state=open]:rounded-t-lg"),children:a.jsxs("div",{className:"flex w-full items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(ue,{checked:u,onCheckedChange:c,disabled:r&&!u,onClick:d=>d.stopPropagation(),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),a.jsx("span",{className:"font-medium",children:"Links found in selection"})]}),a.jsx("span",{className:"text-sm text-muted-foreground",children:i.length??0})]})}),a.jsx(Be,{children:a.jsx("div",{className:"mt-0 w-full overflow-hidden rounded-b-lg bg-muted/5 p-4 shadow-sm",children:a.jsx("div",{className:"space-y-3",children:i.map((d,f)=>{try{const l=s.findIndex(p=>p===d)??-1;return l===-1?null:a.jsx("div",{className:H("rounded-lg border bg-card p-3 transition-colors hover:bg-muted/50"),onClick:()=>n==null?void 0:n(d,l),children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(ue,{checked:d.selected,onCheckedChange:p=>{if(r&&!d.selected)return;const g=[...s];g[l]={...d,selected:!!p},o(g)},className:"mt-1",disabled:r&&!d.selected}),a.jsxs("div",{className:"flex-1 space-y-1 overflow-hidden",children:[a.jsx("div",{className:"w-full cursor-pointer overflow-hidden font-medium text-primary hover:underline",onClick:p=>{p.stopPropagation(),window.open(d.content,"_blank")},children:et(d.content)}),a.jsx("div",{className:"text-xs text-muted-foreground",children:new URL(d.content).hostname})]})]})},f)}catch{return null}})})})})]}):null},cs=({content:e,expandedTexts:t,getFileSelectionLimit:r,isAtLimit:n,onContentSelect:s,selectedContent:o,setExpandedTexts:i,setSelectedContent:c})=>{const u=S.useMemo(()=>e.filter(l=>l.type==="markdown"),[e]),d=l=>{if(!l&&o){const m=[...o];o.forEach((v,w)=>{v.type==="markdown"&&(m[w]={...v,selected:!1})}),c(m);return}const p=o.filter(m=>m.selected&&m.type!=="markdown").length,g=r()-p;if(g<=0)return;const x=[...o];let h=0;o.forEach((m,v)=>{m.type==="markdown"&&h<g&&(x[v]={...m,selected:!0},h++)}),c(x)},f=S.useMemo(()=>u.every(l=>{var p;return(p=o[o.findIndex(g=>g===l)])==null?void 0:p.selected}),[u,o]);return u.length?a.jsxs(Oe,{value:"markdown",className:"mb-2 last:mb-0",children:[a.jsx(Ue,{className:H("bg-card px-3 py-2 shadow-sm hover:bg-muted/50 hover:no-underline","data-[state=closed]:rounded-lg data-[state=open]:rounded-t-lg"),children:a.jsxs("div",{className:"flex w-full items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(ue,{checked:f,onCheckedChange:d,disabled:n&&!f,onClick:l=>l.stopPropagation(),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),a.jsx("span",{className:"font-medium",children:"Markdown found in selection"})]}),a.jsxs("span",{className:"text-sm text-muted-foreground",children:[u.map(l=>l.content.split(" ").length).reduce((l,p)=>l+p,0)??0," ","Words"," "]})]})}),a.jsx(Be,{children:a.jsx("div",{className:"mt-0 w-full overflow-hidden rounded-b-lg bg-muted/5 p-4 shadow-sm",children:a.jsx("div",{className:"space-y-3",children:u.map((l,p)=>{const g=o.findIndex(h=>h===l)??-1;if(g===-1)return null;const x=t[g]??!1;return a.jsx("div",{className:"rounded-lg border bg-card p-3 transition-colors hover:bg-muted/50",onClick:()=>s==null?void 0:s(l,g),children:a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("div",{className:H(!x&&"max-h-[100px] overflow-hidden"),children:a.jsx(Zn,{content:l.content})}),l.content.length>200&&a.jsx(ie,{variant:"ghost",size:"sm",className:"w-fit px-0 text-xs hover:bg-transparent",onClick:h=>{h.stopPropagation(),i(m=>({...m,[g]:!x}))},children:x?"Show Less":"Show More"})]})},p)})})})})]}):null},ds=({content:e,expandedTexts:t,getFileSelectionLimit:r,isAtLimit:n,onContentSelect:s,selectedContent:o,setExpandedTexts:i,setSelectedContent:c})=>{const u=S.useMemo(()=>e.filter(l=>l.type==="text"),[e]),d=l=>{if(!l&&o){const m=[...o];o.forEach((v,w)=>{v.type==="text"&&(m[w]={...v,selected:!1})}),c(m);return}const p=o.filter(m=>m.selected&&m.type!=="text").length,g=r()-p;if(g<=0)return;const x=[...o];let h=0;o.forEach((m,v)=>{m.type==="text"&&h<g&&(x[v]={...m,selected:!0},h++)}),c(x)},f=S.useMemo(()=>u.every(l=>{var p;return(p=o[o.findIndex(g=>g===l)])==null?void 0:p.selected}),[u,o]);return u.length?a.jsxs(Oe,{value:"text",className:"mb-2 last:mb-0",children:[a.jsx(Ue,{className:H("bg-card px-3 py-2 shadow-sm hover:bg-muted/50 hover:no-underline","data-[state=closed]:rounded-lg data-[state=open]:rounded-t-lg"),children:a.jsxs("div",{className:"flex w-full items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(ue,{checked:f,onCheckedChange:d,disabled:n&&!f,onClick:l=>l.stopPropagation(),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),a.jsx("span",{className:"font-medium",children:"Selected text"})]}),a.jsxs("span",{className:"text-sm text-muted-foreground",children:[u.map(l=>l.content.split(" ").length).reduce((l,p)=>l+p,0)??0," ","Words"," "]})]})}),a.jsx(Be,{children:a.jsx("div",{className:"mt-0 w-full overflow-hidden rounded-b-lg bg-muted/5 p-4 shadow-sm",children:a.jsx("div",{className:"space-y-3",children:u.map((l,p)=>{const g=o.findIndex(h=>h===l)??-1;if(g===-1)return null;const x=t[g]??!1;return a.jsx("div",{className:"rounded-lg border bg-card p-3 transition-colors hover:bg-muted/50",onClick:()=>s==null?void 0:s(l,g),children:a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("div",{className:H("text-muted-foreground",!x&&"line-clamp-3"),children:l.content}),l.content.length>200&&a.jsx(ie,{variant:"ghost",size:"sm",className:"w-fit px-0 text-xs hover:bg-transparent",onClick:h=>{h.stopPropagation(),i(m=>({...m,[g]:!x}))},children:x?"Show Less":"Show More"})]})},p)})})})})]}):null};function us({content:e,onClose:t}){var xt,yt;const r=S.useMemo(()=>{const y=[{...e[0],name:Ee(e[0].content,e[0].type),selected:e[0].type==="text"||e[0].type==="markdown"}],C=bn();C.length>0&&C.forEach(F=>{y.push({content:F,selected:!1,type:"link"})});const E=Sn();return E.length>0&&E.forEach(F=>{y.push({content:F.src,name:F.alt||"image",selected:!1,type:"image"})}),y},[e]),[n,s]=S.useState(r),[o,i]=S.useState([]),[c,u]=S.useState(null),[d,f]=S.useState(!0),[l,p]=S.useState(()=>In(r)),[g,x]=S.useState({}),[h,m]=S.useState(!1),[v,w]=S.useState(!1),[I,j]=S.useState(null),[X,Y]=S.useState(!1),[k,_]=S.useState(!1),[P,z]=S.useState(!1),[T,D]=S.useState(!1),N=fn(),[R,V]=S.useState({}),{data:q,isPending:ne}=Nn();async function ve(y,C){if(!y||!y.length){j({message:"No content selected to upload",type:"error"});return}const E=C?Xt:ts,se=(await Promise.all(y.map(async b=>{const G=crypto.randomUUID();if(V(Z=>({...Z,[G]:{fileName:b.name||Ee(b.content,b.type,{alt:b.name,src:b.type==="image"?b.content:void 0}),progress:0,status:"pending"}})),b.type==="link")return{attachmentType:"GLOBAL_LINK",id:G,source:C?"PROJECT":"VAULT",title:b.content,type:"GLOBAL_LINK",url:b.content};if(b.type==="text"||b.type==="markdown"){const Z=b.name||Ee(b.content,b.type),O=new File([b.content],Z,{type:"text/plain"});return{attachmentType:"GLOBAL_FILE",file:O,id:G,name:Z,source:C?"PROJECT":"VAULT",type:O.type.trim()!==""?O.type:"text/x-code"}}else if(b.type==="image"){const O=await(await fetch(b.content)).blob(),M=b.name?`${b.name}.${O.type.split("/")[1]}`:"image.jpg",K=new File([O],M,{type:O.type});return{attachmentType:"GLOBAL_IMAGE",file:K,id:G,name:M,source:C?"PROJECT":"VAULT",type:K.type}}}))).filter(b=>b!==void 0);E.getState().start(se,C&&{projectId:C}),await Promise.all(se.map(b=>new Promise((G,Z)=>{const O=setInterval(()=>{var vt,wt;const M=E.getState().currentFiles,K=(b==null?void 0:b.attachmentType)==="GLOBAL_LINK"?`${b==null?void 0:b.url}-${b==null?void 0:b.id}`:`${b==null?void 0:b.name}-${b==null?void 0:b.id}`;if(M[K]){let W=0;const Q=M[K].status;if((b==null?void 0:b.attachmentType)==="GLOBAL_LINK"){switch(Q){case"analysing":W=75;break;case"completed":W=100;break;case"failed":W=0;break;case"uploading":W=50;break;default:W=0}V(ae=>({...ae,[b.id]:{error:M[K].error,fileName:et(b.url||""),progress:W,status:Q}})),Q==="completed"?(clearInterval(O),G(!0)):Q==="failed"&&(clearInterval(O),Z(((vt=M[K])==null?void 0:vt.error)||"Upload failed"))}else{if(Q==="completed")W=100;else if(Q==="failed")W=0;else{const ae=typeof M[K].analysingProgress=="number"?M[K].analysingProgress:0;Q==="analysing"?W=50+ae/2:ae===100?W=75:W=ae/2}V(ae=>({...ae,[b.id]:{error:M[K].error,fileName:b.name||"File",progress:Math.round(W),status:Q}})),Q==="completed"?(clearInterval(O),G(!0)):Q==="failed"&&(clearInterval(O),Z(((wt=M[K])==null?void 0:wt.error)||"Upload failed"))}}},500);setTimeout(()=>{clearInterval(O),V(M=>({...M,[b.id]:{...M[b.id],error:"Upload timed out",progress:0,status:"failed"}})),Z("Upload timed out")},5*60*1e3)})))}S.useEffect(()=>{q&&i(q)},[q]);const re=y=>{p(y)};async function pt(){if(n){Y(!0);try{const y=ee(N.isFree),C=n.map((E,F)=>({...E,selected:F<y}));s(C),fe({eventData:{action:je?"deselect-all":"select-all",itemCount:n.length,source:window.location.href},eventName:"vault-select-all-button-selection",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),n.length>y&&(j({message:`${N.isFree?"Free":"Pro"} users can only select up to ${y} files at once.${N.isFree?" Upgrade to select more.":""}`,type:"error"}),setTimeout(()=>{j(null)},3e3))}finally{Y(!1)}}}async function $(y,C){var b;if(!n)return;const E=n.filter(G=>G.selected).length,F=(b=n==null?void 0:n[C])==null?void 0:b.selected;if(!F&&E>=ee(N.isFree)){j({message:`${N.isFree?"Free":"Pro"} users can only select up to ${ee(N.isFree)} files at once.${N.isFree?" Upgrade to select more.":""}`,type:"error"}),setTimeout(()=>{j(null)},3e3);return}const se=[...n];se[C]={...y,selected:!F},s(se),F&&j(null)}async function nn(){if(n){Y(!0);try{const y=n.map(C=>({...C,selected:!1}));s(y)}finally{Y(!1)}}}async function rn(y){_(!0);try{await ve(y);const C=y.reduce((E,F)=>(E[F.type]=(E[F.type]||0)+1,E),{});fe({eventData:{contentTypes:C,itemCount:y.length,source:window.location.href},eventName:"vault-save-to-vault-button",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),j({message:"Saved to Merlin Vault",type:"success"}),setTimeout(()=>{t()},3e3)}catch(C){console.error("Error saving to vault:",C),j({message:"Failed to save to vault",type:"error"})}finally{_(!1)}}async function sn(y,C){var E;z(!0);try{await ve(y,C);const F=(E=o==null?void 0:o.find(b=>b.id===C))==null?void 0:E.name,se=y.reduce((b,G)=>(b[G.type]=(b[G.type]||0)+1,b),{});fe({eventData:{contentTypes:se,itemCount:y.length,projectId:C,projectName:F,source:window.location.href},eventName:"vault-save-to-project-button",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),j({message:`Saved to project: ${F}`,type:"success"}),setTimeout(()=>{t()},5e3)}catch(F){console.error("Error saving to project:",F),j({message:"Failed to save to project",type:"error"})}finally{z(!1)}}async function gt(){const y=n==null?void 0:n.filter(E=>E.selected);if(!y||y.length===0){j({message:"Please select content to save",type:"error"}),setTimeout(()=>{j(null)},3e3);return}const C=ee(N.isFree);if(y.length>C){j({message:`${N.isFree?"Free":"Pro"} users can only save up to ${C} files at once.${N.isFree?" Upgrade to save more.":""}`,type:"error"}),setTimeout(()=>{j(null)},3e3);return}try{j(null),c?await sn(y,c.id):await rn(y)}catch(E){console.error("Error saving content:",E),j({message:"Failed to save content",type:"error"}),setTimeout(()=>{j(null)},3e3)}}async function an(){D(!0);try{w(!1),u(null)}finally{D(!1)}}const je=S.useMemo(()=>(n==null?void 0:n.every(y=>y.selected))??!1,[n]),L=S.useMemo(()=>Cn(n??[]),[n]);function on(y){fe({eventData:{projectId:y.id,projectName:y.name,source:window.location.href},eventName:"vault-project-select-button",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),u(y),m(!1)}return a.jsx(Ln,{onOpenChange:y=>{!y&&Object.keys(R).length>0&&!window.confirm("Closing this window might affect your upload. Are you sure you want to close?")||(f(y),y||t())},open:d,children:a.jsxs(On,{className:"z-[93847348238749] flex flex-col text-primary",children:[a.jsxs(Un,{children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Bn,{className:"font-serif text-xl text-primary",children:"Save to Merlin Vault"}),a.jsx("a",{className:"inline-flex items-center text-muted-foreground transition-colors hover:text-primary",href:"https://www.getmerlin.in/vault",onClick:y=>{y.stopPropagation(),fe({eventName:"vaultInfoClicked",eventType:"Link",feature:"Vault",firedFromFile:"features/vault/components/vaultPopup"})},rel:"noopener noreferrer",target:"_blank",children:a.jsx(Fn,{className:"h-4 w-4"})})]}),a.jsx("div",{className:"text-sm text-muted-foreground",children:"Bookmark everything in one place, and use them in Merlin chats and projects."}),N.isFree&&a.jsxs("div",{className:"text-sm text-muted-foreground",children:["$",N.isFree?"Free":"Pro"," users can select up to"," ",ee(N.isFree)," files at once. Upgrade for more."]})]}),a.jsxs("div",{className:"flex flex-col gap-2",children:[Object.keys(R).length>0&&a.jsxs("div",{className:"space-y-2 rounded-lg bg-neutral-50 p-3 dark:bg-neutral-900",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm font-medium",children:"Upload Progress"}),a.jsx("span",{className:"text-sm text-muted-foreground",children:jn(R)})]}),a.jsx("div",{className:"h-2 w-full overflow-hidden rounded-full bg-neutral-100 dark:bg-neutral-800",children:a.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-in-out dark:bg-indigo-400",style:{width:`${kn(R)}%`}})}),a.jsx("div",{className:"space-y-1",children:Object.entries(R).map(([y,C])=>a.jsxs("div",{className:"flex items-center justify-between text-xs",children:[a.jsxs("span",{className:"truncate",children:[C.status==="completed"&&" ",C.status==="failed"&&" ",C.fileName||"File"]}),a.jsx("span",{className:H("text-muted-foreground",C.status==="completed"&&"text-green-600 dark:text-green-400",C.status==="failed"&&"text-red-600 dark:text-red-400"),children:C.status==="failed"?"Failed":C.status==="completed"?"100%":`${C.progress}%`})]},y))})]}),v?a.jsxs("div",{className:"mt-4 flex flex-col",children:[Object.keys(R).length===0&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"mb-2 text-sm font-medium text-primary",children:"Select a project to add your selected files"}),a.jsx("div",{className:"flex-1 rounded-lg",children:ne?a.jsx("div",{className:"flex items-center justify-center p-4",children:a.jsx(me,{className:"h-5 w-5 animate-spin"})}):o!=null&&o.length?a.jsxs("div",{className:"flex flex-col gap-4",children:[c&&a.jsx("div",{className:"flex cursor-pointer items-center justify-between rounded-xl border border-indigo-200 bg-gradient-to-r from-indigo-50 to-indigo-100 p-4 hover:bg-indigo-100/50 dark:border-indigo-800 dark:from-indigo-900/20 dark:to-indigo-800/20 dark:hover:bg-indigo-800/30",onClick:()=>{m(!0)},children:a.jsxs("div",{className:"flex items-center gap-3 truncate",children:[a.jsx("div",{className:"rounded-xl bg-gradient-to-br from-indigo-50 to-indigo-100/50 p-2 dark:from-indigo-950/50 dark:to-indigo-900/30",children:a.jsx(Nt,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"})}),a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("span",{className:"text-sm font-medium",children:(xt=o.find(y=>y.id===c.id))==null?void 0:xt.name}),a.jsx("span",{className:"truncate text-xs text-muted-foreground",children:(yt=o.find(y=>y.id===c.id))==null?void 0:yt.description})]})]})}),h?a.jsxs(zn,{className:"rounded-lg border-0",children:[a.jsx(Vn,{placeholder:"Search projects..."}),a.jsx($n,{children:"No projects found."}),a.jsx("div",{className:"h-[240px] overflow-y-auto",children:a.jsx(Gn,{children:o.map(y=>a.jsx(Wn,{className:"group flex cursor-pointer items-center justify-between rounded-lg p-2 hover:bg-neutral-100 dark:hover:bg-neutral-800",onSelect:()=>{on(y)},value:y.id,children:a.jsxs("div",{className:"flex items-center gap-3 truncate",children:[a.jsx("div",{className:"rounded-xl bg-gradient-to-br from-indigo-50 to-indigo-100/50 p-2 dark:from-indigo-950/50 dark:to-indigo-900/30",children:a.jsx(Nt,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"})}),a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("span",{className:"text-sm",children:y.name}),a.jsx("span",{className:"truncate text-xs text-muted-foreground",children:y.description})]})]})},y.id))})})]}):n&&n.length>0&&a.jsxs("div",{className:"mb-4 space-y-2",children:[a.jsx("p",{className:"text-sm font-medium",children:"Selected Files:"}),a.jsx("div",{className:"h-[240px] overflow-y-auto rounded-xl border",children:a.jsx("div",{className:"space-y-1 p-2",children:n.filter(y=>y.selected).map((y,C)=>a.jsx("div",{className:"group flex items-center justify-between rounded-lg p-2",children:a.jsxs("div",{className:"flex items-center gap-3 truncate",children:[a.jsxs("div",{className:"rounded-xl bg-gradient-to-br from-indigo-50 to-indigo-100/50 p-2 dark:from-indigo-950/50 dark:to-indigo-900/30",children:[y.type==="text"&&a.jsx(Tn,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"}),y.type==="image"&&a.jsx(Dn,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"}),y.type==="link"&&a.jsx(Rn,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"}),y.type==="markdown"&&a.jsx(fr,{className:"h-4 w-4 text-indigo-600 dark:text-indigo-400"})]}),a.jsx("span",{className:"truncate text-sm",children:y.type==="link"?et(y.content):y.type==="markdown"?y.name:y.content})]})},C))})})]})]}):a.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No projects found. Create one to save content."})})]}),I&&a.jsx("div",{className:H("mt-4 rounded px-3 py-1.5 text-center text-sm",I.type==="error"?"bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400":"bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400"),children:I.message}),a.jsxs(Hn,{className:"flex justify-between gap-2 border-t pt-4",children:[a.jsx(ie,{className:"flex items-center gap-2",disabled:T||P||(n==null?void 0:n.length)===0,onClick:an,size:"sm",variant:"ghost",children:T?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),"Going back..."]}):a.jsxs(a.Fragment,{children:[a.jsx(er,{className:"h-4 w-4"}),"Back"]})}),a.jsx(ie,{className:"flex items-center gap-2",disabled:!c||P||T||(n==null?void 0:n.length)===0,onClick:gt,size:"sm",variant:"default",children:P?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving to Project..."]}):a.jsxs(a.Fragment,{children:[a.jsx(tr,{className:"h-4 w-4"}),"Save Files"]})})]})]}):a.jsxs(a.Fragment,{children:[Object.keys(R).length===0&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"max-h-[50vh] overflow-y-auto",children:a.jsxs(An,{className:"flex w-full flex-col rounded-md border",onValueChange:re,type:"multiple",value:l,children:[a.jsx(ds,{content:n??[],expandedTexts:g??{},getFileSelectionLimit:()=>ee(N.isFree),isAtLimit:ke(n??[],N.isFree),onContentSelect:$,selectedContent:n??[],setExpandedTexts:x??{},setSelectedContent:s}),a.jsx(cs,{content:n??[],expandedTexts:g??{},getFileSelectionLimit:()=>ee(N.isFree),isAtLimit:ke(n??[],N.isFree),onContentSelect:$,selectedContent:n??[],setExpandedTexts:x??{},setSelectedContent:s}),a.jsx(is,{content:n??[],getFileSelectionLimit:()=>ee(N.isFree),isAtLimit:ke(n??[],N.isFree),onContentSelect:$,selectedContent:n??[],setSelectedContent:s??[]}),a.jsx(ls,{content:n??[],getFileSelectionLimit:()=>ee(N.isFree),isAtLimit:ke(n??[],N.isFree),onContentSelect:$,selectedContent:n??[],setSelectedContent:s??[]})]})}),a.jsx(ie,{className:"w-full",disabled:X||k||P,onClick:je?nn:pt,size:"sm",variant:"outline",children:X?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),je?"Deselecting...":"Selecting..."]}):je?"Deselect All":"Select All"})]}),a.jsxs("div",{className:"text-sm text-muted-foreground",children:["Selected:"," ",L.text>0?`${L.text} text file, `:"",L.markdown>0?`${L.markdown} markdown file, `:"",L.images>0?`${L.images} images, `:"",L.links>0?`${L.links} links `:"","(approx. ",L.approxSize,")"]}),I&&a.jsx("div",{className:H("rounded px-3 py-1.5 text-center text-sm",I.type==="error"?"bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400":"bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400"),children:I.message}),a.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[a.jsx(ie,{className:"w-full",disabled:k||P||X||parseInt(L.approxSize)===0,onClick:gt,variant:"secondary",children:k?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving to Vault..."]}):"Save to Vault"}),a.jsx(ie,{className:"w-full",disabled:k||P||X||parseInt(L.approxSize)===0||L.images>0,onClick:()=>{fe({eventData:{source:window.location.href},eventName:"vault-navigate-to-projects-button",eventType:"Button",feature:"MerlinVault",firedFromFile:"features/vault/components/vaultPopup.tsx"}),w(!0),m(!0)},variant:"secondary",children:P?a.jsxs(a.Fragment,{children:[a.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving to Projects..."]}):"Save to Projects"})]}),L.images>0&&a.jsx("p",{className:"mt-1 text-center text-xs text-muted-foreground",children:" Images cannot be saved to projects."})]})]})]})})}function fs(){const[e,t]=S.useState(null),[r,n]=S.useState(!1),[s,o]=S.useState({x:0,y:0}),[i,c]=S.useState(""),[u,d]=S.useState(!1),[f,l]=S.useState(!1),[p,g]=S.useState(!1),[x,h]=S.useState(!1),[m,v]=S.useState(!1),w=Rt();function I(){const k=window.getSelection();if(!k||k.rangeCount===0)return;const _=k.getRangeAt(0);if(!_)return;const P=_.getBoundingClientRect();P&&o({x:P.left,y:P.bottom+8})}S.useEffect(()=>{if(r)return;async function k(z){const T=window.getSelection(),D=(T==null?void 0:T.toString().trim())||"";if(!D){t(null),n(!1),c("");return}if(await new Promise(N=>setTimeout(N,10)),T&&T.rangeCount>0){const N=T.getRangeAt(0),R=N.getBoundingClientRect(),V=N.cloneContents(),q=document.createElement("div");q.appendChild(V.cloneNode(!0));const ne=Array.from(V.querySelectorAll("a")).map($=>$.href),ve=Pn(q),re=[];ne.length>0?re.push({content:ve,type:"markdown"}):re.push({content:D,selected:!0,type:"text"}),ne.forEach($=>{re.push({content:$,selected:!1,type:"link"})}),Array.from(V.querySelectorAll("img")).map($=>$.src).forEach($=>{re.push({content:$,selected:!1,type:"image"})}),R&&o({x:R.left,y:R.bottom+8}),t(re)}else t(null),n(!1),c("")}function _(z){const{action:T,from:D,payload:N}=z;T===mn.OPEN_MERLIN_VAULT&&D===hn.BACKGROUND_SCRIPT&&(N!=null&&N.content&&(N!=null&&N.type)?(t([{content:N.content,type:N.type}]),n(!0)):N!=null&&N.selectionText&&(t([{content:N.selectionText,type:"text"}]),n(!0)))}function P(z){var T,D;if(((T=z.data)==null?void 0:T.from)==="saveButton"&&((D=z.data)!=null&&D.data)){const{content:N,showPopup:R,type:V,x:q,y:ne}=z.data.data;N&&(t([{content:N,selected:!0,type:V||"text"}]),o(q!==void 0&&ne!==void 0?{x:q,y:ne}:{x:window.innerWidth/2-200,y:window.scrollY+100}),R&&n(!0))}}return document.addEventListener("mouseup",k),window.addEventListener("message",P),window.addEventListener("scroll",I),window.addEventListener("wheel",I),bt.runtime.onMessage.addListener(_),window.addEventListener("message",_),()=>{document.removeEventListener("mouseup",k),window.removeEventListener("message",P),window.removeEventListener("scroll",I),window.removeEventListener("wheel",I),bt.runtime.onMessage.removeListener(_),window.removeEventListener("message",_)}},[r]),S.useEffect(()=>{e||d(!1)},[e]);function j(){e&&e[0]&&(navigator.clipboard.writeText(e[0].content),l(!0),setTimeout(()=>l(!1),2e3))}async function X(){var k,_;try{g(!0),await w.update({vault:{blacklistedDomains:[...(_=(k=w.details)==null?void 0:k.vault)==null?void 0:_.blacklistedDomains,window.location.hostname],isEnabled:!0}}),v(!0)}catch(P){console.error("Error disabling on site:",P)}finally{g(!1)}}async function Y(){var k,_;try{h(!0),await w.update({vault:{blacklistedDomains:[...(_=(k=w.details)==null?void 0:k.vault)==null?void 0:_.blacklistedDomains],isEnabled:!1}}),v(!0)}catch(P){console.error("Error disabling on all sites:",P)}finally{h(!1)}}return m?null:a.jsxs(a.Fragment,{children:[a.jsx(mr,{}),e&&!r&&!((s==null?void 0:s.x)===0||(s==null?void 0:s.y)===0)&&a.jsxs("div",{className:"fixed",style:{left:`${s.x}px`,top:`${s.y}px`,zIndex:999999},children:[a.jsxs("div",{className:"flex items-center gap-3 rounded-full bg-black px-3 py-2 text-white shadow-[0_0_0_1px_rgba(255,255,255,0.1),0_2px_8px_rgba(0,0,0,0.3)] ring-1 ring-white/10",children:[a.jsx(yn,{className:"h-5 w-5"}),a.jsxs("button",{className:"flex items-center gap-1 text-sm text-white hover:opacity-70",onClick:j,children:[f?a.jsx("svg",{className:"h-4 w-4 text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{d:"M5 13l4 4L19 7",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2})}):a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5})}),"Copy"]}),a.jsxs("button",{className:"flex items-center gap-1 text-sm text-white hover:opacity-70",onClick:()=>n(!0),children:[a.jsx(Mn,{className:"h-4 w-4"}),"Save to Vault"]}),a.jsx("button",{className:"flex h-5 w-5 items-center justify-center hover:opacity-70",onClick:()=>{d(!u)},children:a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{d:"M6 18L18 6M6 6l12 12",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2})})})]}),u&&a.jsxs("div",{className:"absolute right-0 top-[calc(100%+1px)] max-w-48 rounded-lg bg-black py-1 shadow-lg ring-1 ring-white/10",children:[a.jsxs("button",{className:"flex w-full items-center justify-between px-4 py-2 text-left text-sm text-white hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-50",disabled:p||x,onClick:X,children:[a.jsx("span",{children:"Disable on this site"}),p&&a.jsx(It,{className:"ml-2 h-4 w-4 animate-spin"})]}),a.jsxs("button",{className:"flex w-full items-center justify-between px-4 py-2 text-left text-sm text-white hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-50",disabled:p||x,onClick:Y,children:[a.jsx("span",{children:"Disable on all sites"}),x&&a.jsx(It,{className:"ml-2 h-4 w-4 animate-spin"})]})]})]}),r&&e&&a.jsx(us,{content:e,onClose:()=>{n(!1),t(null)}})]})}function ms(){var n,s,o,i;const e=Rt(),t=(s=(n=e.details)==null?void 0:n.vault)==null?void 0:s.isEnabled,r=S.useMemo(()=>{var c,u;return(u=(c=e.details)==null?void 0:c.vault)==null?void 0:u.blacklistedDomains.includes(window.location.hostname)},[(i=(o=e.details)==null?void 0:o.vault)==null?void 0:i.blacklistedDomains]);return!t||r?null:a.jsx(pn,{children:a.jsx(gn,{children:a.jsx(xn,{children:a.jsx(fs,{})})})})}async function hs(){if(!(await he.fetchQuery(Fe.MerlinConfig)).saveToMerlin.visible||document.getElementById("merlin-vault"))return;const t=document.createElement("merlin-component");t.id="merlin-vault",t.className="merlin vault";const r=t.attachShadow({mode:"open"}),n=document.createElement("style");n.textContent=`${nr}
        :host(#merlin-vault) {
        }
        .reactAppRoot {
            all: initial;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2147483647;
        }
    `;const s=document.createElement("div");s.id="reactAppRoot",s.className="reactAppRoot",ln.forEach(i=>{s.addEventListener(i,c=>{c.stopPropagation()})}),r.appendChild(n),r.appendChild(s),rr(t),cn(s).render(a.jsx(ms,{}))}hs();
