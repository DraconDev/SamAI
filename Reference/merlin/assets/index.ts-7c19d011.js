import{h as k,e as g,f as L,i as q,j as x,k as Q,l as F,s as m,m as H}from"./webAccess-4d0d2b1d.js";import{F as o,a1 as C,a2 as v,e as c,q as n,a3 as p,Q as M,K as R,B as T,G as y,a4 as B,a5 as S}from"./browserPolyfillWrapper-bb116cae.js";import{T as W,V,L as O,X,Y as b,A as E,Z as D,_ as $}from"./localStorage-70c0cae5.js";import{g as U,c as w,D as J}from"./analytics-910dabef.js";import"./backend-0efbfbef.js";import"./persist-4b6dccac.js";const P=async e=>{try{let t="";return await fetch(e).then(i=>{if(!i.ok)throw new Error("Network response was not ok");return i.text()}).then(i=>{t=i}).catch(i=>console.error(`Fetch Error: ${i}`)),t}catch{return""}};let h=null,I=!1;const G=[];let N=null;function j(e){return e&&typeof e.buster=="string"&&typeof e.timestamp=="number"&&e.clientState&&Array.isArray(e.clientState.queries)&&Array.isArray(e.clientState.mutations)}const Y=(e,t)=>{const i=new Map;return e.forEach(r=>i.set(r.mutationId,r)),t.forEach(r=>i.set(r.mutationId,r)),Array.from(i.values())},z=(e,t)=>{const i=new Map;return e.forEach(r=>i.set(r.queryHash,r)),t.forEach(r=>i.set(r.queryHash,r)),Array.from(i.values())},Z=(e,t)=>{if(!e)return JSON.parse(t);if(!t)return e;const i=JSON.parse(t),r=Math.max(e.timestamp,i.timestamp);let s=i;return r===e.timestamp&&(s=e),{buster:s.buster||e.buster,clientState:{mutations:Y(e.clientState.mutations,s.clientState.mutations),queries:z(e.clientState.queries,s.clientState.queries)},timestamp:r}};function tt(){return C.getItem(v).then(e=>{j(e)?h=e:(console.error("Invalid or empty cache in persistent storage. Starting with an empty cache."),h=null)}).catch(e=>{console.error("Failed to initialize in-memory cache:",e),h=null})}tt();const at=async()=>{if(!I){for(I=!0;G.length>0;){const{newCache:e,sendResponse:t}=G.shift();try{h=Z(h,e),N&&clearTimeout(N),N=setTimeout(async()=>{try{await C.setItem(v,JSON.stringify(h))}catch(i){console.error("Failed to persist query cache:",i)}},1e3),t({status:"success"})}catch(i){console.error("Failed to process query cache update:",i),t({error:i,status:"error"})}}I=!1}};function K(e,t,i,r){var s,A,f,_;if(e==="external"&&(t.action===c.SIGNIN&&(t.payload.closeTab&&i.tab&&i.tab.id&&o.tabs.remove(i.tab.id),k().then(()=>r({status:"success"})).catch(a=>{console.error(a),r({error:a,status:"error"})})),t.action===c.SIGNOUT&&g().then(()=>r({status:"success"})).catch(a=>{console.error(a),r({error:a,status:"error"})})),t.action===c.OPEN_OPTIONS_PAGE&&(o.tabs.create({url:W}),r({status:"success"})),t.action===c.CHAT_WEBPAGE&&(o.tabs.create({url:V}),r({status:"success"})),t.action===c.RQ_REFETCH&&(t.payload.queryOptionKey&&Array.isArray(t.payload.queryOptionKey)?t.payload.queryOptionKey.forEach(a=>n.refetchQueries(p[a])):n.refetchQueries(),r({status:"success"})),t.action===c.RQ_FETCH&&(t.payload.forceFetch?n.fetchQuery({...M[t.payload.queryOptionKey],staleTime:0}).then(a=>r({data:a,status:"success"})).catch(a=>r({error:a,status:"error"})).finally(()=>L({action:t.action,payload:t.payload})):n.fetchQuery(M[t.payload.queryOptionKey]).then(a=>r({data:a,status:"success"})).catch(a=>r({error:a,status:"error"})).finally(()=>L({action:t.action,payload:t.payload}))),t.action===c.RQ_CLEAR&&(n.clear(),r({status:"success"})),t.action===c.RQ_INVALIDATE&&(t.payload.queryOptionKey&&t.payload.queryOptionKey.length>0?t.payload.queryOptionKey.forEach(a=>n.invalidateQueries(p[a])):n.invalidateQueries(),r({status:"success"})),t.action===c.RQ_REMOVE&&(t.payload.queryOptionKey&&t.payload.queryOptionKey.length>0?t.payload.queryOptionKey.forEach(a=>n.removeQueries(p[a])):n.invalidateQueries(),r({status:"success"})),t.action===c.RQ_RESET&&(t.payload.queryOptionKey&&t.payload.queryOptionKey.length>0?t.payload.queryOptionKey.forEach(a=>n.resetQueries(p[a])):n.resetQueries(),r({status:"success"})),t.action===c.RQ_QUERYSTATE_GET){const a=n.getQueryState(p[t.payload.queryOptionKey].queryKey);r({data:a,status:"success"})}return t.action===c.RQ_QUERYDATA_SET&&(n.setQueryData([t.payload.queryKey],t.payload.queryData),r({status:"success"})),t.action===c.RQ_CACHE_GET&&(h?r({data:JSON.stringify(h),status:"success"}):C.getItem(t.payload.key).then(a=>{r({data:JSON.stringify(a),status:"success"})}).catch(a=>r({error:a,status:"error"}))),t.action===c.RQ_CACHE_SET&&(G.push({newCache:t.payload.value,sendResponse:r}),at()),t.action===c.RQ_CACHE_REMOVE&&(h=null,C.removeItem(t.payload.key).then(()=>r({status:"success"})).catch(a=>r({error:a,status:"error"}))),t.action===c.FETCH&&(t.payload?R({...t.payload,adapter:"fetch"}).then(a=>r({data:a,status:"success"})).catch(a=>r({error:a,status:"error"})):r({error:"Args not provided to execute a fetch request",status:"error"})),t.action===c.STORAGE_GET&&o.storage.local.get([t.payload.key]).then(a=>r({data:a[t.payload.key],status:"success"})).catch(a=>r({error:a,status:"error"})),t.action===c.STORAGE_SET&&o.storage.local.set({[t.payload.key]:t.payload.value}).then(()=>r({status:"success"})).catch(a=>r({error:a,status:"error"})),t.action===c.STORAGE_REMOVE&&o.storage.local.remove([t.payload.key]).then(()=>r({status:"success"})).catch(a=>r({error:a,status:"error"})),t.action===c.STORAGE_CLEAR&&o.storage.local.clear().then(()=>r({status:"success"})).catch(a=>r({error:a,status:"error"})),t.action===c.EXTENSION_VERSION&&r({data:{version:o.runtime.getManifest().version},status:"success"}),t.action===c.GET_SHORTCUT&&T.commands.getAll().then(a=>{const u=a.find(l=>l.name==="_execute_action");u&&u.shortcut?r({data:{shortcut:u.shortcut},status:"success"}):r({data:{shortcut:null},status:"success"})}).catch(a=>r({error:a,status:"error"})),t.action===c.TOGGLE_CHAT_GUI&&(i.tab&&i.tab.id&&o.tabs.sendMessage(i.tab.id,{action:c.TOGGLE_CHAT_GUI,payload:{...t.payload}}),r({status:"success"})),t.action===c.REPORT_ANALYTICS&&(q(t.payload),r({status:"success"})),t.action===c.OPEN_NEWTAB&&(T.tabs.create({url:t.payload.url}),r({status:"success"})),t.action===c.GET_SELECTEDTEXT_CONTEXT&&(s=i.tab)!=null&&s.id&&o.tabs.sendMessage((A=i.tab)==null?void 0:A.id,{action:c.GET_SELECTEDTEXT_CONTEXT,from:y.BACKGROUND_SCRIPT}).then(a=>{r(a)}).catch(a=>r(a)),t.action===c.EXTRACT_DOM&&x(t.payload.url).then(a=>r({data:a,status:"success"})).catch(a=>r({error:a,status:"error"})),t.action===c.GET_HTML_FROM_URL&&Q(t.payload.url,t.payload.successfulGet,t.payload.timeout).then(a=>r({data:a,status:"success"})).catch(a=>r({error:a,status:"error"})),t.action===c.WEBPAGE_DETAILS&&(f=i.tab)!=null&&f.id&&o.tabs.sendMessage((_=i.tab)==null?void 0:_.id,{action:c.WEBPAGE_DETAILS,from:y.BACKGROUND_SCRIPT}).then(a=>{r(a)}).catch(a=>r(a)),!0}o.runtime.onMessageExternal.addListener((e,t,i)=>K("external",e,t,i));o.runtime.onMessage.addListener((e,t,i)=>K("internal",e,t,i));F();o.runtime.onInstalled.addListener(async e=>{const t=o.runtime.getManifest().version,i=`extensionVersion=${t}&clientId=${await U()}&sessionId=${await w()}`;if(O.set("extVersion",t),O.set("tglMountPreference",!0),o.runtime.setUninstallURL(`${X}?${i}`),o.contextMenus.removeAll(),B.forEach(r=>{o.contextMenus.create(r)}),e.reason==="install"){m(()=>fetch(`${$}?${i}`)),o.tabs.create({url:b}),O.set("installedAt",Date.now());const r={engagement_time_msec:J,session_id:await w(),timestamp:JSON.stringify(Date.now())};q({client_id:await U(),events:[{name:"ExtensionInstalled",params:r}]})}if(e.reason==="update"){m(()=>fetch(`${D}?${i}`).catch(s=>s));const r=await O.get("tglMountPreference");r!==!0&&r!==!1&&await O.set("tglMountPreference",!0)}H()});o.commands.onCommand.addListener((e,t)=>{t.url&&t.id&&o.tabs.sendMessage(t.id,{action:c.TOGGLE_CHAT_GUI,from:y.BACKGROUND_SCRIPT,payload:{trigger:"hotkey"}}).catch(i=>{console.error("Failed to handle manifest registered shortcut",i),t.url&&(t.url==="about:blank"||t.url.startsWith("chrome://")||t.url.startsWith("chrome-extension://")||t.url.startsWith("edge://")||t.url.startsWith("extension://")||t.url.startsWith("brave://")||t.url.startsWith("arc://")||t.url.startsWith("opera://")||t.url.startsWith("vivaldi://"))&&o.tabs.create({url:"https://getmerlin.in/chat"})})});o.contextMenus.onClicked.addListener((e,t)=>{if(t!=null&&t.id){switch(e.menuItemId){case S.SAVE_IMAGE:o.tabs.sendMessage(t.id,{action:c.OPEN_MERLIN_VAULT,from:y.BACKGROUND_SCRIPT,payload:{content:e.srcUrl,showPopup:!0,type:"image",x:200,y:100}});break;case S.SAVE_LINK:o.tabs.sendMessage(t.id,{action:c.OPEN_MERLIN_VAULT,from:y.BACKGROUND_SCRIPT,payload:{content:e.linkUrl||e.srcUrl,showPopup:!0,type:"link",x:200,y:100}});break;case S.SAVE_TEXT:o.tabs.sendMessage(t.id,{action:c.OPEN_MERLIN_VAULT,from:y.BACKGROUND_SCRIPT,payload:{content:e.selectionText,showPopup:!0,type:"text",x:200,y:100}});break}t&&t.id&&e.menuItemId===S.CONTEXT_BUTTON?o.tabs.sendMessage(t.id,{action:c.TOGGLE_CHAT_GUI,from:y.BACKGROUND_SCRIPT,payload:{context:e.selectionText,trigger:"browser_rightclickmenu",value:!0}}):o.tabs.sendMessage(t.id,{action:c.OPEN_MERLIN_VAULT,from:y.BACKGROUND_SCRIPT,payload:{selectionText:e.selectionText}})}});o.action.onClicked.addListener(e=>{e.url&&(e.url.startsWith("chrome://")||e.url.startsWith("chrome-extension://")||e.url.startsWith("edge://")||e.url.startsWith("extension://")||e.url.startsWith("brave://")||e.url.startsWith("arc://")||e.url.startsWith("opera://")||e.url.startsWith("vivaldi://")?o.tabs.create({url:"https://getmerlin.in/chat"}):e.id&&o.tabs.sendMessage(e.id,{action:c.TOGGLE_CHAT_GUI,from:y.BACKGROUND_SCRIPT,payload:{trigger:"toolbar_icon"}}).catch(t=>{console.error("Failed to send message to content script",t),o.action.setPopup({popup:o.runtime.getURL("/popup.html"),tabId:e.id})}))});o.storage.onChanged.addListener(async(e,t)=>{if(t==="local")for(const i in e){const r=e[i];if(r){const{newValue:s,oldValue:A}=r;if(s&&s!==A&&(s==null?void 0:s.status)==="pending"){const{action:f,id:_,payload:a}=s;let u=null;if(f===E.FETCH_TEXT){let l;try{l=await(await fetch(a.url,a.options)).text()}catch{l=null}u=l}if(f===E.FETCH_JSON){let l;try{l=await(await fetch(a.url,a.options)).json()}catch{l=null}u=l}if(f===E.GET_GOOGLE_COMPLETION)if(!a.query)u=null;else try{u=(await(await fetch(new URL("http://suggestqueries.google.com/complete/search?client=chrome&q="+a.query))).json())[1]}catch{u=null}if(f===E.GET_GOOGLE_COMPLETION_V2)if(!a.query)u=null;else try{u=(await(await fetch("https://www.google.com/complete/search?"+new URLSearchParams({client:"chrome",output:"chrome",q:a.query+" > "}))).json())[1]}catch{u=null}f===E.WEB_ACCESS.GET_HTML_FROM_URL&&(u=await Q(a.url,a.successfulGet,a.timeout)),f===E.GET_PR_DIFF&&(u=await P(a.url)),f===E.GET_PR_PATCH&&(u=await P(a.urlPatch)),f===E.EXTRACT_DOM&&(u=await x(a.url)),T.storage.local.set({[_]:{...s,response:u,status:"fulfilled"}}).then(()=>{T.runtime.lastError&&console.error(T.runtime.lastError)},l=>{T.storage.local.set({[_]:{...s,response:null,status:"fulfilled"}})})}}}});o.runtime.onUpdateAvailable.addListener(()=>{o.tabs.query({}).then(e=>{e.length<3&&(fetch(`${D}?extensionVersion=${o.runtime.getManifest().version}&forceUpdate=true`),o.runtime.reload())})});o.storage.local.get(e=>{for(const t in e)/^getFromBackground-/.test(t)&&o.storage.local.remove(t)});
