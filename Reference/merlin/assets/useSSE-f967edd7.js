import{c as z}from"./createReactComponent-640fc4e6.js";import{r as a,E as K}from"./localStorage-70c0cae5.js";import{C as q,f as G,x as J,P as X,L as Y}from"./motion-6c2f4b83.js";import{b as Z,a as k,u as ee,Q as _,k as te}from"./browserPolyfillWrapper-bb116cae.js";var we=z("chevron-left","IconChevronLeft",[["path",{d:"M15 6l-6 6l6 6",key:"svg-0"}]]),be=z("chevron-right","IconChevronRight",[["path",{d:"M9 6l6 6l-6 6",key:"svg-0"}]]),Se=z("send","IconSend",[["path",{d:"M10 14l11 -11",key:"svg-0"}],["path",{d:"M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5",key:"svg-1"}]]);function V(){const n=a.useRef(!1);return q(()=>(n.current=!0,()=>{n.current=!1}),[]),n}function re(){const n=V(),[r,e]=a.useState(0),t=a.useCallback(()=>{n.current&&e(r+1)},[r]);return[a.useCallback(()=>G.postRender(t),[t]),r]}class ne extends a.Component{getSnapshotBeforeUpdate(r){const e=this.props.childRef.current;if(e&&r.isPresent&&!this.props.isPresent){const t=this.props.sizeRef.current;t.height=e.offsetHeight||0,t.width=e.offsetWidth||0,t.top=e.offsetTop,t.left=e.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function se({children:n,isPresent:r}){const e=a.useId(),t=a.useRef(null),o=a.useRef({width:0,height:0,top:0,left:0});return a.useInsertionEffect(()=>{const{width:f,height:m,top:l,left:d}=o.current;if(r||!t.current||!f||!m)return;t.current.dataset.motionPopId=e;const u=document.createElement("style");return document.head.appendChild(u),u.sheet&&u.sheet.insertRule(`
          [data-motion-pop-id="${e}"] {
            position: absolute !important;
            width: ${f}px !important;
            height: ${m}px !important;
            top: ${l}px !important;
            left: ${d}px !important;
          }
        `),()=>{document.head.removeChild(u)}},[r]),a.createElement(ne,{isPresent:r,childRef:t,sizeRef:o},a.cloneElement(n,{ref:t}))}const j=({children:n,initial:r,isPresent:e,onExitComplete:t,custom:o,presenceAffectsLayout:f,mode:m})=>{const l=J(ae),d=a.useId(),u=a.useMemo(()=>({id:d,initial:r,isPresent:e,custom:o,onExitComplete:c=>{l.set(c,!0);for(const y of l.values())if(!y)return;t&&t()},register:c=>(l.set(c,!1),()=>l.delete(c))}),f?void 0:[e]);return a.useMemo(()=>{l.forEach((c,y)=>l.set(y,!1))},[e]),a.useEffect(()=>{!e&&!l.size&&t&&t()},[e]),m==="popLayout"&&(n=a.createElement(se,{isPresent:e},n)),a.createElement(X.Provider,{value:u},n)};function ae(){return new Map}function oe(n){return a.useEffect(()=>()=>n(),[])}const I=n=>n.key||"";function ce(n,r){n.forEach(e=>{const t=I(e);r.set(t,e)})}function ie(n){const r=[];return a.Children.forEach(n,e=>{a.isValidElement(e)&&r.push(e)}),r}const Me=({children:n,custom:r,initial:e=!0,onExitComplete:t,exitBeforeEnter:o,presenceAffectsLayout:f=!0,mode:m="sync"})=>{const l=a.useContext(Y).forceRender||re()[0],d=V(),u=ie(n);let c=u;const y=a.useRef(new Map).current,T=a.useRef(c),p=a.useRef(new Map).current,v=a.useRef(!0);if(q(()=>{v.current=!1,ce(u,p),T.current=c}),oe(()=>{v.current=!0,p.clear(),y.clear()}),v.current)return a.createElement(a.Fragment,null,c.map(g=>a.createElement(j,{key:I(g),isPresent:!0,initial:e?void 0:!1,presenceAffectsLayout:f,mode:m},g)));c=[...c];const b=T.current.map(I),S=u.map(I),M=b.length;for(let g=0;g<M;g++){const h=b[g];S.indexOf(h)===-1&&!y.has(h)&&y.set(h,void 0)}return m==="wait"&&y.size&&(c=[]),y.forEach((g,h)=>{if(S.indexOf(h)!==-1)return;const C=p.get(h);if(!C)return;const U=b.indexOf(h);let w=g;if(!w){const R=()=>{y.delete(h);const E=Array.from(p.keys()).filter(x=>!S.includes(x));if(E.forEach(x=>p.delete(x)),T.current=u.filter(x=>{const P=I(x);return P===h||E.includes(P)}),!y.size){if(d.current===!1)return;l(),t&&t()}};w=a.createElement(j,{key:I(C),isPresent:!1,onExitComplete:R,custom:r,presenceAffectsLayout:f,mode:m},C),y.set(h,w)}c.splice(U,0,w)}),c=c.map(g=>{const h=g.key;return y.has(h)?g:a.createElement(j,{key:I(g),isPresent:!0,presenceAffectsLayout:f,mode:m},g)}),a.createElement(a.Fragment,null,y.size?c:c.map(g=>a.cloneElement(g)))};async function le(n,r){const e=n.getReader();let t;for(;!(t=await e.read()).done;)r(t.value)}function ue(n){let r,e,t,o=!1;return function(m){r===void 0?(r=m,e=0,t=-1):r=de(r,m);const l=r.length;let d=0;for(;e<l;){o&&(r[e]===10&&(d=++e),o=!1);let u=-1;for(;e<l&&u===-1;++e)switch(r[e]){case 58:t===-1&&(t=e-d);break;case 13:o=!0;case 10:u=e;break}if(u===-1)break;n(r.subarray(d,u),t),d=e,t=-1}d===l?r=void 0:d!==0&&(r=r.subarray(d),e-=d)}}function fe(n,r,e){let t=H();const o=new TextDecoder;return function(m,l){if(m.length===0)e==null||e(t),t=H();else if(l>0){const d=o.decode(m.subarray(0,l)),u=l+(m[l+1]===32?2:1),c=o.decode(m.subarray(u));switch(d){case"data":t.data=t.data?t.data+`
`+c:c;break;case"event":t.event=c;break;case"id":n(t.id=c);break;case"retry":const y=parseInt(c,10);isNaN(y)||r(t.retry=y);break}}}}function de(n,r){const e=new Uint8Array(n.length+r.length);return e.set(n),e.set(r,n.length),e}function H(){return{data:"",event:"",id:"",retry:void 0}}var ye=globalThis&&globalThis.__rest||function(n,r){var e={};for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&r.indexOf(t)<0&&(e[t]=n[t]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,t=Object.getOwnPropertySymbols(n);o<t.length;o++)r.indexOf(t[o])<0&&Object.prototype.propertyIsEnumerable.call(n,t[o])&&(e[t[o]]=n[t[o]]);return e};const N="text/event-stream",me=1e3,B="last-event-id";function ge(n,r){var{signal:e,headers:t,onopen:o,onmessage:f,onclose:m,onerror:l,openWhenHidden:d,fetch:u}=r,c=ye(r,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((y,T)=>{const p=Object.assign({},t);p.accept||(p.accept=N);let v;function b(){v.abort(),document.hidden||U()}d||document.addEventListener("visibilitychange",b);let S=me,M=0;function g(){document.removeEventListener("visibilitychange",b),window.clearTimeout(M),v.abort()}e==null||e.addEventListener("abort",()=>{g(),y()});const h=u??window.fetch,C=o??he;async function U(){var w;v=new AbortController;try{const R=await h(n,Object.assign(Object.assign({},c),{headers:p,signal:v.signal}));await C(R),await le(R.body,ue(fe(E=>{E?p[B]=E:delete p[B]},E=>{S=E},f))),m==null||m(),g(),y()}catch(R){if(!v.signal.aborted)try{const E=(w=l==null?void 0:l(R))!==null&&w!==void 0?w:S;window.clearTimeout(M),M=window.setTimeout(U,E)}catch(E){g(),T(E)}}}U()})}function he(n){const r=n.headers.get("content-type");if(!(r!=null&&r.startsWith(N)))throw new Error(`Expected content-type to be ${N}, Actual: ${r}`)}const Re=1,Te=(n,r,e,t=!1)=>{var h,C,U,w;const[o,f]=a.useState(t?"pending":"idle"),[m,l]=a.useState(null),d=a.useRef(null),u=a.useRef([]),c=a.useRef(0),y=Z(),T=k(),p=(C=(h=T.details)==null?void 0:h.apiKey)!=null&&C.isEnabled?{apiKey:(w=(U=T.details)==null?void 0:U.apiKey)==null?void 0:w.value}:{},v=ee(),b=a.useCallback(async()=>{try{await y.fetchQuery({..._.UserSession,staleTime:0})?g(...u.current):(f("error"),v.signOut())}catch{f("error"),v.signOut()}},[]),S=a.useCallback(()=>{d.current&&(!d.current.signal.aborted&&d.current.abort(),f("idle"),l(null),u.current=[])},[]),M=a.useCallback(()=>{var R;d.current&&(!d.current.signal.aborted&&d.current.abort(),f("idle"),l(null),u.current=[],(R=e.onClose)==null||R.call(e,!0),setTimeout(()=>{y.invalidateQueries(_.UserUsageUAM)},2e3))},[e]),g=a.useCallback(async R=>{var $,D;f("pending"),R&&(u.current=[R]);const E=new AbortController;d.current=E;const x=te(),P=await y.fetchQuery(_.UserSession).catch(i=>null);try{await ge(n,{body:JSON.stringify({...R,...p}),headers:{Authorization:`Bearer ${(P==null?void 0:P.accessToken)??null}`,"Content-Type":"application/json","x-merlin-version":x},method:e.method,onclose:()=>{var i;(i=e.onClose)==null||i.call(e)},onerror:i=>{var s,O;if((i==null?void 0:i.name)==="CUSTOM_ERROR"&&i.retry)if(c.current<Re)c.current+=1,f("retrying"),(s=e.onRetry)==null||s.call(e),b();else{f("error"),v.signOut();try{(O=e.onRetryLimitReached)==null||O.call(e)}catch(L){console.error("Error in onMessage callback passed from component",L)}}throw i},onmessage:i=>{var O,L,F,Q,W;const s=JSON.parse(i.data);if((s==null?void 0:s.status)==="error")throw{name:"CUSTOM_ERROR",retry:!1,...s==null?void 0:s.error};if((s==null?void 0:s.status)==="success"){f("streaming");try{(O=e.onMessage)==null||O.call(e,i)}catch(A){console.error("Error in onMessage callback passed from component",A)}}if((s==null?void 0:s.status)==="system"&&(((L=s==null?void 0:s.data)==null?void 0:L.eventType)==="DONE"&&(f("success"),c.current=0),((F=s==null?void 0:s.data)==null?void 0:F.eventType)==="SYSTEM"&&(s!=null&&s.data.hasOwnProperty("usage")&&y.setQueryData(_.UserUsageUAM.queryKey,(Q=s==null?void 0:s.data)==null?void 0:Q.usage),s!=null&&s.data.hasOwnProperty("questions")||s!=null&&s.data.hasOwnProperty("metadata")||s!=null&&s.data.hasOwnProperty("attachments")||s!=null&&s.data.hasOwnProperty("settings")||s!=null&&s.data.hasOwnProperty("messageType"))))try{(W=e.onMessage)==null||W.call(e,i)}catch(A){console.error("Error in onMessage callback passed from component",A)}},onopen:async i=>{var s;if(i.ok&&i.headers.get("content-type")===N){f("streaming");try{(s=e.onOpen)==null||s.call(e,i)}catch(O){console.error("Error in onOpen callback passed from component",O)}}else{if(i.status===401)throw{name:"CUSTOM_ERROR",retry:!0,...(await i.json()).error};if(i.status===413)throw{message:"Input size too large",name:"CUSTOM_ERROR",retry:!1,type:"INPUT_SIZE_TOO_LARGE"};{const O=await i.json();throw(O==null?void 0:O.status)==="error"?{name:"CUSTOM_ERROR",retry:!1,...O.error}:{message:"Something went wrong. Please try again later.",name:"CUSTOM_ERROR",retry:!1,type:K.UNKNOWN_ERROR}}}},openWhenHidden:!0,signal:E.signal})}catch(i){if((i==null?void 0:i.name)==="CUSTOM_ERROR"){if(i.retry){l(i);return}i.type===K.RATE_LIMITED&&setTimeout(()=>{y.invalidateQueries(_.UserUsageUAM)},100),f("error"),($=e.onError)==null||$.call(e,i)}else f("error"),(D=e.onError)==null||D.call(e,{message:"Something went wrong. Please try again later.",name:"CUSTOM_ERROR",retry:!1,type:K.UNKNOWN_ERROR})}},[M,e,p,b]);return a.useMemo(()=>({[r]:{close:M,error:m,execute:g,loading:o==="pending"||o==="retrying",reset:S,setStatus:f,status:o}}),[r,m,M,g,o,S])};export{Me as A,N as E,Se as I,we as a,be as b,re as c,oe as d,ge as f,Te as u};
