import{g as W,h as k,i as J}from"./VT4ATK36.js";import{g as G,h as X,i as K,j as z,l as H}from"./Y34OKDQ4.js";import{K as L,h as $,z as p}from"./F5AXRJSB.js";import{D as N}from"./3M3IYJ36.js";import{ka as B,n as u}from"./WINLMBYH.js";import{x as F}from"./HKBWT4XT.js";import{Ba as f,J as A,M as b,O as E,W as w,aa as O,ba as D,c as h,ca as x,da as R,ea as U,fa as M,m as S,n as T,o as l,zb as P}from"./NO5PF2KS.js";import{h as I}from"./GAV6HCJA.js";var q=4,C=class i extends J{static{this.databaseName="ConversationDB"}constructor(){super(i.databaseName),this.version(3).stores({conversations:"id,lastMessageId,authorId,name,created_at,updated_at,type,meta.domain",messages:"messageId,conversationId,parentMessageId,created_at,updated_at,type,[conversationId+created_at+messageId],is_deleted",attachments:"id,messageId,created_at,updated_at",conversationLocalStorage:"conversationId"}),this.version(q).stores({conversations:"id,lastMessageId,authorId,name,created_at,updated_at,type,group_id,meta.domain",messages:"messageId,conversationId,parentMessageId,created_at,updated_at,type,[conversationId+created_at+messageId],is_deleted",attachments:"id,messageId,created_at,updated_at",conversationLocalStorage:"conversationId"}),this.conversations=this.table("conversations"),this.messages=this.table("messages"),this.attachments=this.table("attachments"),this.conversationLocalStorage=this.table("conversationLocalStorage")}};var _=class{async getConversationById(e){return e?u.fetch("/conversation/get_conversation",{method:"POST",body:JSON.stringify({id:e})}).then(t=>t.data?.status==="OK"?t.data.data?.[0]:null):null}async getConversationsByIds(e){return u.fetch("/conversation/get_conversations_basic_by_ids",{method:"POST",body:JSON.stringify({ids:e})}).then(t=>t.data?.status==="OK"?t.data.data:[])}async getBasicConversationById(e){return e?u.fetch("/conversation/get_conversations_basic_by_ids",{method:"POST",body:JSON.stringify({ids:[e]})}).then(t=>t.data?.status==="OK"?t.data.data?.[0]:null):null}async getBasicConversationByIds(e){return u.fetch("/conversation/get_conversations_basic_by_ids",{method:"POST",body:JSON.stringify({ids:e})}).then(t=>t.data?.status==="OK"?t.data.data:[])}async getPaginationConversationsWithoutGroupByType(e,t){let{page:a,pageSize:r=20,sortKey:o="created_at",sortOrder:s="desc",isDelete:n=!1}=t;return u.fetchPaginationData("/conversation/get_conversation_list",{method:"POST",body:JSON.stringify({type:e,page:a,page_size:r,sort_key:o,sort:s,isDelete:n})})}async getPaginationConversationsByType(e,t){let{page:a,pageSize:r=20,sortKey:o="created_at",sortOrder:s="desc",isDelete:n=!1,group_id:c}=t;return u.fetchPaginationData("/conversation/get_group_and_conversation_list",{method:"POST",body:JSON.stringify({type:e,page:a,page_size:r,sort_key:o,sort:s,isDelete:n,group_id:c})})}async getPaginationBasicConversationsByType(e,t){let{page:a,pageSize:r=20,sortKey:o="created_at",sortOrder:s="desc",isDelete:n=!1}=t;return u.fetchPaginationData("/conversation/get_conversations_basic",{method:"POST",body:JSON.stringify({type:e,page:a,page_size:r,sort_key:o,sort:s,isDelete:n})})}async getPaginationSearchConversationsByType(e,t){let{keyword:a,page:r,pageSize:o=20,searchTime:s}=t;return u.fetchPaginationData("/conversation/search_conversations",{method:"POST",body:JSON.stringify({type:e,page:r,page_size:o,keyword:a||"",search_time:s||""})})}async getConversationAIProviderAndAIModel(e){let t=await this.getConversationById(e);return t?.meta?.AIProvider&&t?.meta?.AIModel?{AIProvider:t.meta.AIProvider,AIModel:t.meta.AIModel}:null}async getConversationPayWallModel(e){return""}async addOrUpdateConversation(e,t,a){let{isPartialUpdate:r=!0,syncToRemote:o=!0,updateUpdatedAt:s=!0}=a||{};if(!o)return null;let n=null;if(r){let c=await this.getConversationById(e);n=P([c||{},{id:e,...t,created_at:c?.created_at||t.created_at}])}else n=t;if(!n)return null;if(!n.authorId){let c=await p.getUserId();n.authorId=c||""}return s&&(n.updated_at=new Date().toISOString()),u.fetch("/conversation/upsert_conversation",{method:"POST",body:JSON.stringify(n)}).then(c=>c.data?.status==="OK"?n:null)}async softDeleteConversation(e){return(await this.addOrUpdateConversation(e,{isDelete:!0}))?.id===e}async softDeleteConversationByConversationType(e){return await u.fetch("/conversation/delete_conversation_by_type",{method:"POST",body:JSON.stringify({type:e})}).then(a=>a.data?.status==="OK")}async shareConversation(e,t){let a=await u.fetch("/conversation/share_conversation",{method:"POST",body:JSON.stringify({id:e,share_enabled:t})}).then(r=>r.data?.status==="OK"?r.data.data:null);return a?.id?await this.addOrUpdateConversation(e,{share:{enable:a.enabled,id:a.id}}):null}async checkUpdate(){return!1}async createConversationFolder(e,t){return u.fetch("/conversation/create_group",{method:"POST",body:JSON.stringify({group_name:e,group_type:t})})}async updateConversationFolder(e,t){return u.fetch("/conversation/update_group",{method:"POST",body:JSON.stringify({group_id:e,group_name:t})})}async deleteConversationFolder(e){return u.fetch("/conversation/delete_group",{method:"POST",body:JSON.stringify({group_id:e})}).then(t=>t.data?.status==="OK")}},v=class{constructor(e){this.cacheConversationUpdateQueue=new Map;this.cacheConversationUpdateProcessing=new Set;this.remoteSyncDebounceTimers=new Map;this.pendingRemoteSyncConversations=new Set;this.remoteSyncPromises=new Map;this.remoteSyncResolvers=new Map;this.service=e,this.getCacheConversationsStorage=()=>k(C,"conversations")}async getCacheConversationsByType(e){return this.getCacheConversationsStorage().where({type:e}).toArray().then()}async getConversationById(e){return await this.getCacheConversationsStorage().get(e).then()||await this.service.getConversationById(e)}async getConversationsByIds(e){let t=await this.getCacheConversationsStorage().where({id:{$in:e}}).toArray().then();return t.length===e.length?t:this.service.getConversationsByIds(e)}async getBasicConversationById(e){return await this.getCacheConversationsStorage().get(e).then()||await this.service.getBasicConversationById(e)}async getBasicConversationByIds(e){let t=await this.getCacheConversationsStorage().where({id:{$in:e}}).toArray().then();return t.length===e.length?t:this.service.getBasicConversationByIds(e)}async getPaginationConversationsWithoutGroupByType(e,t){return this.service.getPaginationConversationsWithoutGroupByType(e,t)}async getPaginationConversationsByType(e,t){return this.service.getPaginationConversationsByType(e,t)}async getPaginationBasicConversationsByType(e,t){return this.service.getPaginationBasicConversationsByType(e,t)}async getPaginationSearchConversationsByType(e,t){return this.service.getPaginationSearchConversationsByType(e,t)}async addOrUpdateConversation(e,t,a){return new Promise((r,o)=>{this.cacheConversationUpdateQueue.has(e)||this.cacheConversationUpdateQueue.set(e,[]),this.cacheConversationUpdateQueue.get(e).push({updateData:t,options:a,resolve:r,reject:o}),this.processUpdateQueue(e)})}async processUpdateQueue(e){if(!this.cacheConversationUpdateProcessing.has(e)){this.cacheConversationUpdateProcessing.add(e);try{let t=this.cacheConversationUpdateQueue.get(e);if(!t||t.length===0)return;for(;t.length>0;){let a=t.shift();try{let r=await this.performAddOrUpdateConversation(e,a.updateData,a.options);a.resolve(r)}catch(r){a.reject(r)}}}finally{this.cacheConversationUpdateProcessing.delete(e);let t=this.cacheConversationUpdateQueue.get(e);t&&t.length===0&&this.cacheConversationUpdateQueue.delete(e)}}}async performAddOrUpdateConversation(e,t,a){let{syncToRemote:r=!0,isPartialUpdate:o=!0,updateUpdatedAt:s=!0,waitForRemoteSync:n=!1}=a||{},c=null;if(o){let d=await this.getCacheConversationsStorage().get(e).then();c=P([d||{},{id:e,...t,created_at:d?.created_at||t.created_at}])}else c=t;if(!c.authorId){let d=await p.getUserId();c.authorId=d||""}return s&&(c.updated_at=new Date().toISOString()),await this.getCacheConversationsStorage().put(c).then(),c&&c.authorId&&r&&(this.scheduleRemoteSync(e),n&&await this.getRemoteSyncPromise(e)),c}getRemoteSyncPromise(e){let t=this.remoteSyncPromises.get(e);if(!t){let a;t=new Promise(r=>{a=r}),this.remoteSyncPromises.set(e,t),this.remoteSyncResolvers.set(e,a)}return t}scheduleRemoteSync(e){let t=this.remoteSyncDebounceTimers.get(e);t&&clearTimeout(t),this.pendingRemoteSyncConversations.add(e);let a=setTimeout(()=>{this.executeRemoteSync(e)},300);this.remoteSyncDebounceTimers.set(e,a)}async executeRemoteSync(e){try{this.remoteSyncDebounceTimers.delete(e),this.pendingRemoteSyncConversations.delete(e);let t=await this.getCacheConversationsStorage().get(e).then();t&&t.authorId&&await this.service.addOrUpdateConversation(e,t,{syncToRemote:!0,isPartialUpdate:!1,updateUpdatedAt:!1});let a=this.remoteSyncResolvers.get(e);a&&(a(),this.remoteSyncResolvers.delete(e),this.remoteSyncPromises.delete(e))}catch{this.remoteSyncDebounceTimers.delete(e),this.pendingRemoteSyncConversations.delete(e);let a=this.remoteSyncResolvers.get(e);a&&(a(),this.remoteSyncResolvers.delete(e),this.remoteSyncPromises.delete(e))}}clearAllRemoteSyncTimers(){this.remoteSyncDebounceTimers.forEach(e=>{clearTimeout(e)}),this.remoteSyncResolvers.forEach(e=>{e()}),this.remoteSyncDebounceTimers.clear(),this.pendingRemoteSyncConversations.clear(),this.remoteSyncPromises.clear(),this.remoteSyncResolvers.clear()}async softDeleteConversation(e){let t=await this.service.softDeleteConversation(e);return t&&await this.addOrUpdateConversation(e,{isDelete:!0},{syncToRemote:!1,isPartialUpdate:!0,updateUpdatedAt:!0}),t}async softDeleteConversationByConversationType(e){let t=await this.service.softDeleteConversationByConversationType(e);if(t){let a=await p.getUserId(),o=(await this.getCacheConversationsByType(e)).filter(s=>s.authorId===a).map(s=>s.id);await this.getCacheConversationsStorage().bulkDelete(o).then()}return t}async getConversationAIProviderAndAIModel(e){let t=await this.getConversationById(e);return t?.meta?.AIProvider&&t?.meta?.AIModel?{AIProvider:t.meta.AIProvider,AIModel:t.meta.AIModel}:null}async shareConversation(e,t){let a=await this.service.shareConversation(e,t);return a?(await this.getCacheConversationsStorage().put(a).then(),a):null}async getConversationPayWallModel(e){return this.service.getConversationPayWallModel(e)}async checkUpdate(e){let t=await this.getCacheConversationsStorage().get(e).then();if(t?.meta.isUploaded!==!0)return!1;let a=!1,r=!1;if(!t)a=!0;else{let o=await u.fetch("/conversation/get_conversation_last_updated_time",{method:"POST",body:JSON.stringify({id:e})});if(o.data?.status==="OK"&&o.data?.data?.updated_at){let s=new Date(t.updated_at).getTime(),n=new Date(o.data.data.updated_at).getTime();s<n?a=!0:s>n&&(r=!0)}}if(a){let o=await this.service.getConversationById(e);o&&await this.getCacheConversationsStorage().put(o).then()}return t&&r&&await this.service.addOrUpdateConversation(e,t,{syncToRemote:!0,isPartialUpdate:!1,updateUpdatedAt:!1}),a||r}async createConversationFolder(e,t){return this.service.createConversationFolder(e,t)}async updateConversationFolder(e,t){return this.service.updateConversationFolder(e,t)}async deleteConversationFolder(e){try{let a=(await this.getCacheConversationsStorage().where({group_id:e}).filter(W({isDelete:{$ne:!0}})).toArray().then()).filter(o=>o&&o.id).map(o=>o.id),r=await this.service.deleteConversationFolder(e);return r?(await Promise.allSettled(a.map(async o=>this.addOrUpdateConversation(o,{isDelete:!0},{syncToRemote:!1,isPartialUpdate:!0,updateUpdatedAt:!0}))),r):!1}catch{return!1}}};I([$({cacheArgs:!0})],v.prototype,"getConversationById",1);var y=class{static{this.apiChatConversationService=new _}static{this.cachedChatConversationService=new v(new _)}static getService(e=!0){return e?this.cachedChatConversationService:this.apiChatConversationService}};var Y=i=>G.some(e=>e===i)?"reply":X.some(e=>e===i)?"new":K.some(e=>e===i)?"refine":!1;var g=i=>{if(i){let e=Y(i);return e?{promptType:"preset",instantType:e}:B.find(t=>t===i)||z.find(t=>t===i)?{promptType:"preset"}:{promptType:"custom"}}else return{promptType:"freestyle"}},j=(i,e)=>{let t=i,a=e.meta?.MaxAIPromptActionConfig;if(a&&a.parent_prompt_id){let r=a.parent_prompt_id;r==="718dae5a-8c58-47a7-9089-5dc02cedbc3c"&&(t=`[Change tone] ${i}`),r==="4d226b15-9e21-42ba-8af8-57d6fbae5a3d"&&(t=`[Translate to] ${i}`)}return i==="[Summary] Summarize this page"&&(t="Summarize this page"),t},Me=async(i,e)=>{let t=F(i.meta?.analytics||{}),{prompt_id:a,prompt_title:r,path:o}=i?.meta?.MaxAIPromptActionConfig||{promptId:t.promptId,promptName:t.promptName};if(!t.promptType){let{promptType:n}=g(a);t.promptType=n}let s=i.conversationId?await y.getService().getConversationById(i.conversationId):null;return!t.featureName&&s&&(t.featureName=await Z(s,a,o)),!t.platformFeature&&s&&(t.platformFeature=Q({promptId:a,conversation:s,coverPlatformFeature:e})),t.promptId=a,t.promptName=r&&j(r,i),t.sourceType=ee(i),t},Z=async(i,e,t)=>{if(t){let a=H(t);if(["/compose_new","/compose_reply","/refine_draft"].includes(a))return"instant_reply"}if(i){let{promptType:a,instantType:r}=g(e);return a==="preset"&&(r==="refine"||r==="new"||r==="reply")?"instant_reply":i.type==="ContextMenu"||i.meta.isContextMenu?(await L.getAppSettings()).userSettings?.alwaysContinueInSidebar?"sidebar":"context_menu":b()?"immersive_chat":"sidebar"}else return"UNKNOWN"},ee=i=>{let e=a=>{let r=a.maxAIDocumentType,o=`.${f(a.title)}`,s=!1;try{s=a.link===window?.location.href}catch{s=!1}let n="NA";return r==="image"?(n="image_added",n):r==="page_content__pdf"?(n=s?"pdf_current":"pdf_added",n):r==="page_content__youtube"?(n=s?"youtube_current":"youtube_added",n):r==="page_content__email"?(n=s?"email_current":"email_added",n):r==="page_content__webpage"?(n=s?"webpage_current":"webpage_added",n):r==="search_results"?(n="search",n):O.includes(o)?(n="script_added",n):D.includes(o)?(n="config_added",n):x.includes(o)?(n="text_added",n):R.includes(o)?(n="sheet_added",n):U.includes(o)?(n="code_added",n):M.includes(o)?(n="audio_added",n):o==="."?(n="_added",n):`${f(a.title)}_added`};if(i.meta?.messageChatDocuments){let a=i.meta?.messageChatDocuments??[];if(a.length<=0)return"NA";if(a.length===1){let r=a[0];return r.maxAIDocumentType?e(r):"NA"}else if(a.length>1){let r=a.map(s=>e(s));return r.every(s=>s===r[0]&&s!=="NA")?r[0]:"mix"}}let t=i.meta?.contextMenu?.id||i.meta?.MaxAIPromptActionConfig?.prompt_id;if(t){let{instantType:a}=g(t);return a?"email_quote":"text_quote"}return"NA"};var Xe=()=>T?w().name==="Edge"?"edge_extension":"chrome_extension":"web",Q=i=>{try{let e=l?"web":"browser",t=i?.fallbackValue??l?"app":"sidebar";if(i?.coverPlatformFeature){let c=`${e}_${i.coverPlatformFeature}`;return l&&c.includes("web_sidebar")&&(c=c.replace("web_sidebar","web_app")),c}if(i?.promptId){let c=i.promptId,d="",{promptType:m,instantType:V}=g(c);if(m==="preset"&&V)return d="page_ai_reply",`${e}_${d}`}let a=i?.conversation;if(a&&(a.type==="ContextMenu"||a.meta.isContextMenu))return`${e}_context_menu`;let r=i?.targetElement,o=r?.dataset?.shadowRootId??"";if(r){if(r.getAttribute("id")==="maxai-client--ai-message--next-action--use-prompt-action-item")return l?"web_app_related_rewrite":"browser_sidebar_related_rewrite";let c=r.getAttribute("data-platform-feature");if(c){let d=`${e}_${c}`;return l&&d.includes("web_sidebar")&&(d=d.replace("web_sidebar","web_app")),d}}if(r&&!l){let d=N(r)?.host;if(d){let m=d.tagName.toLowerCase();if(o=d.id,m.includes("max-ai")&&m.includes("summary-button"))return`${e}_page_summarize`;if(m.includes("maxai-input-assistant-button"))return`${e}_page_ai_reply`}}if(i?.rootContainerId&&(o=i.rootContainerId),o.includes("Minimize_Container"))return`${e}_quick_access`;if(o.includes("MAXAI_SEARCH_WITH_AI_ROOT_ID"))return`${e}_page_search_with_ai`;if(o.includes("USE_CHAT_GPT_AI_ROOT_Context_Menu")||r?.classList.contains("floating-context-menu-item"))return`${e}_context_menu`;if(o.includes("USE_CHAT_GPT_AI_ROOT")||o.includes("maxai-global-popup-container"))return`${e}_sidebar`;let s=!S,n=window.location.origin??A();if(E())return`${e}_setting`;if(l){let c=window.location.pathname;return(!s||n===h)&&c.includes("/app/")?`${e}_app`:(!s||n===h)&&c.includes("/ai-tools/ai-art")?`${e}_ai_art`:(!s||n===h)&&(c.includes("/ai-tools/")||c.includes("/pdf-tools/")||c.includes("/image-tools/")||c.includes("/file-tools/")||c.includes("/text-tools/"))?`${e}_free_tools`:`${e}_landing`}return t?`${e}_${t}`:"UNKNOWN"}catch{return"UNKNOWN"}};export{C as a,_ as b,v as c,y as d,g as e,Me as f,Z as g,ee as h,Xe as i,Q as j};
