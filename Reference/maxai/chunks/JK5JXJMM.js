import{uc as et}from"./PSTOF4IU.js";import{d as qe,h as Ze,i as Ye}from"./VT4ATK36.js";import{a as xe}from"./X7IGDKSO.js";import{b as ye,h as q}from"./F5AXRJSB.js";import{S as Je,T as Qe,U as he,n as Xe,q as ge,t as Ke}from"./JDSHOLU5.js";import{c as He}from"./QS33EOHT.js";import{M as Ve,e as je,ga as Q,ja as z}from"./3M3IYJ36.js";import{b as H,c as We}from"./DKMNSB2V.js";import{J as b,k as A,n as Ge,p as fe,q as V,ra as K,x as E,y as f}from"./WINLMBYH.js";import{i as X,x as J}from"./HKBWT4XT.js";import{E as Re,F as Be,Ja as ke,K as Le,Pa as ze,c as Ce,ja as B,la as pe,m as le,ma as Ue,n as Se,o as Oe,ta as Ne,v as R,zb as $e}from"./NO5PF2KS.js";import{a as Ct}from"./4B6UFNBQ.js";import{a as Mt}from"./PJ57C2TE.js";import{f as Me,h as $}from"./GAV6HCJA.js";var tt=Me(Mt()),ot=tt.default.runtime.getURL("/assets/pdfjs/pdf.worker.min.mjs");var v=async()=>import("./PJNR2IMZ.js").then(s=>(s.GlobalWorkerOptions.workerSrc=ot||`https://cdn.jsdelivr.net/npm/pdfjs-dist@${s.version}/build/pdf.worker.min.mjs`,s)),D=async()=>import("./DEOXUESF.js"),rt=async()=>import("./T42TOCAL.js"),nt=async()=>import("./U5E3MN7X.js"),at=s=>({cMapUrl:`https://cdn.jsdelivr.net/npm/pdfjs-dist@${s}/cmaps/`,cMapPacked:!0});var Z=class{constructor(e,o={}){this.source=e;this.options=o;this.pdfDoc=null}initPDFDoc(e){let{createDate:o,modifiedDate:t}=this.options;o&&e.setCreationDate(o),t&&e.setModificationDate(t)}async init(){let{PDFDocument:e}=await D();this.pdfDoc=await e.load(this.source,{updateMetadata:!1,password:this.options.password}),this.initPDFDoc(this.pdfDoc)}async cropByPageCount(e){if(this.pdfDoc&&this.pdfDoc.getPageCount()>e){let{PDFDocument:o}=await D(),t=await o.create({});(await t.copyPages(this.pdfDoc,Array.from({length:e},(a,i)=>i))).forEach(a=>t.addPage(a)),this.initPDFDoc(t),this.pdfDoc=t}}async cropByFileSize(e,o){if(!this.pdfDoc)return new Uint8Array([]);let t=e-500*1024,{removeImage:r}=o||{};try{let{PDFRawStream:a,PDFName:i}=await D();if(r){let d=this.pdfDoc.context.enumerateIndirectObjects(),m=[],u=0;for(let l=0;l<d.length;l++){let[,p]=d[l];if(p instanceof a){let{dict:x}=p;x.get(i.of("Subtype"))===i.of("Image")&&(m.push({object:p,contents:p.contents}),p.contents=new Uint8Array)}u+=p.sizeInBytes()}t&&u<t&&m.some(l=>{let p=l.contents;if(u+p.byteLength>t)return!0;l.object.contents=p,u+=p.byteLength})}let n=await this.pdfDoc.save(),c=this.pdfDoc.getPageCount();for(;n.length>t&&c>0;){let d=n.length/c,m=n.length-t,u=Math.max(Math.ceil(m/d),2);await this.cropByPageCount(c-u),c-=u,n=await this.pdfDoc.save()}return n}catch{}return new Uint8Array([])}async save(){return this.pdfDoc?this.pdfDoc.save():new Uint8Array([])}};var P={Grayscale:0,Rgb:2,GrayscaleAlpha:4,RgbAlpha:6},St={[P.Rgb]:3,[P.Grayscale]:1,[P.RgbAlpha]:4,[P.GrayscaleAlpha]:2},Ot=(s,e)=>s>>e&1,it=(s,e)=>{let o=Math.floor(e/8),t=s[s.length-o],r=Math.floor(e%8);return Ot(t,r)},st=async s=>{let{inflate:e}=await rt(),{PDFName:o}=await D(),{PNG:t}=await nt();return new Promise((r,a)=>{try{let i=s.colorSpace===o.of("DeviceGray"),n=e(s.data),c=i?P.Grayscale:P.Rgb,d=1,m=s.width*d,u=s.height*d,l=[P.RgbAlpha,P.GrayscaleAlpha].includes(c),p=new t({width:m,height:u,colorType:c,inputColorType:c,inputHasAlpha:l}),x=St[c];p.data=new Uint8Array(m*u*x);let I=0,g=0;for(;g<p.data.length;)if(c===P.Rgb)p.data[g++]=n[I++],p.data[g++]=n[I++],p.data[g++]=n[I++];else if(c===P.RgbAlpha)p.data[g++]=n[I++],p.data[g++]=n[I++],p.data[g++]=n[I++];else if(c===P.Grayscale){let h=it(n,I++)===0?0:255;p.data[p.data.length-g++]=h}else if(c===P.GrayscaleAlpha){let h=it(n,I++)===0?0:255;p.data[p.data.length-g++]=h}else throw new Error(`Unknown colorType=${c}`);let T=[];p.pack().on("data",h=>T.push(h)).on("end",()=>{let h=new Uint8Array(T.reduce((C,me)=>C+me.length,0)),k=0;T.forEach(C=>{h.set(C,k),k+=C.length}),r(h)}).on("error",h=>a(h))}catch(i){a(i)}})};async function ct(s){try{let{PDFRawStream:e,PDFName:o}=await D(),t=s.context.enumerateIndirectObjects(),r=[],a=i=>i instanceof o?i===o.of("DCTDecode")?"jpeg":"png":i.indexOf(o.of("DCTDecode"))===void 0?"png":"jpeg";for(let i=0;i<t.length;i++){let[n,c]=t[i];if(!(c instanceof e))continue;let{dict:d}=c,m=d.get(o.of("SMask")),u=d.get(o.of("ColorSpace")),l=d.get(o.of("Width")),p=d.get(o.of("Height")),x=d.get(o.of("Name")),I=d.get(o.of("Subtype")),g=d.get(o.of("Filter"));I===o.of("Image")&&r.push({ref:n,sMaskRef:m,colorSpace:u,name:x?x.key:`Object${i+1}`,width:l.numberValue,height:p?.numberValue,pdfObject:c,data:c.contents,type:a(g)})}return r.forEach(i=>{if(i.type==="png"&&i.sMaskRef){let n=r.find(({ref:c})=>c===i.sMaskRef);n&&(n.isAlphaLayer=!0)}}),r}catch{return[]}}var Rt=s=>new Promise((e,o)=>{let t=new FileReader;t.addEventListener("load",()=>{let r=t.result,a=new Uint8Array(r);e(a)}),t.addEventListener("error",()=>{o(new Error("Failed to read file"))}),t.readAsArrayBuffer(s)});function dt({imageDocument:s,quality:e,type:o,transform:t}){return new Promise((r,a)=>{try{let i=document.createElement("canvas"),n=i.getContext("2d");s.addEventListener("load",()=>{if(i.width=s.width,i.height=s.height,n.drawImage(s,0,0,s.width,s.height),t){let c=t(n.getImageData(0,0,i.width,i.height));n.putImageData(c,0,0)}i.toBlob(c=>{if(c){let d=Rt(c);r(d)}else a(new Error("Error reading blob data."))},o,e)}),s.addEventListener("error",()=>{a(new Error("Error loading image."))})}catch{a(new Error("Error loading image."))}})}var Bt=(s,e)=>{let o=s instanceof Blob?s:new Blob([s],{type:e}),t=document.createElement("img");return t.src=URL.createObjectURL(o),t},Lt=(s,e,o)=>{let{PDFName:t,PDFNumber:r}=o;s.dict.delete(t.of("Interpolate")),s.dict.delete(t.of("Intent")),s.dict.set(t.of("Filter"),t.of("DCTDecode")),s.dict.set(t.of("Length"),r.of(e.byteLength)),s.dict.set(t.of("ColorSpace"),t.of("DeviceRGB")),s.contents=e},Y=async(s,e,o)=>{let t=await ct(s),{PDFName:r,PDFNumber:a}=await D();for(let i=0;i<t.length;i++){o?.(i+1,t.length);try{let n=t[i];if(!n.isAlphaLayer){let c=n.type==="png"?await st(n):n.data,d=Bt(c,`image/${n.type}`),m=.8;e==="strong"?m=.01:e==="basic"&&(m=.5);let u=await dt({imageDocument:d,type:"image/jpeg",quality:m});n.type==="png"?Lt(n.pdfObject,u,{PDFName:r,PDFNumber:a}):n.pdfObject.contents=u}}catch{}}};var ee=class{async compress(e,o){let{removeImage:t,maxFileSize:r,maxPageCount:a}=o||{};try{let i=e instanceof File?e.size:e.byteLength,n=e instanceof File?await e.arrayBuffer():e,c=new Z(n,o);return await c.init(),a&&await c.cropByPageCount(a),i&&r&&i<r?c.save():r?c.cropByFileSize(r,{removeImage:t}):c.save()}catch{}return new Uint8Array([])}async compressByLevel(e,o){let{PDFDocument:t}=await D(),r=e instanceof File?await e.arrayBuffer():e,a=await t.load(r,{updateMetadata:!1});return await Y(a,o),a.save()}};var po=new ee;var te=class{async isEncryptedPDF(e){try{let o=await v();if(typeof e=="string"){if(await o.getDocument({url:e}).promise)return!1}else{let t=e.slice(0);if(await o.getDocument({data:t,disableAutoFetch:!0,disableStream:!0}).promise)return!1}}catch(o){if(o.name==="PasswordException")return!0}return!1}async checkPDFPassword(e,o){try{let{PDFDocument:t}=await D();return{pdfDoc:await t.load(e,{password:o}),isValid:!0}}catch{}return{isValid:!1}}async convertToUnencryptedPDF(e){try{let{PDFDocument:o}=await D();return(await o.load(e,{ignoreEncryption:!0})).save()}catch{}return null}async convertToTextPDF(e,o){let{password:t,reserve:r,createDate:a,modifiedDate:i}=o||{},n=o?.maxSize?o.maxSize-1024*1024:0;try{let{PDFDocument:c,PDFRawStream:d,PDFName:m}=await D(),u=await c.load(e,{updateMetadata:!1,password:t});a&&u.setCreationDate(a),i&&u.setModificationDate(i);let l=u.context.enumerateIndirectObjects(),p=[],x=0,I=g=>{let{dict:T}=g,h=T.get(m.of("Subtype"));(h===m.of("Image")||h===m.of("CIDFontType0C"))&&(p.push({object:g,contents:g.contents}),g.contents=new Uint8Array,x+=g.sizeInBytes())};for(let g=0;g<l.length;g++){let[,T]=l[g];if(T instanceof d)I(T);else{let h=T.sizeInBytes();x+=h}}return n&&r&&x<n&&p.some(g=>{let T=g.contents;if(x+T.byteLength>n)return!0;g.object.contents=T,x+=T.byteLength}),u.save()}catch{}return new Uint8Array([])}};var wo=new te;var oe=class{async extractText(e,o){if(!B(e,[".pdf"])&&!e.type.includes("pdf"))return Promise.reject(new Error(`The file format (${"."+e.name.split(".").pop()}) is not supported yet. Try uploading a different file format.`));let t=await v(),{password:r}=o||{},a=at(t.version),i=URL.createObjectURL(e),n=await t.getDocument(r?{url:i,password:r,...a}:{url:i,...a}).promise;return{text:await this.extractTextByPDFDocument(n,o),numPages:n.numPages,pdfDocument:n}}async extractTextByPDFPage(e){try{let o=await e.getTextContent(),t="";return o.items.forEach(r=>{let a=r;t+=a.str,a.hasEOL&&(t+=`
`)}),t}catch{return""}}async extractAllPageTextByPDFDocument(e){return Promise.all(Array.from({length:e.numPages},(o,t)=>(async()=>{let r=await e.getPage(t+1),a=await this.extractTextByPDFPage(r);return{page:r,text:a}})()))}joinPageText(e,o){let{onProgress:t,separator:r=`
`}=o||{},a=e.length,i="";for(let n=0;n<a;n++){n>0&&(i+=r),i+=e[n];let c=(n+1)/a*100;t?.({loaded:n+1,total:a,progress:c})}return i}async extractTextByPDFDocument(e,o){let{onProgress:t,separator:r=`
`}=o||{},a=await this.extractAllPageTextByPDFDocument(e);return this.joinPageText(a.map(i=>i.text),{onProgress:t,separator:r})}};var S=new oe;var mt={chi:"chi_sim",cmn:"chi_sim",zho:"chi_sim",yue:"chi_sim",tzm:"eng"};var re=class{static{this.version="1.0"}async calculateTextAreaRatio(e){let o=e.getViewport({scale:1}),t=await e.getTextContent(),r=0;for(let i of t.items){let n=i,c=Math.abs(n.transform[3]);r+=n.width*c}let a=o.width*o.height;return r/a}async convertPDFPageToCanvas(e,o){let t=CanvasRenderingContext2D.prototype.strokeText,r=CanvasRenderingContext2D.prototype.fillText;o.hideText&&(CanvasRenderingContext2D.prototype.strokeText=function(){},CanvasRenderingContext2D.prototype.fillText=function(){});let a=e.getViewport({scale:o.scale||1,rotation:o.rotation||0}),i=document.createElement("canvas"),n=i.getContext("2d");if(i.width=a.width,i.height=a.height,!n)throw new Error("Failed to get canvas context");return await e.render({canvasContext:n,viewport:a}).promise,o.hideText&&(CanvasRenderingContext2D.prototype.strokeText=t,CanvasRenderingContext2D.prototype.fillText=r),i}async ocrCanvasToUint8Array(e){return e.canvases.map(()=>new Uint8Array)}async insertPageToPdf(e){let{PDFDocument:o}=await D(),{pdfDoc:t,pages:r,progressCallback:a}=e,i=t.getPageCount();a?.(i,0),await Promise.all(r.map(async({value:n,index:c,rotate:d})=>{let m=await o.load(n),u=t.getPage(c),l=m.getPage(0);if(d&&d%360!==0){let I=u.getRotation();u.setRotation(et((I?.angle||0)+d))}let p=u.getWidth()/l.getWidth();l.scale(p,p);let x=await t.embedPage(l);u.drawPage(x),a?.(i,c+1)}))}async ocrCanvasToPdfReturnBlob(e){let o=await this.ocrCanvasToPdfDocument(e);if(!o)return!1;let t=await o.save();return new Blob([t],{type:"application/pdf"})}async ocrCanvasToPdfDocument(e){let{origDoc:o,canvases:t,language:r,progressCallback:a,processesNumber:i}=e,n=i||Math.min(t.length,Math.max(1,Math.floor(navigator.hardwareConcurrency/2)));try{let c=new Date().valueOf(),d=await this.ocrCanvasToUint8Array({canvases:t.map(m=>m.value),language:r,processesNumber:n,progressCallback:(...m)=>a?.(...m,"ocr")});try{await this.insertPageToPdf({pdfDoc:o,pages:d.map((u,l)=>({value:u,index:t[l].index,rotate:t[l].rotate})),progressCallback:(...u)=>a?.(...u,"embedPage")});let m=(new Date().valueOf()-c)/1e3;return o}catch{return!1}}catch{return i?!1:this.ocrCanvasToPdfDocument({...e,processesNumber:2})}}async getCanvasLanguage(e){let o=e.toDataURL(),t=await Ge.fetch("/gpt/cwc/tools/img2lang",{method:"POST",body:JSON.stringify({image_base64:o})}),r=[...new Set(t.data?.data?.map(a=>mt[a]||a).filter(Boolean))];return{...t,data:r}}};var O=class extends re{};var No=new O;var L=s=>Object.values(K).find(e=>B(s,e.extensions))||null,Yo=async(s,e)=>{let{maxCount:o=3,uploadConfig:t}=e||{},r=[],a=[],i=[];return s.forEach(n=>{let c=L(n);if(c){let m={...c,...t?t[c.documentType]:{}}.maxFileSize,u=c.maxFileSize;n.size>m?(i[u]||(i[u]=[]),i[u].push(n)):r.push({file:n,documentType:c.documentType})}else return a.push(n),!1}),a.length&&he.error(b().t("package__features:document__upload_file__unsupported__title",{NAME:a.map(n=>n.name).join(",")}),{autoHideDuration:3e3}),Object.entries(i).forEach(([n,c])=>{he.error(b().t("package__features:document__upload_file__oversize__title",{NAME:c.map(d=>d.name).join(","),MAX_SIZE:V(Number(n),2)}),{autoHideDuration:3e3})}),{supportedFiles:r.slice(0,o),unsupportedFiles:a,oversizeFiles:Object.values(i).flat()}},er=s=>s?L(s)?.documentType||"chat_file":"chat_file",we=s=>{if(s)try{let e=new URL(s).searchParams,o=e.get("X-Amz-Date")||"",t=e.get("X-Amz-Expires");if(!o||!t)return!1;let r=o.substring(0,8),a=o.substring(9,15),i=new Date(Date.UTC(Number(r.substring(0,4)),Number(r.substring(4,6))-1,Number(r.substring(6,8)),Number(a.substring(0,2)),Number(a.substring(2,4)),Number(a.substring(4,6))));if(i&&t&&new Date(new Date(i).getTime()+Number(t)*1e3).getTime()<new Date().getTime())return!0}catch{return!1}return!1};var ir=(s,e)=>{try{return s.doc_type!==e?null:s.doc_type_dependent_data}catch{return null}},sr=s=>Oe&&(ye.pathname==="/share"||ye.pathname==="/share/")?s==="page_content__webpage":!0;var ne=class{async generateFileDocument(e,o){let t=L(e);if(t?.documentType){if(t?.documentType==="audio")return this.generateAudioDocument(e,o);if(t?.documentType==="chat_file_excel")return this.generateExcelDocument(e,o);if(t?.documentType==="chat_file_docx")return this.generateDocxDocument(e,o);if(t?.documentType==="chat_file_pptx")return this.generatePptxDocument(e,o);if(t?.documentType==="chat_file_ebook")return this.generateEbookDocument(e,o);if(t?.documentType==="image")return this.generateImageDocument(e,o);if(t?.documentType==="page_content__pdf")return this.generatePDFDocument(e,o);let{override:r}=o||{},a=r?.doc_id||await f.createDocId(e),i=r?.pure_text||await pe(e),{text:n,tokens:c}=await E(i,f.MAX_TEXT_TOKENS);return{doc_id:a,doc_type:t?.documentType==="chat_file_code"?"chat_file_code":"chat_file",pure_text:n,tokens:c,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}else return Promise.reject(new Error(b().t("package__features:document__upload_file__unsupported__title",{NAME:e.name})))}async generateImageDocument(e,o){let{override:t}=o||{};return{doc_id:t?.doc_id||await f.createDocId(e),doc_type:"image",doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateAudioDocument(e,o){let{override:t}=o||{};return{doc_id:t?.doc_id||await f.createDocId(e),doc_type:"audio",doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generatePDFDocument(e,o){let t=await v(),r=o?.original_doc_id||await f.createDocId(e),a=await e.arrayBuffer(),i=await t.getDocument({data:a,cMapUrl:`https://cdn.jsdelivr.net/npm/pdfjs-dist@${t.version}/cmaps/`,cMapPacked:!0}).promise,n=await S.extractAllPageTextByPDFDocument(i),c=S.joinPageText(n.map(u=>u.text));if(!c.trim())throw new Error("This file is empty. Upload a valid file.");let{text:d,tokens:m}=await E(c,f.MAX_TEXT_TOKENS);return{doc_id:r,doc_type:"page_content__pdf",pure_text:d,tokens:m,file:e,file_mime_type:e.type,file_size:e.size,doc_type_dependent_data:{}}}async generateExcelDocument(e,o){let{override:t}=o||{},r=t?.doc_id||await f.createDocId(e),a=B(e,[".csv"])?t?.pure_text||await pe(e):"",{text:i,tokens:n}=await E(a,f.MAX_TEXT_TOKENS);return{doc_id:r,doc_type:"chat_file_excel",pure_text:i,tokens:n,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateDocxDocument(e,o){let{override:t}=o||{},r=t?.doc_id||await f.createDocId(e),a="",{text:i,tokens:n}=await E(a,f.MAX_TEXT_TOKENS);return{doc_id:r,doc_type:"chat_file_docx",pure_text:i,tokens:n,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generatePptxDocument(e,o){let{override:t}=o||{},r=t?.doc_id||await f.createDocId(e),a="",{text:i,tokens:n}=await E(a,f.MAX_TEXT_TOKENS);return{doc_id:r,doc_type:"chat_file_pptx",pure_text:i,tokens:n,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateEbookDocument(e,o){let{override:t}=o||{},r=t?.doc_id||await f.createDocId(e),a="",{text:i,tokens:n}=await E(a,f.MAX_TEXT_TOKENS);return{doc_id:r,doc_type:"chat_file_ebook",pure_text:i,tokens:n,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateWebpageURLDocument(e,o){return Q.generateDocument(e,o)}async generateSearchResultsDocument(e,o=200){let t=await f.createDocFile("search_results",e),r=await f.createDocId(t);return e.query&&o>0&&e.query.length>o&&(e.query=e.query.slice(0,o)),{doc_id:r,doc_type:"search_results",doc_type_dependent_data:e,file:t}}};var De=Me(Ct()),ut=()=>De.default.createElement("span",null,b().t("package__features:document__upload_pdf__not_supported_ocr"),De.default.createElement("a",{href:`${Ce}/app/`,target:"_blank",rel:"noopener noreferrer",style:{display:"inline-block",margin:"0 -12px 0 14px",padding:"6px",fontWeight:500,textDecoration:"none",color:"#0385FF"}},b().t("package__features:document__upload_pdf__go_to_website")));var ae=class extends ne{async generatePDFDocument(e,o){let{PDFDocument:t}=await D(),r=await v(),a=K.page_content__pdf.maxFileSize,i=800,n="1.0",c=o?.original_doc_id||await f.createDocId(e),d=await e.arrayBuffer(),m=await t.load(d,{updateMetadata:!1}),u=await r.getDocument({data:d,cMapUrl:`https://cdn.jsdelivr.net/npm/pdfjs-dist@${r.version}/cmaps/`,cMapPacked:!0}).promise;if(u.numPages>i)throw new Error(b().t("package__features:document__upload_pdf__limit__title",{MAX_SIZE:"48MB",MAX_PAGES:i}));let l=e.size>a,p=Date.now(),x=await S.extractAllPageTextByPDFDocument(u),I=Date.now(),g="",h=x.flatMap(({page:w,text:_},F)=>(g+=_,_.length<100?{page:w,index:F}:[])).length>0,k=!!o?.shouldPassword;if(l||h||k){let w=await f.fetchDocumentsByOriginalId(c,{docType:"page_content__pdf"});if(w.data)for(let _=w.data.length-1;_>=0;_--){let F=w.data[_];if((!l||F.doc_type_dependent_data.compressVersion===n)&&(!h||F.doc_type_dependent_data.ocrVersion===O.version))return{...F,file:e}}}if(h){let w=`file_not_supported-${Date.now()}`,_=({message:F,options:vt})=>{if(F===w)return Qe(_),{message:ut(),options:vt}};throw Je(_),new Error(w)}if(l){let w="low";(e.size-a)/a<=.4?w="basic":w="strong";let F=Date.now();await Y(m,w),C((await m.save()).length)}if(l||h){let w=await m.save(),_=new Blob([w],{type:e.type});e=new File([_],e.name,{type:e.type,lastModified:e.lastModified}),u=await r.getDocument({data:w,cMapUrl:`https://cdn.jsdelivr.net/npm/pdfjs-dist@${r.version}/cmaps/`,cMapPacked:!0}).promise}C(e.size);function C(w){if(!(w<=a))throw new Error(b().t("package__features:document__upload_file__oversize_after_compression__title",{NAME:e.name,MAX_SIZE:V(Number(a),2)}))}let me=l||h?await S.extractAllPageTextByPDFDocument(u):x,Fe=S.joinPageText(me.map(w=>w.text));if(!Fe.trim())throw new Error("This file is empty. Upload a valid file.");let{text:Et,tokens:Ft}=await E(Fe,f.MAX_TEXT_TOKENS),ve={doc_id:await f.createDocId(e),doc_type:"page_content__pdf",pure_text:Et,tokens:Ft,file:e,file_mime_type:e.type,file_size:e.size,doc_type_dependent_data:{}};if(!l&&!h&&!k)return ve;let ue={};return l&&(ue.compressVersion=n),h&&(ue.ocrVersion=O.version),{...ve,doc_type_dependent_data:ue,meta:{original_doc_id:c}}}};var Ie=new ae;var ie=class{async loadFile(e,o){return Le(e)?this.loadLocalFile(e,o):this.loadRemoteFile(e,o)}async loadLocalFile(e,o){let{fileName:t,onProgress:r,abortSignal:a}=o||{},i=null;try{if(i=await z.createFileStreamer(e),!i||a?.aborted)return null;let n=await i.init();if(t&&(n.name=t),n.name||(n.name="File"),r?.({fileInfo:n,loaded:0,total:n.size,progress:0}),!n||a?.aborted)return null;let c=new Uint8Array([]),d=!1;for(;!d&&!a?.aborted;){let l=await i.getNextChunk();if(!l)break;d=l.done,c=We(c,new Uint8Array(l.value));let p=c.byteLength,x=n.size,I=p/x*100;r?.({fileInfo:n,loaded:p,total:x,progress:I})}if(a?.aborted)return null;let m=new Blob([c],{type:n.type});return new File([m],n.name,{type:n.type,lastModified:n.lastModified})}catch{}finally{i?.destroy()}return null}async loadRemoteFile(e,o){try{let{fileName:t,onProgress:r}=o||{},a=await fetch(e,{method:"GET"}),i=a.headers.get("content-type"),n=a.headers.get("content-length"),c=a.headers.get("last-modified"),d={url:e,name:t||e.split("/").pop()?.split("?")[0]||"",size:n?parseInt(n,10):0,type:i||"application/octet-stream",lastModified:c?new Date(c).getTime():void 0};return await Ne(e,u=>{r?.({fileInfo:d,...u})},d)}catch{return this.loadLocalFile(encodeURIComponent(e),o)}}};var lt=new ie;var Ut=1,se=class s extends Ye{static{this.databaseName="DocumentDB"}constructor(){super(s.databaseName),this.version(Ut).stores({documents:"doc_id,doc_type,link"}),this.documents=this.table("documents")}};var ce=class{constructor(){}getCacheStorage(){return Ze(se,"documents")}async getDocumentById(e,o){let t=o?.expiredTime,r=await this.getCacheStorage().get(e).then();return r&&t&&(r.updated_at?new Date(r.updated_at).getTime():0)+t<Date.now()?null:r}async getDocumentByUrl(e,o){let t=o?.expiredTime,a=(await this.getCacheStorage().where({link:e}).toArray().then().then(i=>Ke(i,"updated_at")))[0];return a&&t&&(a.updated_at?new Date(a.updated_at).getTime():0)+t<Date.now()?null:a}async cacheDocument(e){return e.link&&await this.getCacheStorage().where({link:e.link}).delete().then(),await this.getCacheStorage().put({...e,updated_at:new Date().toISOString(),file:void 0}).then(),e}};var M=new ce;function gt(s,e){let{condition:o,continueOnError:t=!1,onComplete:r,onError:a}=s,i,n;return{onResult:c=>(i=c,o&&o(c)||!o&&c!==null&&c!==void 0?(r&&r(),e({data:i}),!0):!1),onError:c=>(n=c,a&&c instanceof Error&&a(c),t?!1:(e({error:n}),!0)),onComplete:()=>{r&&r(),e({data:i,error:n})}}}function yt(s,e,o){setTimeout(()=>{s.stop(),e.onComplete()},o+100)}async function pt(s,e){return new Promise(o=>{let{interval:t,maxExecutions:r=0,immediate:a=!0,condition:i,signal:n}=e,c=gt(e,o),d=xe(async()=>{try{let m=await s();c.onResult(m)&&d.stop()}catch(m){c.onError(m)&&d.stop()}},{interval:t,maxExecutions:r,immediate:a,continueOnError:!0,onComplete:c.onComplete,signal:n});r===1&&!i&&yt(d,c,t)})}async function ft(s,e){return new Promise(o=>{let{interval:t,maxExecutions:r=0,immediate:a=!0,condition:i,signal:n}=e,c=gt(e,o),d=xe(()=>{try{let m=s();c.onResult(m)&&d.stop()}catch(m){c.onError(m)&&d.stop()}},{interval:t,maxExecutions:r,immediate:a,continueOnError:!0,onComplete:c.onComplete,signal:n});r===1&&!i&&yt(d,c,t)})}async function Nt(s,e,o){try{let t=await s();return e.condition&&e.condition(t)||!e.condition&&t!==null&&t!==void 0?(o({data:t}),{shouldContinue:!1,latestResult:t,latestError:null}):{shouldContinue:!0,latestResult:t,latestError:null}}catch(t){let r=t;return e.onError&&t instanceof Error&&e.onError(t),e.continueOnError?{shouldContinue:!0,latestResult:null,latestError:r}:(o({error:r}),{shouldContinue:!1,latestResult:null,latestError:r})}}function ht(s,e){return new Promise(o=>{let t=s();if(t instanceof Promise)t.then(async a=>{if(e.condition&&e.condition(a)||!e.condition&&a!==null&&a!==void 0){e.onComplete&&e.onComplete(),o({data:a});return}let{shouldContinue:i}=await Nt(()=>Promise.resolve(a),e,o);if(!i)return;let n=e.maxExecutions&&e.maxExecutions>0?e.maxExecutions-1:e.maxExecutions;return pt(()=>s(),{...e,maxExecutions:n,immediate:!0}).then(o)}).catch(a=>{if(e.onError&&a instanceof Error&&e.onError(a),!e.continueOnError){o({error:a});return}pt(()=>s(),e).then(o)});else try{let a=t;if(e.condition&&e.condition(a)||!e.condition&&a!==null&&a!==void 0){e.onComplete&&e.onComplete(),o({data:a});return}let i=e.maxExecutions&&e.maxExecutions>0?e.maxExecutions-1:e.maxExecutions;ft(()=>s(),{...e,maxExecutions:i,immediate:!0}).then(o)}catch(a){if(e.onError&&a instanceof Error&&e.onError(a),!e.continueOnError){o({error:a});return}ft(()=>s(),e).then(o)}})}var xt={alwaysOnTop:!1,focused:!0,width:800,height:600,id:"",incognito:!1,left:0,top:0,type:"normal",ref:null,tabs:[],maxTabs:1,hiddenTabBar:!0},wt={favIconUrl:"",status:"loading",discarded:!1,pinned:!1,groupId:0,lastAccessed:new Date().toISOString(),index:0,active:!0,id:"",windowId:""};var W=class{constructor(e){this.id=e.id||A(),this.windowId=e.windowId,this.active=e.active,this.status=e.status,this.title=e.title,this.index=e.index,this.lastAccessed=e.lastAccessed,this.favIconUrl=e.favIconUrl,this.width=e.width,this.height=e.height,this.openerTabId=e.openerTabId,this.documentId=e.documentId,this.documentType=e.documentType,this.artifact=e.artifact,this.viewerController=e.viewerController,this.viewerProps=e.viewerProps,this.groupId=e.groupId,this.pinned=e.pinned,this.autoDiscardable=e.autoDiscardable,this.audible=e.audible,this.discarded=e.discarded,this.highlighted=e.highlighted,this.incognito=e.incognito,this.mutedInfo=e.mutedInfo,this.pendingUrl=e.pendingUrl,this.url=e.url,this.customRender=e.customRender}};var j=class{constructor(e){this.alwaysOnTop=e.alwaysOnTop,this.focused=e.focused,this.width=e.width,this.height=e.height,this.id=e.id||A(),this.incognito=e.incognito,this.left=e.left,this.top=e.top,this.type=e.type,this.maxTabs=e.maxTabs,this.hiddenTabBar=e.hiddenTabBar,this.ref=e.ref}get tabs(){return y.getAllInWindow(this.id)}};var Te=class extends H{constructor(){super(),this.windows=[]}async create(e){let o={...xt,...e,id:e.id||A()},t=new j(o);return t.focused&&this.windows.forEach(r=>{r.focused=!1}),this.windows=[...this.windows,t],this.emit("onCreated",t),t}async get(e){return this.windows.find(o=>o.id===e)}async getAll(){return this.windows}async getCurrent(){return this.windows.find(e=>e.focused)||null}async remove(e){this.windows=this.windows.filter(t=>t.id!==e),!await this.getCurrent()&&this.windows.length>0&&await this.update(this.windows[0].id,{focused:!0}),this.emit("onDestroyed",e)}async update(e,o){let t=this.windows.find(r=>r.id===e);t&&(this.windows=this.windows.map(r=>r.id===e?$e([r,o]):r),this.emit("onUpdated",t))}},kt=new Te,U=kt;var be=class extends H{constructor(){super(),this.tabs=[]}async captureVisibleTab(){}async create(e){let o={...wt,...e,lastAccessed:new Date().toISOString(),index:0},t=null;o.windowId||(t=await U.getCurrent(),t||(t=await U.create({})),o.windowId=t.id),o.id||(o.id=A()),!o.favIconUrl&&o.url&&Re(o.url)&&(o.favIconUrl=Be(o.url,32));let r=t&&t.tabs.length>=t.maxTabs?[...t.tabs].sort((i,n)=>i.index-n.index)[0]:null;if(r)if(t&&t.tabs.length>1)this.remove(r.id);else{let i={...o};return Object.keys(r).forEach(n=>{typeof i[n]>"u"&&(i[n]=void 0)}),await this.update(r.id,i),r}t&&t.tabs.length>0?(o.active&&t.tabs.forEach(i=>{i.active&&(i.active=!1,this.emit("onActiveChanged",i))}),o.index=t.tabs.length):(o.index=0,o.active=!0);let a=new W(o);return this.tabs.push(a),this.emit("onCreated",a),a}async discard(e){let o=this.tabs.find(t=>t.id===e);o&&(o.discarded=!0,this.emit("onUpdated",{...o,discarded:!0}))}duplicate(e){let o=this.tabs.find(t=>t.id===e);if(o)return this.create({...o,id:A()})}get(e){return this.tabs.find(o=>o.id===e)}getAll(){return this.tabs}getAllInWindow(e){return this.tabs.filter(o=>o.windowId===e)}async getCurrent(){let e=await U.getCurrent();if(e)return this.tabs.find(o=>o.windowId===e.id&&o.active)}async move(e,o){let t=this.tabs.find(a=>a.id===e);if(!t)return;let r=t.windowId;if(o.windowId){let a=o.windowId;t.windowId=o.windowId,this.emit("onDetached",t.id,{oldPosition:t.index,oldWindowId:r}),this.emit("onAttached",t,{newPosition:t.index,newWindowId:a})}t.index=o.index,this.emit("onMoved",t,{fromIndex:t.index,toIndex:o.index})}async query(e){let o=await U.getCurrent();if(!o)return[];let t=e.currentWindow?this.tabs.filter(i=>i.windowId===o.id):this.tabs,{currentWindow:r,...a}=e;return t.filter(i=>Object.keys(a).every(n=>n==="artifactId"?i.artifact?.identifier===e.artifactId:i[n]===e[n]))}async remove(e){let o=this.tabs.findIndex(a=>a.id===e);if(o===-1)return;let t=this.tabs[o].windowId,r=this.tabs[o+1]||this.tabs[o-1];this.tabs=this.tabs.filter(a=>a.id!==e),this.emit("onRemoved",e),r&&await this.update(r.id,{active:!0}),this.tabs.length===0&&t&&await U.remove(t)}async update(e,o){let t=this.tabs.find(r=>r.id===e);t&&(o.active&&this.tabs.forEach(r=>{r.active&&(r.active=!1,this.emit("onActiveChanged",r))}),Object.assign(t,o),this.emit("onUpdated",t))}},zt=new be,y=zt;var Dt=s=>{let e=s.id||A(),o={hideTitleBar:!1,hideToolbar:Se,...s.viewerProps,titleBarProps:{onClose(){y.remove(e)},...s.viewerProps?.titleBarProps}};return{...s,id:e,viewerProps:o}},de=class{async previewDocument(e,o,t){let{waitToLoaded:r=!1,loadTimeout:a=R.SECOND*20}=t||{},i=await y.query({documentId:e}),n=i[0];return n?.id?await y.update(i[0].id,{active:!0}):n=await y.create(Dt({documentId:e,...o})),r&&n.status==="loading"?new Promise(c=>{let d=setTimeout(()=>{c(n),y.removeListener("onUpdated",m),y.removeListener("onRemoved",u)},a),m=l=>{l.id===n.id&&l.status!=="loading"&&(c(l),y.removeListener("onUpdated",m),y.removeListener("onRemoved",u),clearTimeout(d))},u=l=>{l===n.id&&(c(n),n.viewerController=null,y.removeListener("onUpdated",m),y.removeListener("onRemoved",u),clearTimeout(d))};y.addListener("onUpdated",m),y.addListener("onRemoved",u)}):n}async previewWebpage(e,o,t){let{waitToLoaded:r=!1,loadTimeout:a=R.SECOND*20}=t||{},n=(await y.query({url:e}))[0];return n?.id?await y.update(n.id,{active:!0}):n=await y.create(Dt({url:e,...o})),r&&n.status==="loading"?new Promise(c=>{let d=setTimeout(()=>{c(n),y.removeListener("onUpdated",m),y.removeListener("onRemoved",u)},a),m=l=>{l.id===n.id&&l.status!=="loading"&&(c(l),y.removeListener("onUpdated",m),clearTimeout(d))},u=l=>{l===n.id&&(c(n),n.viewerController=null,y.removeListener("onUpdated",m),y.removeListener("onRemoved",u),clearTimeout(d))};y.addListener("onUpdated",m),y.addListener("onRemoved",u)}):n}async pingWebpage(e,o){let t=await z.pingIframePage(e),r=0;for(;t===null&&r<o;)t=await z.pingIframePage(e),o+=1;return t}};var _e=new de;var It=(s,...e)=>{let o=e.reduce((t,r)=>a=>r(t(a)),t=>t);return(...t)=>o(s(...t))};var Gt=s=>{let e=J(s);for(let o=0;o<e.length;o++){let t=e[o];t.speaker||(t.speaker="Speaker"),t._index=o}return e},Pe=It(Gt);var Wt=["emails.content","description","comments.content","transcripts.text","sources.pageContent"],Tt=s=>{let e=o=>o.replace(/(\s{3,}|\t{2,}|\n{2,})/g,t=>t.includes("	")?"		":t.includes(`
`)?`

`:"  ");return s.pure_text&&!["chat_file","chat_file_code"].includes(s.doc_type)&&(s.pure_text=e(s.pure_text)),Wt.forEach(o=>{let t=o.split("."),r=s.doc_type_dependent_data;for(let i=0;i<t.length-1;i++){let n=t[i];if(X(r,n)===void 0)return;r=r[n]}let a=t[t.length-1];typeof r=="string"?s.doc_type_dependent_data[a]=e(r):ze(r)?r.forEach(i=>{X(i,a)&&ge(i,a,e(i[a]))}):ke(r)&&X(r,a)&&ge(r,a,e(r[a]))}),s},bt=s=>{let e=s.doc_type,o=s.doc_type_dependent_data;switch(e){case"audio":{let t=o?.segments;t&&(o.segments=Pe(t));break}default:break}return s},Ae=s=>{let e=s.doc_type,o=s.doc_type_dependent_data;switch(e){case"audio":{let t=o?.segments;t&&(o.segments=Pe(t));break}default:break}return s};var _t=(s,e)=>{try{qe("error_showed",{actions:s,details:e})}catch{}};var Ee=(s={})=>{let{filteredOutKeys:e=["pure_text","file","doc_type_dependent_data"]}=s;return(o,t,r)=>{let a=r.value;return r.value=async function(...i){let n=await a.apply(this,i);if(n.success===!1)try{let c=J(i);c.forEach((d,m)=>{typeof d=="object"&&!Array.isArray(d)&&(c[m]=Xe(d,e))}),_t("add_sources",{errorMessage:n.message??n.reason,inputParams:c,methodName:String(t)})}catch{}return n},r}};var Pt=(s,e)=>{let{code:o}=s,t=b()?.t;if(!t)return null;switch(o){case 20027:return t("package__features:document__error__file_too_large");default:return null}};function At(s){return(e,o,t)=>{let r=t.value;if(typeof e!="object"||e===null)throw new TypeError(`@logMethodCall can only be applied to methods, not: ${typeof e}`);if(typeof o!="string")throw new TypeError(`@logMethodCall can only be applied to methods, not: ${typeof o}`);if(typeof r!="function")throw new TypeError(`@logMethodCall can only be applied to methods, not: ${typeof r}`);return t.value=function(...a){let i=r.apply(this,a);return Promise.resolve(i).then(n=>{}),i},t}}var N=class{async analyzeToDocument(e,o){try{let t=await this.analyzeToDocumentType(e);t==="image"&&typeof window<"u"&&document.contentType==="text/html"&&(t="page_content__webpage");let r=async function(n){let c=new URL(n).pathname.split("/").pop()||"untitled_file";if(je())return await lt.loadLocalFile(n);try{let m=await(await fetch(n)).blob(),u=m.type;return["audio/mp3","audio/mpeg3","audio/x-mpeg-3"].includes(u)&&(u="audio/mpeg"),new File([m],c,{type:u})}catch{return null}},a=async function(n){let c=await f.createDocId(n),d=await M.getDocumentById(c,{expiredTime:le?1:R.DAY,...o});if(d&&d.doc_type===t)return{success:!0,data:{...d,file:n}};let m=await Ie.generateFileDocument(n,o);if(m)return M.cacheDocument(m),{success:!0,data:m}},i=async function(n){let c=await r(n);if(c){let d=await a(c);if(d)return d}else return{success:!1,data:null,reason:fe(1012)}};if(e instanceof File){let n=await a(e);if(n)return n}if(t==="page_content__webpage"||t==="page_content__email"||t==="page_content__youtube"){let n=typeof e=="string"?e:"";if(e instanceof URL&&(n=e.toString()),window.location.href!==n){if("page_content__webpage"===t){let m=await He(n);if(m&&"page_content__webpage"!==m){let u=await i(n);if(u)return u}}let d=await M.getDocumentByUrl(n,{expiredTime:le?1:15*R.MINUTE,...o});if(d)return{success:!0,data:{...d,file:await Q.generateDocumentFile(d.doc_type,d.doc_type_dependent_data||{},{pureText:d.pure_text})}}}let c=await Ie.generateWebpageURLDocument(n,o);if(c)return M.cacheDocument(c),{success:!0,data:c}}if(typeof e=="string")try{if(t==="image"){let n=await i(e);if(n)return n}else if(t==="chat_file"){let n=await Ue(e,"data.txt");return this.analyzeToDocument(n,o)}}catch{}}catch(t){return{success:!1,data:null,reason:t.message||fe(1012)}}return{success:!1,data:null,reason:"unsupported type"}}analyzeToDocumentType(e){if(e instanceof File)return L(e)?.documentType||null;let o=null;if(e instanceof URL&&(o=e),typeof e=="string")try{o=new URL(e)}catch{return"chat_file"}return o?Ve(o.toString()):null}isDocumentExpired(e){return f.isNeedUploadToS3(e.doc_type)?!e.s3?.doc_url||we(e.s3.doc_url):e.s3?.doc_url?we(e.s3.doc_url):!1}async uploadDocument(e,o){let t=await f.uploadDocument(Tt(e),{getCustomErrorMessage:r=>Pt(r,e),...o});if(t.success&&t.data){let r=bt(t.data);await M.cacheDocument(r),t.data=r}return t}async downloadDocument(e,o){let t=await M.getDocumentById(e);if(t&&!this.isDocumentExpired(t)&&!o?.forceUpdate)return{success:!0,data:Ae(t),message:"",error:null,options:{}};let r=await f.fetchDocument(e,o);return r.success&&r.data&&(r.data=Ae(r.data),await M.cacheDocument(r.data)),r}async previewDocument(e,o,t){return _e.previewDocument(e,o,t)}async previewWebpage(e,o,t){return _e.previewWebpage(e,o,t)}async pollingCheckDocumentTask(e,o){let{data:t,error:r}=await ht(async()=>(await f.checkDocumentTask(e,{signal:o?.signal})).data?.status,{interval:1e3,immediate:!0,condition:a=>a==="done",...o});return!(r||t!=="done")}};$([At("gmail"),q({cacheKey:(...e)=>{let[o]=e;return typeof o=="string"?JSON.stringify(e):null}}),Ee()],N.prototype,"analyzeToDocument",1),$([Ee(),q({cacheKey:(...e)=>{let o=e[0];return`${o.doc_id}_${o.doc_type}`}})],N.prototype,"uploadDocument",1),$([q({cacheArgs:!0})],N.prototype,"downloadDocument",1);var za=new N;var Ka=s=>{if(s.includes(":"))return s;let e=Math.round(parseFloat(s)),o=Math.floor(e/3600),t=Math.floor((e-o*3600)/60),r=e-o*3600-t*60,a=o.toString().padStart(2,"0"),i=t.toString().padStart(2,"0"),n=r.toString().padStart(2,"0");return a!=="00"?`${a}:${i}:${n}`:`${i}:${n}`},Ja=s=>{let e=s.split(":").map(o=>parseInt(o));if(e.length===3){let[o,t,r]=e;return o*3600+t*60+r}else if(e.length===2){let[o,t]=e;return o*60+t}return 0},jt=s=>s.toString().padStart(2,"0"),Qa=(s=new Date)=>{let e=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0"),t=String(s.getDate()).padStart(2,"0"),r=String(s.getHours()).padStart(2,"0"),a=String(s.getMinutes()).padStart(2,"0"),i=String(s.getSeconds()).padStart(2,"0");return`${e}${o}${t}${r}${a}${i}`};var qa=s=>{let e=Math.floor(s/60),o=Math.floor(s%60);return`${e}:${jt(o)}`};export{Ka as a,Ja as b,Qa as c,qa as d,ot as e,at as f,Z as g,wo as h,L as i,Yo as j,er as k,we as l,ir as m,sr as n,Ie as o,lt as p,U as q,y as r,_e as s,_t as t,se as u,At as v,za as w};
